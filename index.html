<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>SE2 Silent Disco Tracker</title>
  <script src="https://sandbox.web.squarecdn.com/v1/square.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-firestore-compat.js"></script>
  <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@400;600;700&display=swap" rel="stylesheet">
  <style>
    * { margin: 0; padding: 0; box-sizing: border-box; }
    body {
      font-family: 'Poppins', sans-serif;
      background: #1A1A1A;
      color: #FFFFFF;
      padding: 20px;
      line-height: 1.6;
    }
    .container {
      max-width: 1200px;
      margin: 0 auto;
    }
    header {
      display: flex;
      align-items: center;
      justify-content: center;
      padding: 20px 0;
      background: rgba(107, 72, 255, 0.1);
      border-radius: 10px;
      margin-bottom: 30px;
    }
    header img {
      height: 60px;
      margin-right: 15px;
    }
    header h1 {
      font-size: 28px;
      font-weight: 700;
    }
    .button-group {
      display: flex;
      flex-wrap: wrap;
      justify-content: center;
      gap: 15px;
      margin-bottom: 30px;
    }
    button {
      padding: 12px 24px;
      font-size: 16px;
      font-weight: 600;
      background: #6B48FF;
      color: #FFFFFF;
      border: none;
      border-radius: 8px;
      cursor: pointer;
      transition: background 0.3s ease, transform 0.2s ease;
    }
    button:hover {
      background: #5439CC;
      transform: translateY(-2px);
    }
    button:disabled {
      background: #666666;
      cursor: not-allowed;
      transform: none;
    }
    .form {
      display: none;
      flex-direction: column;
      gap: 20px;
      background: #2A2A2A;
      padding: 25px;
      border-radius: 12px;
      box-shadow: 0 4px 12px rgba(0, 0, 0, 0.3);
    }
    .form h2 {
      font-size: 24px;
      font-weight: 600;
      color: #6B48FF;
    }
    input, textarea, select {
      padding: 10px;
      font-size: 14px;
      background: #EDEDED;
      border: none;
      border-radius: 6px;
      color: #1A1A1A;
      width: 100%;
      max-width: 400px;
    }
    textarea { resize: vertical; height: 150px; }
    #signaturePad {
      border: 2px solid #6B48FF;
      background: #FFFFFF;
      width: 300px;
      height: 150px;
      margin: 10px auto;
      border-radius: 6px;
    }
    #clearSignature { background: #FF4444; }
    #clearSignature:hover { background: #CC3333; }
    #card-container { margin: 10px auto; min-height: 50px; }
    #paymentOptions { display: flex; flex-direction: column; align-items: center; gap: 10px; }
    #paymentOptions p { color: #EDEDED; font-size: 14px; }
    table {
      width: 100%;
      border-collapse: collapse;
      background: #2A2A2A;
      border-radius: 8px;
      overflow: hidden;
    }
    th, td {
      padding: 12px;
      text-align: left;
      font-size: 14px;
      border-bottom: 1px solid #3A3A3A;
    }
    th { background: #6B48FF; font-weight: 600; position: sticky; top: 0; z-index: 10; }
    td { color: #EDEDED; }
    .checkin-btn { background: #28A745; }
    .charge-btn { background: #FFC107; color: #1A1A1A; }
    .delete-btn { background: #808080; }
    .button-group button, .form button { width: auto; min-width: 150px; }
    #headphoneIdsList, #dialogHeadphoneIdsList, #returnHeadphoneIdsList {
      list-style: none;
      padding: 0;
      margin: 10px 0;
      background: #3A3A3A;
      border-radius: 6px;
    }
    #headphoneIdsList li, #dialogHeadphoneIdsList li, #returnHeadphoneIdsList li {
      display: flex;
      justify-content: space-between;
      align-items: center;
      padding: 10px;
      border-bottom: 1px solid #4A4A4A;
    }
    .remove-btn { background: #DC3545; padding: 6px 12px; font-size: 12px; }
    .dialog {
      position: fixed;
      top: 10%;
      left: 50%;
      transform: translateX(-50%);
      background: #2A2A2A;
      padding: 20px;
      border-radius: 12px;
      z-index: 1000;
      display: none;
      flex-direction: column;
      gap: 15px;
      max-width: 90%;
      max-height: 80vh;
      overflow-y: auto;
      box-shadow: 0 6px 16px rgba(0, 0, 0, 0.5);
    }
    .dialog-header {
      background: #6B48FF;
      color: #FFFFFF;
      padding: 10px;
      font-size: 20px;
      font-weight: 600;
      border-radius: 8px 8px 0 0;
      cursor: move;
    }
    .dialog-overlay {
      position: fixed;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      background: rgba(0, 0, 0, 0.7);
      z-index: 999;
      display: none;
    }
    .loading-overlay {
      position: fixed;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      background: rgba(0, 0, 0, 0.5);
      display: none;
      justify-content: center;
      align-items: center;
      z-index: 2000;
    }
    .spinner {
      border: 8px solid #EDEDED;
      border-top: 8px solid #6B48FF;
      border-radius: 50%;
      width: 60px;
      height: 60px;
      animation: spin 1s linear infinite;
    }
    .dashboard-table-wrapper {
      max-height: 400px;
      overflow-y: auto;
      overflow-x: auto;
      width: 100%;
    }
    @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }
    @media (max-width: 768px) {
      header img { height: 40px; }
      header h1 { font-size: 22px; }
      .button-group { flex-direction: column; align-items: center; }
      button { width: 80%; max-width: 300px; }
      .form { padding: 15px; }
      input, textarea, select { width: 100%; }
      table { font-size: 12px; }
      th, td { padding: 8px; }
      .dashboard-table-wrapper { max-height: 300px; }
    }
  </style>
</head>
<body>
  <div class="container">
    <header>
      <img src="https://encrypted-tbn0.gstatic.com/images?q=tbn:ANd9GcSWBhKlwtFnBvx5elx7r_rqfffG3tFbfcg3OA&s" alt="SE2 Silent Disco Logo">
      <h1>SE2 Silent Disco Tracker</h1>
    </header>
    <div class="button-group">
      <button onclick="showCheckout(); vibrate()">Checkout Headphones</button>
      <button onclick="showReturn(); vibrate()">Return Headphones</button>
      <button onclick="showDashboard(); vibrate()">View Dashboard</button>
      <button onclick="showReports(); vibrate()">View Reports</button>
      <button onclick="scanNFCStatus(); vibrate()">Scan NFC Status</button>
    </div>

    <div id="checkout" class="form">
      <h2>Checkout Headphones</h2>
      <button id="scanCheckout" onclick="scanNFC('checkout'); vibrate()">Scan NFC Tag</button>
      <input id="headphoneId" placeholder="Headphone ID (e.g., HP0000001)" readonly onclick="manualEntry('checkout'); vibrate()">
      <button onclick="addHeadphoneId(); vibrate()">Add Headphone ID</button>
      <ul id="headphoneIdsList"></ul>
      <input id="name" placeholder="Full Name">
      <input id="email" placeholder="Email">
      <input id="phone" placeholder="Phone Number">
      <textarea id="agreement" readonly>RENTAL AGREEMENT AND COLLATERAL TERMS

By signing below, I, [Customer Name], agree to rent the following wireless headphones ([Headphone IDs]) from SE2 Silent Disco DBA and SE2 Events Inc. ("the Company") for use during the event on [Date]. I acknowledge that the headphones remain the property of the Company and must be returned in good working condition at the end of the event or upon request.
I understand and agree that failure to return any headphone by the end of the event will result in a replacement fee of $100.00 USD per headphone ("Replacement Fee"). I authorize the Company to charge my credit card, provided below, the Replacement Fee for each headphone not returned or returned damaged beyond normal wear and tear.
LIABILITY RELEASE: I hereby release, waive, discharge, and agree not to sue SE2 Silent Disco DBA and SE2 Events Inc., its officers, employees, agents, or affiliates ("Released Parties") from any and all liability, claims, demands, actions, or causes of action arising out of or related to any loss, damage, or injury, including death, that may be sustained by me or my property while using the headphones or attending the event, whether caused by the negligence of the Released Parties or otherwise. I assume full responsibility for any risk of bodily injury, death, or property damage arising from my use of the headphones and participation in the event.
MARKETING CONSENT: I grant SE2 Silent Disco DBA and SE2 Events Inc. permission to use my email address and phone number provided herein for marketing purposes, including but not limited to sending promotional offers, event updates, and newsletters. I understand I may opt out of these communications at any time by following the unsubscribe instructions provided in such messages.
PHOTO/VIDEO CONSENT: I consent to being photographed or recorded in video or audio by SE2 Silent Disco DBA and SE2 Events Inc. during the event. I grant the Company full permission to use, reproduce, publish, and distribute such photographs, videos, or recordings, including my likeness, voice, or image, for marketing, advertising, or promotional purposes in any medium, without compensation or further notice to me.
This agreement constitutes a legally binding contract. I acknowledge that I have read and understood these terms, and I sign this agreement voluntarily under no duress. Any disputes arising from this agreement shall be governed by the laws of New York, USA.</textarea>
      <div id="paymentOptions">
        <button id="tapToPay" onclick="tapToPayCheckout(); vibrate()">Tap Card to Checkout</button>
        <p>OR</p>
        <div id="card-container"></div>
      </div>
      <canvas id="signaturePad" width="300" height="150"></canvas>
      <button id="clearSignature" onclick="clearSignature(); vibrate()">Clear Signature</button>
      <button id="checkoutButton" onclick="checkout(); vibrate()">Complete Checkout</button>
    </div>

    <div id="return" class="form">
      <h2>Return Headphones</h2>
      <button id="scanReturn" onclick="scanNFC('return'); vibrate()">Scan NFC Tag</button>
      <input id="returnId" placeholder="Headphone ID (e.g., HP0000001)" readonly onclick="showManualReturnDialog('return'); vibrate()">
      <button onclick="addReturnHeadphoneId(); vibrate()">Add Headphone ID</button>
      <ul id="returnHeadphoneIdsList"></ul>
      <button onclick="returnHeadphones(); vibrate()">Return All</button>
    </div>

    <div id="dashboard" class="form">
      <h2>Dashboard</h2>
      <input id="searchInput" type="text" placeholder="Search headphones..." onkeyup="searchHeadphones()">
      <input id="dateFilter" type="date" onchange="filterByDate()">
      <div class="dashboard-table-wrapper">
        <table id="headphoneTable">
          <thead>
            <tr>
              <th>Actions</th>
              <th>Customer</th>
              <th>Status</th>
              <th>Preauth Status</th>
              <th>Email</th>
              <th>Phone</th>
              <th>ID</th>
              <th>NFC ID</th>
              <th>Entry Method</th>
              <th>Group ID</th>
              <th>Delete</th>
            </tr>
          </thead>
          <tbody id="headphoneList"></tbody>
        </table>
      </div>
    </div>

    <div id="reports" class="form">
      <h2>Reports</h2>
      <select id="reportType" onchange="generateReport()">
        <option value="">Select a Report</option>
        <option value="allData">All Data</option>
        <option value="checkedOut">Currently Checked Out Headphones</option>
        <option value="overdue">Overdue Headphones</option>
        <option value="revenue">Revenue Summary</option>
        <option value="customerActivity">Customer Activity</option>
        <option value="groupSummary">Group Checkout Summary</option>
        <option value="nfcUsage">NFC Usage Statistics</option>
      </select>
      <input id="reportStartDate" type="date" onchange="generateReport()" placeholder="Start Date">
      <input id="reportEndDate" type="date" onchange="generateReport()" placeholder="End Date">
      <input id="reportSearch" type="text" placeholder="Search reports..." onkeyup="generateReport()">
      <button onclick="exportReport()">Export as CSV</button>
      <div id="reportOutput"></div>
    </div>

    <div id="nfcStatus" class="form">
      <h2>NFC Status</h2>
      <p id="nfcStatusResult">Scan an NFC tag to see headphone status.</p>
    </div>

    <div id="returnDialog" class="dialog">
      <div id="returnDialogHeader" class="dialog-header">Return Headphones</div>
      <button id="dialogScanReturn" onclick="scanNFC('dialogReturn'); vibrate()">Scan NFC Tag</button>
      <input id="dialogReturnId" placeholder="Headphone ID (e.g., HP0000001)" readonly onclick="showManualReturnDialog('dialogReturn'); vibrate()">
      <button onclick="addDialogReturnHeadphoneId(); vibrate()">Add Headphone ID</button>
      <ul id="dialogReturnHeadphoneIdsList"></ul>
      <button onclick="submitReturnDialog(); vibrate()">Return All</button>
      <button onclick="closeDialog('return'); vibrate()">Cancel</button>
    </div>

    <div id="manualReturnDialog" class="dialog">
      <div id="manualReturnDialogHeader" class="dialog-header">Select Headphones to Return</div>
      <input id="manualReturnSearch" type="text" placeholder="Search headphones..." onkeyup="filterManualReturnList()">
      <table id="manualReturnTable">
        <thead>
          <tr>
            <th>Select</th>
            <th>ID</th>
            <th>Customer</th>
            <th>Group ID</th>
          </tr>
        </thead>
        <tbody id="manualReturnList"></tbody>
      </table>
      <button onclick="submitManualReturn(); vibrate()">Return Selected</button>
      <button onclick="closeDialog('manualReturn'); vibrate()">Cancel</button>
    </div>

    <div id="dialogOverlay" class="dialog-overlay" onclick="closeDialog(null); vibrate()"></div>
    <div id="loadingOverlay" class="loading-overlay">
      <div class="spinner"></div>
    </div>
  </div>

  <script>
    const squareAppId = 'sandbox-sq0idb-qaDoxfFQK3OfUWlaCrgkDw';
    let headphones = {};
    let usedHeadphoneIds = new Set();
    let signatureData = null;
    let payments;
    let cardElement;
    let db;
    let headphonesCollection;
    let squareLocationId;
    let firebaseConfig;

    async function fetchConfig() {
      try {
        const response = await fetch('/.netlify/functions/get-config');
        const config = await response.json();
        squareLocationId = config.squareLocationId;
        firebaseConfig = config.firebaseConfig;
      } catch (error) {
        console.error('Failed to fetch config:', error);
        alert('Failed to load configuration.');
      }
    }

    async function waitForFirebase() {
      return new Promise(resolve => {
        const maxAttempts = 100;
        let attempts = 0;
        const checkFirebase = setInterval(() => {
          if (typeof firebase !== 'undefined' && firebase.app && firebase.firestore || attempts >= maxAttempts) {
            clearInterval(checkFirebase);
            if (firebase.app) {
              firebase.initializeApp(firebaseConfig);
              db = firebase.firestore();
              headphonesCollection = db.collection('headphones');
            }
            resolve();
          }
          attempts++;
        }, 100);
      });
    }

    async function loadHeadphones() {
      if (!db || !headphonesCollection) return headphones;
      try {
        const snapshot = await headphonesCollection.get();
        headphones = {};
        usedHeadphoneIds = new Set();
        snapshot.forEach(doc => {
          headphones[doc.id] = doc.data();
          usedHeadphoneIds.add(doc.id);
        });
        return headphones;
      } catch (error) {
        console.error('Error loading headphones:', error);
        alert('Failed to load data.');
        return headphones;
      }
    }

    async function saveHeadphone(id, data) {
      try {
        if (db && headphonesCollection) await headphonesCollection.doc(id).set(data);
        headphones[id] = data;
        usedHeadphoneIds.add(id);
      } catch (error) {
        console.error('Error saving headphone:', error);
        alert('Failed to save data.');
        throw error;
      }
    }

    async function updateHeadphone(id, data) {
      try {
        if (db && headphonesCollection) await headphonesCollection.doc(id).update(data);
        headphones[id] = { ...headphones[id], ...data };
      } catch (error) {
        console.error('Error updating headphone:', error);
        alert('Failed to update data.');
        throw error;
      }
    }

    async function deleteHeadphone(id) {
      try {
        if (confirm(`Are you sure you want to delete headphone ${id}?`)) {
          if (db && headphonesCollection) await headphonesCollection.doc(id).delete();
          delete headphones[id];
          usedHeadphoneIds.delete(id);
          alert(`Headphone ${id} deleted!`);
          updateDashboard();
        }
      } catch (error) {
        console.error('Error deleting headphone:', error);
        alert('Failed to delete headphone.');
      }
    }

    async function initializeSquare() {
      if (!window.Square) return;
      if (!payments) payments = window.Square.payments(squareAppId);
      const cardContainer = document.getElementById('card-container');
      cardContainer.innerHTML = '';
      cardElement = await payments.card();
      await cardElement.attach('#card-container');
      return cardElement;
    }

    window.onload = async () => {
      try {
        await fetchConfig();
        await waitForFirebase();
        await initializeSquare();
        await loadHeadphones();
        makeDraggable('returnDialog', 'returnDialogHeader');
        makeDraggable('manualReturnDialog', 'manualReturnDialogHeader');
      } catch (error) {
        console.error('Initialization error:', error);
        alert('Failed to start app.');
      }
    };

    function vibrate() {
      if ('vibrate' in navigator) navigator.vibrate(100);
    }

    function showLoading() {
      document.getElementById('loadingOverlay').style.display = 'flex';
      document.getElementById('checkoutButton').disabled = true;
      document.querySelectorAll('.charge-btn').forEach(btn => btn.disabled = true);
    }

    function hideLoading() {
      document.getElementById('loadingOverlay').style.display = 'none';
      document.getElementById('checkoutButton').disabled = false;
      document.querySelectorAll('.charge-btn').forEach(btn => btn.disabled = false);
    }

    function addHeadphoneId() {
      const id = document.getElementById('headphoneId').value.trim();
      if (!id) return alert('Please scan or enter a headphone ID!');
      
      // Check if ID is already in the current checkout list
      const currentIds = getHeadphoneIds('headphoneIdsList');
      if (currentIds.includes(id)) return alert(`Headphone ID ${id} is already in your checkout list!`);
      
      // Check if ID is already checked out or used
      if (usedHeadphoneIds.has(id)) return alert(`Headphone ID ${id} is already used or checked out!`);
      if (headphones[id] && headphones[id].status === 'checked_out') return alert(`Headphone ${id} is already checked out!`);
      
      const list = document.getElementById('headphoneIdsList');
      const li = document.createElement('li');
      li.innerHTML = `${id} <button class="remove-btn" onclick="removeHeadphoneId(this, '${id}')">Remove</button>`;
      list.appendChild(li);
      document.getElementById('headphoneId').value = '';
    }

    function addReturnHeadphoneId() {
      const id = document.getElementById('returnId').value.trim();
      if (!id) return alert('Please scan or enter a headphone ID!');
      if (!headphones[id] || headphones[id].status !== 'checked_out') return alert(`Headphone ${id} is not checked out!`);
      const list = document.getElementById('returnHeadphoneIdsList');
      const existingIds = getReturnHeadphoneIds();
      if (existingIds.includes(id)) return alert(`Headphone ${id} already in return list!`);
      const li = document.createElement('li');
      li.innerHTML = `${id} <button class="remove-btn" onclick="removeHeadphoneId(this, '${id}')">Remove</button>`;
      li.dataset.id = id;
      list.appendChild(li);
      document.getElementById('returnId').value = '';
    }

    function addDialogReturnHeadphoneId() {
      const id = document.getElementById('dialogReturnId').value.trim();
      if (!id) return alert('Please scan or enter a headphone ID!');
      if (!headphones[id] || headphones[id].status !== 'checked_out') return alert(`Headphone ${id} is not checked out!`);
      const list = document.getElementById('dialogReturnHeadphoneIdsList');
      const existingIds = getDialogReturnHeadphoneIds();
      if (existingIds.includes(id)) return alert(`Headphone ${id} already in return list!`);
      const li = document.createElement('li');
      li.innerHTML = `${id} <button class="remove-btn" onclick="removeHeadphoneId(this, '${id}')">Remove</button>`;
      li.dataset.id = id;
      list.appendChild(li);
      document.getElementById('dialogReturnId').value = '';
    }

    function removeHeadphoneId(button, _id) {
      button.parentElement.remove();
    }

    function getHeadphoneIds(listId) {
      return Array.from(document.getElementById(listId).children).map(li => li.textContent.split(' ')[0]);
    }

    function getReturnHeadphoneIds() {
      return Array.from(document.getElementById('returnHeadphoneIdsList').children).map(li => li.dataset.id);
    }

    function getDialogReturnHeadphoneIds() {
      return Array.from(document.getElementById('dialogReturnHeadphoneIdsList').children).map(li => li.dataset.id);
    }

    function generateGroupId() {
      const groupRegex = /^GROUP_\d{7}$/;
      const existingGroups = Object.values(headphones)
        .filter(hp => hp.groupId && groupRegex.test(hp.groupId))
        .map(hp => parseInt(hp.groupId.replace('GROUP_', ''), 10));
      let nextNum = 1;
      if (existingGroups.length) nextNum = Math.max(...existingGroups) + 1;
      return `GROUP_${String(nextNum).padStart(7, '0')}`;
    }

    function generateUniqueHeadphoneId() {
      const regex = /^HP\d{7}$/;
      const existingIds = Array.from(usedHeadphoneIds).filter(id => regex.test(id));
      let nextNum = 1;
      if (existingIds.length) {
        const maxNum = Math.max(...existingIds.map(id => parseInt(id.replace('HP', ''), 10)));
        nextNum = maxNum + 1;
      }
      return `HP${String(nextNum).padStart(7, '0')}`;
    }

    async function showCheckout() {
      toggleForms('checkout');
      initSignaturePad('signaturePad');
      await initializeSquare();
      document.getElementById('headphoneIdsList').innerHTML = '';
    }

    function showReturn() {
      toggleForms('return');
      document.getElementById('returnHeadphoneIdsList').innerHTML = '';
    }

    async function showDashboard() {
      toggleForms('dashboard');
      await loadHeadphones();
      updateDashboard();
    }

    async function showReports() {
      toggleForms('reports');
      await loadHeadphones();
      document.getElementById('reportType').value = '';
      document.getElementById('reportStartDate').value = '';
      document.getElementById('reportEndDate').value = '';
      document.getElementById('reportSearch').value = '';
      document.getElementById('reportOutput').innerHTML = '<p>Select a report type to view details.</p>';
    }

    async function scanNFCStatus() {
      toggleForms('nfcStatus');
      const resultElement = document.getElementById('nfcStatusResult');
      resultElement.textContent = 'Scanning...';
      if (!('NDEFReader' in window)) {
        resultElement.textContent = 'NFC not supported.';
        return;
      }
      const ndef = new NDEFReader();
      try {
        await ndef.scan();
        const controller = new AbortController();
        ndef.onreading = event => {
          const id = event.serialNumber || prompt('Enter headphone ID manually:');
          if (id && headphones[id]) {
            const hp = headphones[id];
            resultElement.innerHTML = `
              <strong>ID:</strong> ${id}<br>
              <strong>NFC ID:</strong> ${hp.nfcId || 'N/A'}<br>
              <strong>Status:</strong> ${hp.status === 'checked_out' ? 'Checked Out' : hp.status === 'returned' ? 'Returned' : 'Charged'}<br>
              <strong>Customer:</strong> ${hp.customer.name}<br>
              <strong>Email:</strong> ${hp.customer.email}<br>
              <strong>Phone:</strong> ${hp.customer.phone}<br>
              <strong>Preauth Status:</strong> ${hp.pre_auth ? 'Hold' : 'Released'}<br>
              <strong>Entry Method:</strong> ${hp.entryMethod || 'N/A'}<br>
              <strong>Date:</strong> ${hp.agreement.date || 'N/A'}<br>
              <strong>Group ID:</strong> ${hp.groupId || 'Single'}
            `;
          } else {
            resultElement.textContent = `Headphone ${id} not found.`;
          }
          controller.abort();
        };
        ndef.onreadingerror = () => {
          resultElement.textContent = 'NFC scan failed. Try again.';
          controller.abort();
        };
        setTimeout(() => {
          controller.abort();
          if (resultElement.textContent === 'Scanning...') resultElement.textContent = 'Scan timed out.';
        }, 5000);
        await new Promise(resolve => controller.signal.addEventListener('abort', resolve));
      } catch (error) {
        resultElement.textContent = `Error: ${error.message}`;
      }
    }

    function toggleForms(active) {
      ['checkout', 'return', 'dashboard', 'nfcStatus', 'reports'].forEach(id => {
        document.getElementById(id).style.display = id === active ? 'flex' : 'none';
      });
      document.getElementById('returnDialog').style.display = 'none';
      document.getElementById('manualReturnDialog').style.display = 'none';
      document.getElementById('dialogOverlay').style.display = 'none';
    }

    async function scanNFC(context) {
      const button = document.getElementById(context === 'checkout' ? 'scanCheckout' : context === 'return' ? 'scanReturn' : 'dialogScanReturn');
      const input = document.getElementById(context === 'checkout' ? 'headphoneId' : context === 'return' ? 'returnId' : 'dialogReturnId');
      const headphoneIdRegex = /^HP\d{7}$/;
      button.disabled = true;

      if (!('NDEFReader' in window)) {
        alert('NFC not supported. Enter ID manually.');
        context === 'checkout' ? manualEntry(context) : showManualReturnDialog(context);
        button.disabled = false;
        return;
      }

      const ndef = new NDEFReader();
      try {
        await ndef.scan();
        const controller = new AbortController();
        ndef.onreading = event => {
          const nfcId = event.serialNumber;
          let id;
          if (context === 'checkout') {
            id = generateUniqueHeadphoneId();
            input.dataset.nfcId = nfcId;
          } else {
            id = prompt('Enter headphone ID for this NFC tag (e.g., HP0000001):');
            if (!id || !headphoneIdRegex.test(id)) {
              alert('Invalid ID format. Use HP followed by 7 digits.');
              controller.abort();
              button.disabled = false;
              return;
            }
          }
          input.value = id;
          input.dataset.entryMethod = 'NFC';
          alert(`Scanned headphone: ${id} with NFC ID: ${nfcId}`);
          controller.abort();
          button.disabled = false;
          if (context === 'return') addReturnHeadphoneId();
          else if (context === 'dialogReturn') addDialogReturnHeadphoneId();
          else addHeadphoneId();
        };
        ndef.onreadingerror = () => {
          alert('No NFC tag detected. Try again or enter manually.');
          context === 'checkout' ? manualEntry(context) : showManualReturnDialog(context);
          controller.abort();
          button.disabled = false;
        };
        setTimeout(() => {
          controller.abort();
          if (!button.disabled) return;
          alert('Scan timed out. Try again or enter manually.');
          context === 'checkout' ? manualEntry(context) : showManualReturnDialog(context);
          button.disabled = false;
        }, 5000);
        await new Promise(resolve => controller.signal.addEventListener('abort', resolve));
      } catch (error) {
        alert(`NFC error: ${error.message}. Enter ID manually.`);
        context === 'checkout' ? manualEntry(context) : showManualReturnDialog(context);
        button.disabled = false;
      }
    }

    function manualEntry(context) {
      const input = document.getElementById(context === 'checkout' ? 'headphoneId' : context === 'return' ? 'returnId' : 'dialogReturnId');
      const button = document.getElementById(context === 'checkout' ? 'scanCheckout' : context === 'return' ? 'scanReturn' : 'dialogScanReturn');
      const regex = /^HP\d{7}$/;
      let id;
      if (context === 'checkout') {
        id = generateUniqueHeadphoneId();
        const userId = prompt(`Enter headphone ID (suggested: ${id}):`, id);
        if (!userId || !regex.test(userId)) {
          alert('Invalid ID format. Use HP followed by 7 digits.');
          button.disabled = false;
          return;
        }
        if (usedHeadphoneIds.has(userId)) {
          alert(`ID ${userId} is already used or checked out!`);
          button.disabled = false;
          return;
        }
        id = userId;
      } else {
        id = prompt('Enter headphone ID (e.g., HP0000001):');
        if (!id || !regex.test(id)) {
          alert('Invalid ID format. Use HP followed by 7 digits.');
          button.disabled = false;
          return;
        }
      }
      input.value = id;
      input.dataset.entryMethod = 'Manual';
      button.disabled = false;
      if (context === 'return') addReturnHeadphoneId();
      else if (context === 'dialogReturn') addDialogReturnHeadphoneId();
      else addHeadphoneId();
    }

    function showManualReturnDialog(context) {
      const dialog = document.getElementById('manualReturnDialog');
      const overlay = document.getElementById('dialogOverlay');
      const list = document.getElementById('manualReturnList');
      const checkedOut = Object.entries(headphones).filter(([_, hp]) => hp.status === 'checked_out');
      dialog.style.display = 'flex';
      overlay.style.display = 'block';
      list.innerHTML = '';
      checkedOut.forEach(([id, hp]) => {
        const row = document.createElement('tr');
        row.innerHTML = `<td><input type="checkbox" name="returnHeadphone" value="${id}"></td><td>${id}</td><td>${hp.customer.name}</td><td>${hp.groupId || 'Single'}</td>`;
        list.appendChild(row);
      });
      document.getElementById('manualReturnSearch').value = '';
      document.getElementById('manualReturnSearch').dataset.context = context;
    }

    function filterManualReturnList() {
      const searchTerm = document.getElementById('manualReturnSearch').value.toLowerCase();
      const rows = document.getElementById('manualReturnList').getElementsByTagName('tr');
      Array.from(rows).forEach(row => {
        row.style.display = row.textContent.toLowerCase().includes(searchTerm) ? '' : 'none';
      });
    }

    async function submitManualReturn() {
      const selected = Array.from(document.getElementById('manualReturnList').querySelectorAll('input[name="returnHeadphone"]:checked')).map(input => input.value);
      const context = document.getElementById('manualReturnSearch').dataset.context;
      if (!selected.length) return alert('Please select at least one headphone!');
      const groupIds = selected.map(id => headphones[id].groupId || 'Single');
      if (new Set(groupIds).size > 1) return alert('All selected headphones must belong to the same group.');
      try {
        for (const id of selected) await updateHeadphone(id, { status: 'returned', pre_auth: null });
        const message = await sendReturnEmail(selected);
        alert(message);
        closeDialog('manualReturn');
        if (context === 'dialogReturn') closeDialog('return');
        else showDashboard();
      } catch (error) {
        alert('Failed to return headphones: ' + error.message);
      }
    }

    function initSignaturePad(canvasId) {
      const canvas = document.getElementById(canvasId);
      const ctx = canvas.getContext('2d');
      let drawing = false;
      ctx.lineWidth = 2;
      ctx.lineCap = 'round';
      ctx.strokeStyle = '#000';

      function startDrawing(e) {
        drawing = true;
        ctx.beginPath();
        const { x, y } = getPosition(e);
        ctx.moveTo(x, y);
        e.preventDefault();
      }

      function draw(e) {
        if (!drawing) return;
        const { x, y } = getPosition(e);
        ctx.lineTo(x, y);
        ctx.stroke();
        e.preventDefault();
      }

      function stopDrawing() {
        if (drawing) {
          drawing = false;
          if (canvasId === 'signaturePad') signatureData = canvas.toDataURL();
        }
      }

      function getPosition(e) {
        const rect = canvas.getBoundingClientRect();
        const touch = e.touches ? e.touches[0] : e;
        return { x: touch.clientX - rect.left, y: touch.clientY - rect.top };
      }

      canvas.addEventListener('mousedown', startDrawing);
      canvas.addEventListener('mousemove', draw);
      canvas.addEventListener('mouseup', stopDrawing);
      canvas.addEventListener('touchstart', startDrawing);
      canvas.addEventListener('touchmove', draw);
      canvas.addEventListener('touchend', stopDrawing);
    }

    function clearSignature() {
      const canvas = document.getElementById('signaturePad');
      const ctx = canvas.getContext('2d');
      ctx.clearRect(0, 0, canvas.width, canvas.height);
      signatureData = null;
    }

    async function tapToPayCheckout() {
      if (!('NDEFReader' in window)) return alert('NFC not supported. Use manual entry.');
      const ndef = new NDEFReader();
      try {
        showLoading();
        await ndef.scan();
        const controller = new AbortController();
        ndef.onreading = async event => {
          const nfcId = event.serialNumber;
          const paymentToken = 'cnon:card-nonce-ok'; // Sandbox test nonce; replace with Square Reader SDK in production
          await processPayment(paymentToken);
          controller.abort();
        };
        ndef.onreadingerror = () => {
          alert('Failed to read payment card. Try again or use manual entry.');
          controller.abort();
          hideLoading();
        };
        setTimeout(() => {
          controller.abort();
          if (!controller.signal.aborted) {
            alert('Payment scan timed out.');
            hideLoading();
          }
        }, 5000);
        await new Promise(resolve => controller.signal.addEventListener('abort', resolve));
      } catch (error) {
        alert(`NFC error: ${error.message}. Use manual entry.`);
        hideLoading();
      }
    }

    async function processPayment(paymentToken) {
      const headphoneIds = getHeadphoneIds('headphoneIdsList');
      const name = document.getElementById('name').value;
      const email = document.getElementById('email').value;
      const phone = document.getElementById('phone').value;
      const date = new Date().toISOString().split('T')[0];
      if (!headphoneIds.length || !name || !email || !phone || !signatureData) {
        hideLoading();
        return alert('Please complete all fields and sign the agreement!');
      }
      const groupId = headphoneIds.length > 1 ? generateGroupId() : null;
      const headphoneIdsText = headphoneIds.join(', ');
      const agreementText = document.getElementById('agreement').value
        .replace('[Customer Name]', name)
        .replace('[Date]', date)
        .replace('[Headphone IDs]', headphoneIdsText);

      try {
        const preauthResponse = await fetch('/.netlify/functions/preauthorize', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({
            sourceId: paymentToken,
            amount: headphoneIds.length * 10000,
            currency: 'USD',
            locationId: squareLocationId
          })
        });
        const preauthResult = await preauthResponse.json();
        if (!preauthResponse.ok) throw new Error(preauthResult.error || 'Preauthorization failed');
        const preauthId = preauthResult.paymentId;

        for (const id of headphoneIds) {
          if (usedHeadphoneIds.has(id)) {
            alert(`Headphone ID ${id} already used! Skipping.`);
            continue;
          }
          const entryMethod = document.getElementById('headphoneId').dataset.entryMethod || 'Manual';
          const nfcId = document.getElementById('headphoneId').dataset.nfcId;
          const headphoneData = {
            status: 'checked_out',
            customer: { name, email, phone },
            agreement: { text: agreementText, signature: signatureData, amount: 100, date, timestamp: Date.now() },
            pre_auth: { pre_auth_id: preauthId, amount: headphoneIds.length * 100 },
            entryMethod,
            nfcId: nfcId || null
          };
          if (groupId) headphoneData.groupId = groupId;
          await saveHeadphone(id, headphoneData);
        }

        const emailResponse = await fetch('/.netlify/functions/send-email', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ name, email, agreement: agreementText, signature: signatureData, preauthId })
        });
        if (!emailResponse.ok) throw new Error('Email failed');
        alert(`Headphones ${headphoneIdsText} checked out! Agreement emailed to ${email}.`);
        clearForm('checkout');
        showDashboard();
      } catch (error) {
        console.error('Payment error:', error.message);
        alert('Payment failed: ' + error.message);
      } finally {
        hideLoading();
      }
    }

    async function checkout() {
      const headphoneIds = getHeadphoneIds('headphoneIdsList');
      const name = document.getElementById('name').value;
      const email = document.getElementById('email').value;
      const phone = document.getElementById('phone').value;
      const date = new Date().toISOString().split('T')[0];
      if (!headphoneIds.length || !name || !email || !phone || !signatureData || !cardElement) {
        return alert('Please complete all fields, enter card details, and sign!');
      }
      showLoading();
      try {
        const result = await cardElement.tokenize();
        if (result.status !== 'OK') throw new Error('Card tokenization failed.');
        await processPayment(result.token);
      } catch (error) {
        console.error('Checkout error:', error.message);
        alert('Checkout failed: ' + error.message);
      } finally {
        hideLoading();
      }
    }

    async function sendReturnEmail(returnedIds) {
      const customer = headphones[returnedIds[0]].customer || { name: 'Customer', email: '' };
      const headphoneList = returnedIds.join(', ');
      const emailBody = `
Dear ${customer.name || 'Customer'},

Thank you for attending our Silent Disco event with SE2 Silent Disco! We hope you had an amazing experience. We're pleased to confirm that we've received the following headphone(s): ${headphoneList}. 

You are no longer responsible for these items, and any associated payment holds have been released. We appreciate your prompt return and hope to see you at future events!

For any questions, contact us at:
- Website: www.se2.events
- Email: se2login@gmail.com

Best regards,
The SE2 Silent Disco Team
      `;
      const emailPayload = { name: customer.name || 'Customer', email: customer.email || '', agreement: emailBody, signature: '', preauthId: '' };
      const emailResponse = await fetch('/.netlify/functions/send-email', {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify(emailPayload)
      });
      if (!emailResponse.ok) {
        const errorText = await emailResponse.text();
        console.error('Failed to send return email:', errorText);
        return `Headphone(s) ${returnedIds.join(', ')} returned, but email failed: ${errorText}`;
      }
      return `Headphone(s) ${returnedIds.join(', ')} returned! Confirmation emailed to ${customer.email || 'customer'}.`;
    }

    async function returnHeadphones() {
      const headphoneIds = getReturnHeadphoneIds();
      if (!headphoneIds.length) return alert('Scan or add at least one headphone!');
      const groupIds = headphoneIds.map(id => headphones[id]?.groupId || 'Single');
      const uniqueGroups = [...new Set(groupIds)];
      if (uniqueGroups.length > 1) {
        const mismatched = headphoneIds.filter(id => headphones[id] && headphones[id].groupId !== uniqueGroups[0] && groupIds.includes(headphones[id].groupId));
        alert(`All headphones must be in the same group. Mismatched: ${mismatched.map(id => `${id} (Group: ${headphones[id].groupId || 'Single'})`).join(', ')}.`);
        const list = document.getElementById('returnHeadphoneIdsList');
        Array.from(list.children).forEach(li => li.style.backgroundColor = mismatched.includes(li.dataset.id) ? '#ffcccc' : '');
        return;
      }
      try {
        let returnedIds = [];
        for (const id of headphoneIds) {
          if (!headphones[id] || headphones[id].status !== 'checked_out') {
            alert(`Headphone ${id} not checked out! Skipping.`);
            continue;
          }
          await updateHeadphone(id, { status: 'returned', pre_auth: null });
          returnedIds.push(id);
        }
        if (returnedIds.length) {
          const message = await sendReturnEmail(returnedIds);
          alert(message);
        } else alert('No headphones returned.');
        clearForm('return');
        showDashboard();
      } catch (error) {
        console.error('Return error:', error.message);
        alert('Failed to return headphones: ' + error.message);
      }
    }

    function showReturnDialog(id) {
      document.getElementById('dialogReturnId').value = id;
      document.getElementById('returnDialog').style.display = 'flex';
      document.getElementById('dialogOverlay').style.display = 'block';
      document.getElementById('dialogReturnHeadphoneIdsList').innerHTML = '';
      if (id) addDialogReturnHeadphoneId();
    }

    function closeDialog(type) {
      if (type === 'return') document.getElementById('returnDialog').style.display = 'none';
      else if (type === 'manualReturn') document.getElementById('manualReturnDialog').style.display = 'none';
      document.getElementById('dialogOverlay').style.display = 'none';
      if (type !== 'manualReturn') showDashboard();
    }

    async function submitReturnDialog() {
      const headphoneIds = getDialogReturnHeadphoneIds();
      if (!headphoneIds.length) return alert('Scan or add at least one headphone!');
      const groupIds = headphoneIds.map(id => headphones[id]?.groupId || 'Single');
      const uniqueGroups = [...new Set(groupIds)];
      if (uniqueGroups.length > 1) {
        const mismatched = headphoneIds.filter(id => headphones[id] && headphones[id].groupId !== uniqueGroups[0] && groupIds.includes(headphones[id].groupId));
        alert(`All headphones must be in the same group. Mismatched: ${mismatched.map(id => `${id} (Group: ${headphones[id].groupId || 'Single'})`).join(', ')}.`);
        const list = document.getElementById('dialogReturnHeadphoneIdsList');
        Array.from(list.children).forEach(li => li.style.backgroundColor = mismatched.includes(li.dataset.id) ? '#ffcccc' : '');
        return;
      }
      try {
        let returnedIds = [];
        for (const id of headphoneIds) {
          if (!headphones[id] || headphones[id].status !== 'checked_out') {
            alert(`Headphone ${id} not checked out! Skipping.`);
            continue;
          }
          await updateHeadphone(id, { status: 'returned', pre_auth: null });
          returnedIds.push(id);
        }
        if (returnedIds.length) {
          const message = await sendReturnEmail(returnedIds);
          alert(message);
        } else alert('No headphones returned.');
        closeDialog('return');
      } catch (error) {
        console.error('Return error:', error.message);
        alert('Failed to return headphones: ' + error.message);
      }
    }

    async function dashboardCharge(id) {
      if (!headphones[id] || headphones[id].status !== 'checked_out' || !headphones[id].pre_auth) {
        return alert(`Cannot charge ${id}: Not checked out or no preauthorization.`);
      }
      const groupId = headphones[id].groupId;
      const headphoneCount = groupId ? Object.values(headphones).filter(hp => hp.groupId === groupId && hp.status === 'checked_out').length : 1;
      const chargeAmount = Math.round(headphones[id].pre_auth.amount * 100 / headphoneCount);
      const chargeAmountDollars = (chargeAmount / 100).toFixed(2);
      if (!confirm(`Charge ${headphones[id].customer.name} $${chargeAmountDollars} for ${id}?`)) return;
      showLoading();
      try {
        const chargeResponse = await fetch('/.netlify/functions/capture-payment', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ paymentId: headphones[id].pre_auth.pre_auth_id, amount: chargeAmount })
        });
        const chargeResult = await chargeResponse.json();
        if (!chargeResponse.ok) throw new Error(chargeResult.error || 'Charge failed');
        await updateHeadphone(id, { status: 'charged', pre_auth: null });
        alert(`Headphone ${id} charged for $${chargeAmountDollars}!`);
        updateDashboard();
      } catch (error) {
        alert(`Charge failed for ${id}: ${error.message}`);
      } finally {
        hideLoading();
      }
    }

    function updateDashboard() {
      const tbody = document.getElementById('headphoneList');
      const searchTerm = document.getElementById('searchInput').value.toLowerCase();
      const dateFilter = document.getElementById('dateFilter').value;
      const now = Date.now();
      const twelveHours = 12 * 60 * 60 * 1000;

      const headphoneArray = Object.entries(headphones).map(([id, hp]) => ({ id, ...hp }));
      const checkedOut = headphoneArray.filter(hp => hp.status === 'checked_out');
      const checkedIn = headphoneArray.filter(hp => hp.status !== 'checked_out');

      checkedOut.sort((a, b) => (a.customer?.name || 'N/A').localeCompare(b.customer?.name || 'N/A'));
      checkedIn.sort((a, b) => (a.customer?.name || 'N/A').localeCompare(b.customer?.name || 'N/A'));

      const sortedArray = [...checkedOut, ...checkedIn];

      tbody.innerHTML = '';
      sortedArray.forEach(hp => {
        const statusText = hp.status === 'checked_out' ? 'Checked Out' : hp.status === 'returned' ? 'Returned' : 'Charged';
        const overdue = hp.status === 'checked_out' && (now - (hp.agreement?.timestamp || now) > twelveHours);
        const rowData = [
          hp.customer?.name || 'N/A',
          statusText,
          hp.pre_auth ? 'Hold' : 'Released',
          hp.customer?.email || 'N/A',
          hp.customer?.phone || 'N/A',
          hp.id,
          hp.nfcId || 'N/A',
          hp.entryMethod || 'N/A',
          hp.agreement?.date || 'N/A',
          hp.groupId || 'Single'
        ];
        if (rowData.some(data => data.toLowerCase().includes(searchTerm)) && (!dateFilter || hp.agreement?.date === dateFilter)) {
          const row = document.createElement('tr');
          let actionsHtml = '';
          if (hp.status === 'checked_out') actionsHtml += `<button class="checkin-btn" onclick="showReturnDialog('${hp.id}')">Check In</button>`;
          if (hp.status === 'checked_out' && hp.pre_auth && overdue) actionsHtml += `<button class="charge-btn" onclick="dashboardCharge('${hp.id}')">Charge</button>`;
          row.innerHTML = `
            <td>${actionsHtml}</td>
            <td>${hp.customer?.name || 'N/A'}</td>
            <td>${statusText}</td>
            <td>${hp.pre_auth ? 'Hold' : 'Released'}</td>
            <td>${hp.customer?.email || 'N/A'}</td>
            <td>${hp.customer?.phone || 'N/A'}</td>
            <td>${hp.id}</td>
            <td>${hp.nfcId || 'N/A'}</td>
            <td>${hp.entryMethod || 'N/A'}</td>
            <td>${hp.groupId || 'Single'}</td>
            <td><button class="delete-btn" onclick="deleteHeadphone('${hp.id}')">Delete</button></td>
          `;
          tbody.appendChild(row);
        }
      });
    }

    function searchHeadphones() { updateDashboard(); }
    function filterByDate() { updateDashboard(); }

    function clearForm(formId) {
      document.getElementById(formId).querySelectorAll('input').forEach(input => {
        input.value = '';
        delete input.dataset.nfcId;
        delete input.dataset.entryMethod;
      });
      if (formId === 'checkout') {
        document.getElementById('card-container').innerHTML = '';
        document.getElementById('headphoneIdsList').innerHTML = '';
        initializeSquare();
      } else if (formId === 'return') document.getElementById('returnHeadphoneIdsList').innerHTML = '';
    }

    function generateReport() {
      const reportType = document.getElementById('reportType').value;
      const startDate = document.getElementById('reportStartDate').value;
      const endDate = document.getElementById('reportEndDate').value || startDate;
      const searchTerm = document.getElementById('reportSearch').value.toLowerCase();
      const output = document.getElementById('reportOutput');
      output.innerHTML = '';
      if (!reportType) {
        output.innerHTML = '<p>Select a report type to view details.</p>';
        return;
      }
      const headphoneArray = Object.entries(headphones).map(([id, hp]) => ({ id, ...hp }));
      const now = Date.now();
      const twelveHours = 12 * 60 * 60 * 1000;
      let filteredArray = headphoneArray;
      if (startDate) {
        const start = new Date(startDate).setHours(0, 0, 0, 0);
        const end = new Date(endDate).setHours(23, 59, 59, 999);
        filteredArray = headphoneArray.filter(hp => {
          const hpDate = new Date(hp.agreement?.date).setHours(0, 0, 0, 0);
          return hpDate >= start && hpDate <= end;
        });
      }
      let finalArray = filteredArray;
      if (searchTerm) {
        finalArray = filteredArray.filter(hp => {
          return [hp.id, hp.nfcId || '', hp.status, hp.customer?.name || '', hp.customer?.email || '', hp.customer?.phone || '', hp.agreement?.date || '', hp.pre_auth ? 'Hold' : 'Released', hp.entryMethod || 'N/A', hp.groupId || 'Single']
            .some(data => data.toLowerCase().includes(searchTerm));
        });
      }
      switch (reportType) {
        case 'allData':
          output.innerHTML = `
            <h3>All Data (${finalArray.length} Headphones)</h3>
            <p>Date Range: ${startDate || 'All'} to ${endDate || 'All'}</p>
            <table>
              <thead><tr><th>ID</th><th>NFC ID</th><th>Status</th><th>Customer</th><th>Email</th><th>Phone</th><th>Checkout Date</th><th>Preauth Status</th><th>Entry Method</th><th>Group ID</th></tr></thead>
              <tbody>${finalArray.map(hp => `<tr><td>${hp.id}</td><td>${hp.nfcId || 'N/A'}</td><td>${hp.status === 'checked_out' ? 'Checked Out' : hp.status === 'returned' ? 'Returned' : 'Charged'}</td><td>${hp.customer?.name || 'N/A'}</td><td>${hp.customer?.email || 'N/A'}</td><td>${hp.customer?.phone || 'N/A'}</td><td>${hp.agreement?.date || 'N/A'}</td><td>${hp.pre_auth ? 'Hold' : 'Released'}</td><td>${hp.entryMethod || 'N/A'}</td><td>${hp.groupId || 'Single'}</td></tr>`).join('')}</tbody>
            </table>
          `;
          break;
        case 'checkedOut':
          const checkedOut = finalArray.filter(hp => hp.status === 'checked_out');
          output.innerHTML = `
            <h3>Currently Checked Out (${checkedOut.length})</h3>
            <p>Date Range: ${startDate || 'All'} to ${endDate || 'All'}</p>
            <table>
              <thead><tr><th>ID</th><th>NFC ID</th><th>Customer</th><th>Email</th><th>Phone</th><th>Checkout Date</th><th>Entry Method</th><th>Group ID</th></tr></thead>
              <tbody>${checkedOut.map(hp => `<tr><td>${hp.id}</td><td>${hp.nfcId || 'N/A'}</td><td>${hp.customer.name}</td><td>${hp.customer.email}</td><td>${hp.customer.phone}</td><td>${hp.agreement.date}</td><td>${hp.entryMethod || 'N/A'}</td><td>${hp.groupId || 'Single'}</td></tr>`).join('')}</tbody>
            </table>
          `;
          break;
        case 'overdue':
          const overdue = finalArray.filter(hp => hp.status === 'checked_out' && (now - hp.agreement.timestamp > twelveHours));
          output.innerHTML = `
            <h3>Overdue Headphones (${overdue.length})</h3>
            <p>Date Range: ${startDate || 'All'} to ${endDate || 'All'}</p>
            <table>
              <thead><tr><th>ID</th><th>NFC ID</th><th>Customer</th><th>Email</th><th>Phone</th><th>Checkout Date</th><th>Days Overdue</th><th>Entry Method</th><th>Group ID</th></tr></thead>
              <tbody>${overdue.map(hp => `<tr><td>${hp.id}</td><td>${hp.nfcId || 'N/A'}</td><td>${hp.customer.name}</td><td>${hp.customer.email}</td><td>${hp.customer.phone}</td><td>${hp.agreement.date}</td><td>${Math.floor((now - hp.agreement.timestamp) / (1000 * 60 * 60 * 24))}</td><td>${hp.entryMethod || 'N/A'}</td><td>${hp.groupId || 'Single'}</td></tr>`).join('')}</tbody>
            </table>
          `;
          break;
        case 'revenue':
          const charged = finalArray.filter(hp => hp.status === 'charged');
          output.innerHTML = `
            <h3>Revenue Summary</h3>
            <p>Date Range: ${startDate || 'All'} to ${endDate || 'All'}</p>
            <p>Total Revenue: $${(charged.length * 100).toFixed(2)}</p>
            <table>
              <thead><tr><th>ID</th><th>NFC ID</th><th>Customer</th><th>Email</th><th>Phone</th><th>Charge Date</th><th>Amount</th><th>Entry Method</th><th>Group ID</th></tr></thead>
              <tbody>${charged.map(hp => `<tr><td>${hp.id}</td><td>${hp.nfcId || 'N/A'}</td><td>${hp.customer.name}</td><td>${hp.customer.email}</td><td>${hp.customer.phone}</td><td>${hp.agreement.date}</td><td>$100.00</td><td>${hp.entryMethod || 'N/A'}</td><td>${hp.groupId || 'Single'}</td></tr>`).join('')}</tbody>
            </table>
          `;
          break;
        case 'customerActivity':
          const customers = {};
          finalArray.forEach(hp => {
            const key = `${hp.customer.name}|${hp.customer.email}|${hp.customer.phone}`;
            if (!customers[key]) customers[key] = { name: hp.customer.name, email: hp.customer.email, phone: hp.customer.phone, checkouts: 0, headphones: [] };
            customers[key].checkouts++;
            customers[key].headphones.push(hp.id);
          });
          output.innerHTML = `
            <h3>Customer Activity</h3>
            <p>Date Range: ${startDate || 'All'} to ${endDate || 'All'}</p>
            <table>
              <thead><tr><th>Name</th><th>Email</th><th>Phone</th><th>Total Checkouts</th><th>Headphone IDs</th></tr></thead>
              <tbody>${Object.values(customers).map(c => `<tr><td>${c.name}</td><td>${c.email}</td><td>${c.phone}</td><td>${c.checkouts}</td><td>${c.headphones.join(', ')}</td></tr>`).join('')}</tbody>
            </table>
          `;
          break;
        case 'groupSummary':
          const groups = {};
          finalArray.forEach(hp => {
            if (hp.groupId) {
              if (!groups[hp.groupId]) groups[hp.groupId] = { ids: [], customer: hp.customer, total: 0, checkedOut: 0, returned: 0, charged: 0 };
              groups[hp.groupId].ids.push(hp.id);
              groups[hp.groupId].total++;
              if (hp.status === 'checked_out') groups[hp.groupId].checkedOut++;
              if (hp.status === 'returned') groups[hp.groupId].returned++;
              if (hp.status === 'charged') groups[hp.groupId].charged++;
            }
          });
          output.innerHTML = `
            <h3>Group Checkout Summary</h3>
            <p>Date Range: ${startDate || 'All'} to ${endDate || 'All'}</p>
            <table>
              <thead><tr><th>Group ID</th><th>Customer</th><th>Email</th><th>Total Headphones</th><th>Checked Out</th><th>Returned</th><th>Charged</th><th>Headphone IDs</th></tr></thead>
              <tbody>${Object.entries(groups).map(([id, g]) => `<tr><td>${id}</td><td>${g.customer.name}</td><td>${g.customer.email}</td><td>${g.total}</td><td>${g.checkedOut}</td><td>${g.returned}</td><td>${g.charged}</td><td>${g.ids.join(', ')}</td></tr>`).join('')}</tbody>
            </table>
          `;
          break;
        case 'nfcUsage':
          const nfcStats = {};
          finalArray.forEach(hp => {
            if (hp.nfcId) {
              if (!nfcStats[hp.nfcId]) nfcStats[hp.nfcId] = { uses: 0, headphoneIds: [], dates: [] };
              nfcStats[hp.nfcId].uses++;
              nfcStats[hp.nfcId].headphoneIds.push(hp.id);
              nfcStats[hp.nfcId].dates.push(hp.agreement.date);
            }
          });
          output.innerHTML = `
            <h3>NFC Usage Statistics</h3>
            <p>Date Range: ${startDate || 'All'} to ${endDate || 'All'}</p>
            <table>
              <thead><tr><th>NFC ID</th><th>Total Uses</th><th>Headphone IDs</th><th>Dates Used</th></tr></thead>
              <tbody>${Object.entries(nfcStats).map(([id, stats]) => `<tr><td>${id}</td><td>${stats.uses}</td><td>${stats.headphoneIds.join(', ')}</td><td>${stats.dates.join(', ')}</td></tr>`).join('')}</tbody>
            </table>
          `;
          break;
        default:
          output.innerHTML = '<p>Invalid report type.</p>';
      }
    }

    function exportReport() {
      const reportType = document.getElementById('reportType').value;
      if (!reportType) return alert('Select a report type first!');
      const startDate = document.getElementById('reportStartDate').value;
      const endDate = document.getElementById('reportEndDate').value || startDate;
      let filteredArray = Object.entries(headphones).map(([id, hp]) => ({ id, ...hp }));
      if (startDate) {
        const start = new Date(startDate).setHours(0, 0, 0, 0);
        const end = new Date(endDate).setHours(23, 59, 59, 999);
        filteredArray = filteredArray.filter(hp => {
          const hpDate = new Date(hp.agreement?.date).setHours(0, 0, 0, 0);
          return hpDate >= start && hpDate <= end;
        });
      }
      const now = Date.now();
      const twelveHours = 12 * 60 * 60 * 1000;
      let csvContent = '';
      switch (reportType) {
        case 'allData':
          csvContent = '"ID","NFC ID","Status","Customer","Email","Phone","Checkout Date","Preauth Status","Entry Method","Group ID"\n' +
            filteredArray.map(hp => `"${hp.id}","${hp.nfcId || 'N/A'}","${hp.status === 'checked_out' ? 'Checked Out' : hp.status === 'returned' ? 'Returned' : 'Charged'}","${hp.customer?.name || 'N/A'}","${hp.customer?.email || 'N/A'}","${hp.customer?.phone || 'N/A'}","${hp.agreement?.date || 'N/A'}","${hp.pre_auth ? 'Hold' : 'Released'}","${hp.entryMethod || 'N/A'}","${hp.groupId || 'Single'}"`).join('\n');
          break;
        case 'checkedOut':
          csvContent = '"ID","NFC ID","Customer","Email","Phone","Checkout Date","Entry Method","Group ID"\n' +
            filteredArray.filter(hp => hp.status === 'checked_out').map(hp => `"${hp.id}","${hp.nfcId || 'N/A'}","${hp.customer.name}","${hp.customer.email}","${hp.customer.phone}","${hp.agreement.date}","${hp.entryMethod || 'N/A'}","${hp.groupId || 'Single'}"`).join('\n');
          break;
        case 'overdue':
          csvContent = '"ID","NFC ID","Customer","Email","Phone","Checkout Date","Days Overdue","Entry Method","Group ID"\n' +
            filteredArray.filter(hp => hp.status === 'checked_out' && (now - hp.agreement.timestamp > twelveHours))
              .map(hp => `"${hp.id}","${hp.nfcId || 'N/A'}","${hp.customer.name}","${hp.customer.email}","${hp.customer.phone}","${hp.agreement.date}","${Math.floor((now - hp.agreement.timestamp) / (1000 * 60 * 60 * 24))}","${hp.entryMethod || 'N/A'}","${hp.groupId || 'Single'}"`).join('\n');
          break;
        case 'revenue':
          csvContent = '"ID","NFC ID","Customer","Email","Phone","Charge Date","Amount","Entry Method","Group ID"\n' +
            filteredArray.filter(hp => hp.status === 'charged').map(hp => `"${hp.id}","${hp.nfcId || 'N/A'}","${hp.customer.name}","${hp.customer.email}","${hp.customer.phone}","${hp.agreement.date}","$100.00","${hp.entryMethod || 'N/A'}","${hp.groupId || 'Single'}"`).join('\n');
          break;
        case 'customerActivity':
          const customers = {};
          filteredArray.forEach(hp => {
            const key = `${hp.customer.name}|${hp.customer.email}|${hp.customer.phone}`;
            if (!customers[key]) customers[key] = { name: hp.customer.name, email: hp.customer.email, phone: hp.customer.phone, checkouts: 0, headphones: [] };
            customers[key].checkouts++;
            customers[key].headphones.push(hp.id);
          });
          csvContent = '"Name","Email","Phone","Total Checkouts","Headphone IDs"\n' +
            Object.values(customers).map(c => `"${c.name}","${c.email}","${c.phone}","${c.checkouts}","${c.headphones.join(', ')}"`).join('\n');
          break;
        case 'groupSummary':
          const groups = {};
          filteredArray.forEach(hp => {
            if (hp.groupId) {
              if (!groups[hp.groupId]) groups[hp.groupId] = { ids: [], customer: hp.customer, total: 0, checkedOut: 0, returned: 0, charged: 0 };
              groups[hp.groupId].ids.push(hp.id);
              groups[hp.groupId].total++;
              if (hp.status === 'checked_out') groups[hp.groupId].checkedOut++;
              if (hp.status === 'returned') groups[hp.groupId].returned++;
              if (hp.status === 'charged') groups[hp.groupId].charged++;
            }
          });
          csvContent = '"Group ID","Customer","Email","Total Headphones","Checked Out","Returned","Charged","Headphone IDs"\n' +
            Object.entries(groups).map(([id, g]) => `"${id}","${g.customer.name}","${g.customer.email}","${g.total}","${g.checkedOut}","${g.returned}","${g.charged}","${g.ids.join(', ')}"`).join('\n');
          break;
        case 'nfcUsage':
          const nfcStats = {};
          filteredArray.forEach(hp => {
            if (hp.nfcId) {
              if (!nfcStats[hp.nfcId]) nfcStats[hp.nfcId] = { uses: 0, headphoneIds: [], dates: [] };
              nfcStats[hp.nfcId].uses++;
              nfcStats[hp.nfcId].headphoneIds.push(hp.id);
              nfcStats[hp.nfcId].dates.push(hp.agreement.date);
            }
          });
          csvContent = '"NFC ID","Total Uses","Headphone IDs","Dates Used"\n' +
            Object.entries(nfcStats).map(([id, stats]) => `"${id}","${stats.uses}","${stats.headphoneIds.join(', ')}","${stats.dates.join(', ')}"`).join('\n');
          break;
      }
      const blob = new Blob([csvContent], { type: 'text/csv;charset=utf-8;' });
      const link = document.createElement('a');
      link.href = URL.createObjectURL(blob);
      link.download = `${reportType}_report_${startDate || 'all'}_${endDate || 'all'}.csv`;
      document.body.appendChild(link);
      link.click();
      document.body.removeChild(link);
    }

    function makeDraggable(dialogId, headerId) {
      const dialog = document.getElementById(dialogId);
      const header = document.getElementById(headerId);
      let isDragging = false;
      let currentX = dialog.offsetLeft;
      let currentY = dialog.offsetTop;
      let initialX, initialY;

      function startDragging(e) {
        isDragging = true;
        initialX = (e.type === 'mousedown' ? e.clientX : e.touches[0].clientX) - currentX;
        initialY = (e.type === 'mousedown' ? e.clientY : e.touches[0].clientY) - currentY;
        header.style.cursor = 'grabbing';
      }

      function drag(e) {
        if (!isDragging) return;
        e.preventDefault();
        currentX = (e.type === 'mousemove' ? e.clientX : e.touches[0].clientX) - initialX;
        currentY = (e.type === 'mousemove' ? e.clientY : e.touches[0].clientY) - initialY;
        dialog.style.left = `${currentX}px`;
        dialog.style.top = `${currentY}px`;
        dialog.style.transform = 'none';
      }

      function stopDragging() {
        isDragging = false;
        header.style.cursor = 'move';
      }

      header.addEventListener('mousedown', startDragging);
      document.addEventListener('mousemove', drag);
      document.addEventListener('mouseup', stopDragging);
      header.addEventListener('touchstart', startDragging);
      document.addEventListener('touchmove', drag);
      document.addEventListener('touchend', stopDragging);
    }
  </script>
</body>
</html>
