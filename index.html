<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Silent Disco Tracker</title>
  <script src="https://sandbox.web.squarecdn.com/v1/square.js"></script>
  <style>
    body { font-family: Arial, sans-serif; text-align: center; padding: 20px; }
    button { padding: 15px; font-size: 18px; margin: 10px; background-color: #007bff; color: white; border: none; border-radius: 5px; }
    .form { display: none; flex-direction: column; gap: 10px; max-width: 90%; margin: 20px auto; }
    input, textarea { padding: 10px; font-size: 16px; }
    #statusList { text-align: left; }
    #signaturePad { border: 2px solid #000; background: #f0f0f0; width: 300px; height: 150px; margin: 10px auto; }
    #clearSignature { font-size: 14px; padding: 10px; background: #ff4444; }
    #card-container { margin: 10px auto; }
    table { width: 100%; border-collapse: collapse; table-layout: auto; }
    th, td { border: 1px solid #ddd; padding: 8px; text-align: left; white-space: nowrap; overflow: hidden; text-overflow: ellipsis; }
    th { background-color: #f2f2f2; font-size: 14px; }
    td { font-size: 14px; }
    .checkin-btn { background-color: #28a745; padding: 5px; margin: 2px; }
    .checkout-btn { background-color: #dc3545; padding: 5px; margin: 2px; }
    #dashboard { overflow-x: auto; }
  </style>
</head>
<body>
  <h1>Silent Disco Headphone Tracker</h1>
  <button onclick="showCheckout(); vibrate()">Checkout Headphone</button>
  <button onclick="showReturn(); vibrate()">Return Headphone</button>
  <button onclick="showDashboard(); vibrate()">View Dashboard</button>
  <button onclick="scanNFCStatus(); vibrate()">Scan NFC Status</button>

  <div id="checkout" class="form">
    <h2>Checkout</h2>
    <button id="scanCheckout" onclick="scanNFC('checkout'); vibrate()">Scan NFC Tag</button>
    <input id="headphoneId" placeholder="Headphone ID (e.g., HP123)" readonly>
    <input id="name" placeholder="Full Name">
    <input id="email" placeholder="Email">
    <input id="phone" placeholder="Phone Number">
    <textarea id="agreement" readonly rows="12">RENTAL AGREEMENT AND COLLATERAL TERMS

By signing below, I, [Customer Name], agree to rent one (1) pair of wireless headphones from SE2 Silent Disco DBA and SE2 Events Inc. ("the Company") for use during the event on [Date]. I acknowledge that the headphones remain the property of the Company and must be returned in good working condition at the end of the event or upon request.

I understand and agree that failure to return the headphones by the end of the event will result in a replacement fee of $100.00 USD ("Replacement Fee"). I authorize the Company to charge my credit card, provided below, the Replacement Fee if the headphones are not returned or are returned damaged beyond normal wear and tear.

LIABILITY RELEASE: I hereby release, waive, discharge, and agree not to sue SE2 Silent Disco DBA and SE2 Events Inc., its officers, employees, agents, or affiliates ("Released Parties") from any and all liability, claims, demands, actions, or causes of action arising out of or related to any loss, damage, or injury, including death, that may be sustained by me or my property while using the headphones or attending the event, whether caused by the negligence of the Released Parties or otherwise. I assume full responsibility for any risk of bodily injury, death, or property damage arising from my use of the headphones and participation in the event.

MARKETING CONSENT: I grant SE2 Silent Disco DBA and SE2 Events Inc. permission to use my email address and phone number provided herein for marketing purposes, including but not limited to sending promotional offers, event updates, and newsletters. I understand I may opt out of these communications at any time by following the unsubscribe instructions provided in such messages.

PHOTO/VIDEO CONSENT: I consent to being photographed or recorded in video or audio by SE2 Silent Disco DBA and SE2 Events Inc. during the event. I grant the Company full permission to use, reproduce, publish, and distribute such photographs, videos, or recordings, including my likeness, voice, or image, for marketing, advertising, or promotional purposes in any medium, without compensation or further notice to me.

This agreement constitutes a legally binding contract. I acknowledge that I have read and understood these terms, and I sign this agreement voluntarily under no duress. Any disputes arising from this agreement shall be governed by the laws of New York, USA.</textarea>
    <div id="card-container"></div>
    <canvas id="signaturePad" width="300" height="150"></canvas>
    <button id="clearSignature" onclick="clearSignature(); vibrate()">Clear Signature</button>
    <button onclick="checkout(); vibrate()">Complete Checkout</button>
  </div>

  <div id="return" class="form">
    <h2>Return</h2>
    <button id="scanReturn" onclick="scanNFC('return'); vibrate()">Scan NFC Tag</button>
    <input id="returnId" placeholder="Headphone ID" readonly>
    <button onclick="returnHeadphone(); vibrate()">Return</button>
  </div>

  <div id="dashboard" class="form">
    <h2>Dashboard</h2>
    <table id="headphoneTable">
      <thead>
        <tr>
          <th>ID</th>
          <th>Status</th>
          <th>Customer</th>
          <th>Email</th>
          <th>Phone</th>
          <th>Preauth ID</th>
          <th>Preauth Status</th>
          <th>Actions</th>
        </tr>
      </thead>
      <tbody id="headphoneList"></tbody>
    </table>
  </div>

  <div id="nfcStatus" class="form">
    <h2>NFC Status</h2>
    <p id="nfcStatusResult">Scan an NFC tag to see headphone status.</p>
  </div>

  <script>
    const squareAppId = 'sandbox-sq0idb-qaDoxfFQK3OfUWlaCrgkDw';
    let headphones = JSON.parse(localStorage.getItem('headphones')) || {};
    let signatureData = null;
    let payments;
    let cardElement;

    async function initializeSquare() {
      if (!payments) {
        payments = window.Square.payments(squareAppId);
      }
      const cardContainer = document.getElementById('card-container');
      cardContainer.innerHTML = '';
      const card = await payments.card();
      await card.attach('#card-container');
      return card;
    }

    window.onload = async () => {
      cardElement = await initializeSquare();
    };

    function vibrate() {
      if ('vibrate' in navigator) navigator.vibrate(100);
    }

    async function showCheckout() {
      toggleForms('checkout');
      initSignaturePad();
    }

    function showReturn() { toggleForms('return'); }

    function showDashboard() {
      toggleForms('dashboard');
      updateDashboard();
    }

    async function scanNFCStatus() {
      toggleForms('nfcStatus');
      const resultElement = document.getElementById('nfcStatusResult');
      resultElement.textContent = 'Scanning...';

      if ('NDEFReader' in window) {
        const ndef = new NDEFReader();
        try {
          await ndef.scan();
          const controller = new AbortController();
          ndef.onreading = event => {
            const id = event.serialNumber || prompt('Enter headphone ID manually:');
            if (id && headphones[id]) {
              const hp = headphones[id];
              resultElement.innerHTML = `
                <strong>ID:</strong> ${id}<br>
                <strong>Status:</strong> ${hp.status}<br>
                <strong>Customer:</strong> ${hp.customer.name}<br>
                <strong>Email:</strong> ${hp.customer.email}<br>
                <strong>Phone:</strong> ${hp.customer.phone}<br>
                <strong>Preauth ID:</strong> ${hp.pre_auth?.pre_auth_id || 'N/A'}<br>
                <strong>Preauth Status:</strong> ${hp.pre_auth ? 'Hold' : 'Released'}
              `;
            } else {
              resultElement.textContent = `Headphone ${id} not found.`;
            }
            controller.abort();
          };
          ndef.onreadingerror = () => {
            resultElement.textContent = 'NFC scan failed. Try again.';
            controller.abort();
          };
          setTimeout(() => {
            controller.abort();
            if (resultElement.textContent === 'Scanning...') {
              resultElement.textContent = 'Scan timed out.';
            }
          }, 5000);
          await new Promise((resolve) => {
            controller.signal.addEventListener('abort', resolve);
          });
        } catch (error) {
          resultElement.textContent = `Error: ${error.message}`;
        }
      } else {
        resultElement.textContent = 'NFC not supported.';
      }
    }

    function toggleForms(active) {
      ['checkout', 'return', 'dashboard', 'nfcStatus'].forEach(id => {
        document.getElementById(id).style.display = id === active ? 'flex' : 'none';
      });
    }

    async function scanNFC(context) {
      const button = document.getElementById(context === 'checkout' ? 'scanCheckout' : 'scanReturn');
      button.disabled = true;
      if ('NDEFReader' in window) {
        const ndef = new NDEFReader();
        try {
          await ndef.scan();
          const controller = new AbortController();
          ndef.onreading = event => {
            const id = event.serialNumber || `HP${Object.keys(headphones).length + 1}`;
            setId(context, id);
            alert(`Scanned headphone: ${id}`);
            controller.abort();
            button.disabled = false;
          };
          ndef.onreadingerror = () => {
            alert('No NFC tag detected. Try again or enter manually.');
            manualEntry(context);
            controller.abort();
            button.disabled = false;
          };
          setTimeout(() => {
            controller.abort();
            if (!button.disabled) return;
            alert('Scan timed out. Try again or enter manually.');
            manualEntry(context);
            button.disabled = false;
          }, 5000);
          await new Promise((resolve) => {
            controller.signal.addEventListener('abort', resolve);
          });
        } catch (error) {
          alert(`NFC error: ${error.message}. Enter ID manually.`);
          manualEntry(context);
          button.disabled = false;
        }
      } else {
        alert('NFC not supported. Enter ID manually.');
        manualEntry(context);
        button.disabled = false;
      }
    }

    function manualEntry(context) {
      const id = prompt('Enter headphone ID (e.g., HP123):');
      const button = document.getElementById(context === 'checkout' ? 'scanCheckout' : 'scanReturn');
      if (id) setId(context, id);
      button.disabled = false;
    }

    function setId(context, id) {
      if (context === 'checkout') document.getElementById('headphoneId').value = id;
      else document.getElementById('returnId').value = id;
    }

    function initSignaturePad() {
      const canvas = document.getElementById('signaturePad');
      const ctx = canvas.getContext('2d');
      let drawing = false;

      ctx.lineWidth = 2;
      ctx.lineCap = 'round';
      ctx.strokeStyle = '#000';

      canvas.addEventListener('mousedown', startDrawing);
      canvas.addEventListener('mousemove', draw);
      canvas.addEventListener('mouseup', stopDrawing);
      canvas.addEventListener('touchstart', startDrawing);
      canvas.addEventListener('touchmove', draw);
      canvas.addEventListener('touchend', stopDrawing);

      function startDrawing(e) {
        drawing = true;
        ctx.beginPath();
        const { x, y } = getPosition(e);
        ctx.moveTo(x, y);
        e.preventDefault();
      }

      function draw(e) {
        if (!drawing) return;
        const { x, y } = getPosition(e);
        ctx.lineTo(x, y);
        ctx.stroke();
        e.preventDefault();
      }

      function stopDrawing() {
        if (drawing) {
          drawing = false;
          signatureData = canvas.toDataURL();
        }
      }

      function getPosition(e) {
        const rect = canvas.getBoundingClientRect();
        const touch = e.touches ? e.touches[0] : e;
        return {
          x: touch.clientX - rect.left,
          y: touch.clientY - rect.top
        };
      }
    }

    function clearSignature() {
      const canvas = document.getElementById('signaturePad');
      const ctx = canvas.getContext('2d');
      ctx.clearRect(0, 0, canvas.width, canvas.height);
      signatureData = null;
    }

    async function checkout() {
      const id = document.getElementById('headphoneId').value;
      const name = document.getElementById('name').value;
      const email = document.getElementById('email').value;
      const phone = document.getElementById('phone').value;
      const date = new Date().toLocaleDateString();

      if (!id || !name || !email || !phone || !signatureData || !cardElement) {
        alert('Please fill all fields, enter card details, and sign the agreement!');
        return;
      }

      const agreementText = document.getElementById('agreement').value
        .replace('[Customer Name]', name)
        .replace('[Date]', date);

      if (headphones[id] && headphones[id].status === 'checked_out') {
        alert('This headphone is already checked out!');
        return;
      }

      try {
        console.log('Starting card tokenization...');
        const result = await cardElement.tokenize();
        console.log('Tokenization result:', result);
        if (result.status !== 'OK') throw new Error('Card tokenization failed: ' + (result.errors?.[0]?.message || 'Unknown error'));
        const paymentToken = result.token;
        console.log('Payment token:', paymentToken);

        console.log('Sending preauthorization request...');
        const preauthResponse = await fetch('/.netlify/functions/preauthorize', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({
            sourceId: paymentToken,
            amount: 10000,
            currency: 'USD',
            locationId: 'LQ7MAQD7N37E5'
          })
        });

        const preauthResult = await preauthResponse.json();
        console.log('Preauthorization response:', preauthResult);
        if (!preauthResponse.ok) throw new Error(preauthResult.error || 'Preauthorization failed');
        const preauthId = preauthResult.paymentId;

        headphones[id] = {
          status: 'checked_out',
          customer: { name, email, phone },
          agreement: { text: agreementText, signature: signatureData, amount: 100 },
          pre_auth: { pre_auth_id: preauthId, amount: 100 }
        };
        localStorage.setItem('headphones', JSON.stringify(headphones));

        console.log('Sending email...');
        const emailResponse = await fetch('/.netlify/functions/send-email', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({
            name: name,
            email: email,
            agreement: agreementText,
            signature: signatureData,
            preauthId: preauthId
          })
        });

        if (emailResponse.ok) {
          alert(`Headphone ${id} checked out! Agreement emailed to ${email}. Preauthorization ID: ${preauthId}`);
        } else {
          throw new Error('Email failed');
        }
      } catch (error) {
        console.error('Checkout error:', error.message);
        alert('Checkout successful, but an error occurred: ' + error.message);
      }
      clearForm('checkout');
      clearSignature();
      showCheckout();
    }

    function returnHeadphone() {
      const id = document.getElementById('returnId').value;
      if (!id) {
        alert('Please scan a headphone!');
        return;
      }
      if (headphones[id] && headphones[id].status === 'checked_out') {
        headphones[id].status = 'returned';
        headphones[id].pre_auth = null;
        localStorage.setItem('headphones', JSON.stringify(headphones));
        alert(`Headphone ${id} returned!`);
        clearForm('return');
        showReturn();
      } else {
        alert('Headphone not found or not checked out!');
      }
    }

    function dashboardCheckout(id) {
      if (headphones[id]) {
        alert(`Headphone ${id} is already checked out or returned. Use the Checkout form for new rentals.`);
        return;
      }
      headphones[id] = { status: 'checked_out', customer: { name: 'Manual', email: 'manual@example.com', phone: 'N/A' }, pre_auth: null };
      localStorage.setItem('headphones', JSON.stringify(headphones));
      alert(`Headphone ${id} checked out manually!`);
      updateDashboard();
    }

    function dashboardCheckin(id) {
      if (headphones[id] && headphones[id].status === 'checked_out') {
        headphones[id].status = 'returned';
        headphones[id].pre_auth = null;
        localStorage.setItem('headphones', JSON.stringify(headphones));
        alert(`Headphone ${id} checked in manually!`);
        updateDashboard();
      } else {
        alert(`Headphone ${id} is not checked out!`);
      }
    }

    function updateDashboard() {
      const tbody = document.getElementById('headphoneList');
      tbody.innerHTML = '';
      Object.keys(headphones).forEach(id => {
        const hp = headphones[id];
        const row = document.createElement('tr');
        row.innerHTML = `
          <td>${id}</td>
          <td>${hp.status}</td>
          <td>${hp.customer?.name || 'N/A'}</td>
          <td>${hp.customer?.email || 'N/A'}</td>
          <td>${hp.customer?.phone || 'N/A'}</td>
          <td>${hp.pre_auth?.pre_auth_id || 'N/A'}</td>
          <td>${hp.pre_auth ? 'Hold' : 'Released'}</td>
          <td>
            <button class="checkout-btn" onclick="dashboardCheckout('${id}')">Check Out</button>
            <button class="checkin-btn" onclick="dashboardCheckin('${id}')">Check In</button>
          </td>
        `;
        tbody.appendChild(row);
      });
    }

    function clearForm(formId) {
      document.getElementById(formId).querySelectorAll('input').forEach(input => input.value = '');
    }
  </script>
</body>
</html>