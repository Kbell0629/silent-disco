<!DOCTYPE html><html lang="en"><head><meta charset="UTF-8"><meta name="viewport" content="width=device-width,initial-scale=1"><title>SE2 Silent Disco Tracker</title><script src="https://sandbox.web.squarecdn.com/v1/square.js"></script><script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-app-compat.js"></script><script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-firestore-compat.js"></script><script src="https://cdn.jsdelivr.net/npm/chart.js"></script><link href="https://fonts.googleapis.com/css2?family=Poppins:wght@400;600;700&display=swap" rel="stylesheet"><style>body{font-family:Poppins,sans-serif;background:#1A1A1A;color:#FFF;padding:15px}.container{max-width:1200px;margin:0 auto}header{display:flex;align-items:center;justify-content:center;padding:15px 0;background:rgba(138,99,255,.1);border-radius:10px;margin-bottom:20px}header img{height:50px;margin-right:10px}h1{font-size:26px;font-weight:700}.button-group{display:flex;flex-direction:column;align-items:center;gap:15px;margin-bottom:20px;width:100%}button{padding:10px 18px;font-size:16px;font-weight:600;background:#8A63FF;color:#FFF;border:none;border-radius:8px;cursor:pointer;transition:background .3s,transform .2s}button:hover{background:#6B48FF;transform:translateY(-1px)}button:disabled{background:#666;cursor:not-allowed}.form{display:none;flex-direction:column;gap:15px;background:#2A2A2A;padding:20px;border-radius:12px;box-shadow:0 4px 12px rgba(0,0,0,.3)}h2{font-size:26px;font-weight:700;color:#8A63FF}input,textarea,select{padding:8px;font-size:14px;background:#EDEDED;border:none;border-radius:6px;color:#1A1A1A;width:100%;max-width:350px}textarea{resize:vertical;height:120px}#signaturePad{border:2px solid #8A63FF;background:#FFF;width:280px;height:140px;margin:10px auto;border-radius:6px}table{width:100%;border-collapse:collapse;background:#2A2A2A;border-radius:8px}th,td{padding:6px 8px;text-align:left;font-size:13px;border-bottom:1px solid #3A3A3A}th{background:#8A63FF;font-weight:600}td{color:#EDEDED}.checkin-btn{background:#28A745}.charge-btn{background:#FFC107;color:#1A1A1A}.delete-btn{background:#808080}.button-group button{width:90%;max-width:500px}.dashboard-table-wrapper,.return-table-wrapper{max-height:450px;overflow:auto}.dialog{position:fixed;top:10%;left:50%;transform:translateX(-50%);background:#2A2A2A;padding:15px;border-radius:12px;z-index:1000;display:none;flex-direction:column;gap:12px;max-width:90%;max-height:80vh;overflow-y:auto;box-shadow:0 6px 16px rgba(0,0,0,.5)}.dialog-header{background:#8A63FF;color:#FFF;padding:8px;font-size:18px;font-weight:600;border-radius:8px 8px 0 0;cursor:move}.dialog-overlay{position:fixed;top:0;left:0;width:100%;height:100%;background:rgba(0,0,0,.7);z-index:999;display:none}.loading-overlay{position:fixed;top:0;left:0;width:100%;height:100%;background:rgba(0,0,0,.5);display:none;justify-content:center;align-items:center;z-index:2000}.spinner{border:6px solid #EDEDED;border-top:6px solid #8A63FF;border-radius:50%;width:50px;height:50px;animation:spin 1s linear infinite}@keyframes spin{to{transform:rotate(360deg)}}@media (max-width:768px){header img{height:40px}h1{font-size:22px}button{width:95%;font-size:14px;padding:8px 16px}.form{padding:15px}table{font-size:11px}th,td{padding:5px}}</style></head><body><div class="container"><header><img src="https://encrypted-tbn0.gstatic.com/images?q=tbniqSWBhKlwtFnBvx5elx7r_rqfffG3tFbfcg3OA&s" alt="SE2 Silent Disco Logo"><h1>SE2 Silent Disco Tracker</h1></header><div class="button-group"><button onclick="showCheckout()">Checkout</button><button onclick="showReturn()">Check In</button><button onclick="showDashboard()">Dashboard</button><button onclick="showReports()">Reports</button><button onclick="scanNFCStatus()">NFC Status</button></div><div id="checkout" class="form"><h2>Checkout</h2><input id="eventName" placeholder="Event Name"><button id="scanCheckout" onclick="scanNFC('checkout')">Scan NFC</button><input id="headphoneId" placeholder="Headphone ID" readonly onclick="manualEntry('checkout')"><button onclick="addHeadphoneId()">Add ID</button><ul id="headphoneIdsList"></ul><input id="name" placeholder="Full Name"><input id="email" placeholder="Email"><input id="phone" placeholder="Phone"><textarea id="agreement" readonly>RENTAL AGREEMENT...</textarea><div id="paymentOptions"><button id="tapToPay" onclick="tapToPayCheckout()">Tap to Pay</button><p>OR</p><div id="card-container"></div></div><canvas id="signaturePad" width="280" height="140"></canvas><button id="clearSignature" onclick="clearSignature()">Clear</button><button id="checkoutButton" onclick="checkout()">Checkout</button></div><div id="return" class="form"><h2>Return</h2><input id="returnSearch" placeholder="Search..." onkeyup="updateReturnTable()"><div class="return-actions"><button id="scanReturn" onclick="scanNFCForReturn()">Scan NFC</button><button onclick="returnSelectedHeadphones()">Return Selected</button></div><div class="return-table-wrapper"><table id="returnTable"><thead><tr><th>Select</th><th>Customer</th><th>Email</th><th>Phone</th><th>ID</th><th>NFC</th><th>Group</th></tr></thead><tbody id="returnList"></tbody></table></div></div><div id="dashboard" class="form"><h2>Dashboard</h2><div id="dashboardControls"><div><label>Search:</label><input id="searchInput" placeholder="Search..." onkeyup="searchHeadphones()"></div><div><label>Date:</label><input id="dateFilter" type="date" onchange="filterByDate()"></div></div><div class="dashboard-actions"><button onclick="showReturnDialogForSelected()">Return Selected</button><button onclick="returnAllChecked()">Return All</button><button id="scanDashboardNFC" onclick="scanNFCForDashboard()">Scan NFC</button></div><div class="dashboard-table-wrapper"><table id="headphoneTable"><thead><tr><th>Select</th><th>Customer</th><th>Status</th><th>Preauth</th><th>Email</th><th>Phone</th><th>ID</th><th>NFC</th><th>Method</th><th>Event</th><th>Group</th><th>Delete</th></tr></thead><tbody id="headphoneList"></tbody></table></div></div><div id="reports" class="form"><h2>Reports</h2><div class="stats-box"><p>Total Checked Out: <span id="totalCheckedOut">0</span></p><p>Overdue: <span id="totalOverdue">0</span></p></div><div id="reportControls"><div><label>Type:</label><select id="reportType" onchange="generateReport()"><option value="">Select</option><option value="allData">All</option><option value="checkedOut">Checked Out</option><option value="overdue">Overdue</option><option value="revenue">Revenue</option><option value="customerActivity">Customer</option><option value="groupSummary">Group</option><option value="nfcUsage">NFC</option><option value="dailyCheckouts">Daily</option><option value="statusDistribution">Status</option></select></div><div><label>Start:</label><input id="reportStartDate" type="date" onchange="generateReport()"></div><div><label>End:</label><input id="reportEndDate" type="date" onchange="generateReport()"></div></div><div id="reportOutput"></div></div><div id="nfcStatus" class="form"><h2>NFC Status</h2><p id="nfcStatusResult">Scan to see status</p></div><div id="manualReturnDialog" class="dialog"><div id="manualReturnDialogHeader" class="dialog-header">Return</div><input id="manualReturnSearch" placeholder="Search..." onkeyup="filterManualReturnList()"><table id="manualReturnTable"><thead><tr><th>Select</th><th>ID</th><th>Customer</th><th>Group</th></tr></thead><tbody id="manualReturnList"></tbody></table><button onclick="submitManualReturn()">Return</button><button onclick="closeDialog('manualReturn')">Cancel</button></div><div id="nfcDialog" class="dialog"><p>Scanning...</p><button onclick="cancelNFCScan()">Cancel</button></div><div id="dialogOverlay" class="dialog-overlay" onclick="closeDialog(null)"></div><div id="loadingOverlay" class="loading-overlay"><div class="spinner"></div></div></div><script>const squareAppId='sandbox-sq0idb-qaDoxfFQK3OfUWlaCrgkDw';let headphones={},checkoutListIds=new Set(),signatureData,payments,cardElement,db,headphonesCollection,activeNFCController;async function init(){await fetch('/.netlify/functions/get-config').then(r=>r.json()).then(c=>{squareLocationId=c.squareLocationId;firebase.initializeApp(c.firebaseConfig);db=firebase.firestore();headphonesCollection=db.collection('headphones')}).catch(e=>alert('Config failed'));payments=window.Square.payments(squareAppId);cardElement=await payments.card();await cardElement.attach('#card-container');await loadHeadphones();makeDraggable('manualReturnDialog','manualReturnDialogHeader')}async function loadHeadphones(){if(!db)return headphones;const s=await headphonesCollection.get();headphones={};s.forEach(d=>{headphones[d.id]=d.data();if(headphones[d.id].status==='checked_out')checkoutListIds.add(d.id)});return headphones}async function saveHeadphone(id,data){await headphonesCollection.doc(id).set(data);headphones[id]=data;if(data.status==='checked_out')checkoutListIds.add(id)}async function updateHeadphone(id,data){await headphonesCollection.doc(id).update(data);headphones[id]={...headphones[id],...data};if(data.status!=='checked_out')checkoutListIds.delete(id)}function toggleForms(active){['checkout','return','dashboard','nfcStatus','reports'].forEach(id=>document.getElementById(id).style.display=id===active?'flex':'none');document.getElementById('manualReturnDialog').style.display='none';document.getElementById('nfcDialog').style.display='none';document.getElementById('dialogOverlay').style.display='none'}function addHeadphoneId(){const id=document.getElementById('headphoneId').value.trim();if(!id||!checkoutListIds.has(id)&&headphones[id]?.status!=='checked_out')document.getElementById('headphoneIdsList').innerHTML+=`<li>${id} <button class="remove-btn" onclick="removeHeadphoneId(this,'${id}')">Remove</button></li>`;checkoutListIds.add(id);document.getElementById('headphoneId').value=''}function removeHeadphoneId(btn,id){btn.parentElement.remove();checkoutListIds.delete(id)}async function checkout(){const ids=getIds('headphoneIdsList'),n=document.getElementById('name').value,e=document.getElementById('email').value,p=document.getElementById('phone').value,d=new Date().toISOString().split('T')[0],ev=document.getElementById('eventName').value.trim();if(!ids.length||!n||!e||!p||!signatureData||!cardElement||!ev)return alert('Fill all fields');showLoading();const t=await cardElement.tokenize();if(t.status!=='OK')throw'Card error';const r=await fetch('/.netlify/functions/preauthorize',{method:'POST',body:JSON.stringify({sourceId:t.token,amount:ids.length*10000,currency:'USD',locationId:squareLocationId})}).then(r=>r.json());if(!r.paymentId)throw'Preauth failed';const g=ids.length>1?`GROUP_${Date.now()}`:null;for(const id of ids){await saveHeadphone(id,{status:'checked_out',customer:{name:n,email:e,phone:p},agreement:{text:`RENTAL AGREEMENT...`,signature:signatureData,date:d},pre_auth:{pre_auth_id:r.paymentId,amount:ids.length*100},eventName:ev,groupId:g})}await fetch('/.netlify/functions/send-email',{method:'POST',body:JSON.stringify({name:n,email:e,agreement:`RENTAL AGREEMENT...`,signature:signatureData,preauthId:r.paymentId})});alert('Checked out');hideLoading();showDashboard()}function getIds(listId){return Array.from(document.getElementById(listId).children).map(li=>li.textContent.split(' ')[0])}function showLoading(){document.getElementById('loadingOverlay').style.display='flex'}function hideLoading(){document.getElementById('loadingOverlay').style.display='none'}function updateDashboard(){const t=document.getElementById('headphoneList'),s=document.getElementById('searchInput').value.toLowerCase(),d=document.getElementById('dateFilter').value;t.innerHTML=Object.entries(headphones).map(([id,hp])=>s&&hp.customer?.name.toLowerCase().includes(s)&&(!d||hp.agreement?.date===d)?`<tr><td><input type="checkbox" name="checkinHeadphone" value="${id}"></td><td>${hp.customer?.name}</td><td>${hp.status}</td><td>${hp.pre_auth?'Hold':'Released'}</td><td>${hp.customer?.email}</td><td>${hp.customer?.phone}</td><td>${id}</td><td>${hp.nfcId||'N/A'}</td><td>${hp.entryMethod||'N/A'}</td><td>${hp.eventName||'N/A'}</td><td>${hp.groupId||'Single'}</td><td><button class="delete-btn" onclick="deleteHeadphone('${id}')">Delete</button></td></tr>`:'').join('')}function generateReport(){const r=document.getElementById('reportType').value,s=document.getElementById('reportStartDate').value,e=document.getElementById('reportEndDate').value,o=document.getElementById('reportOutput'),h=Object.entries(headphones).map(([id,hp])=>({id,...hp})),f=s?h.filter(hp=>new Date(hp.agreement?.date)>=new Date(s)):h;o.innerHTML=r==='allData'?`<table><thead><tr><th>ID</th><th>Status</th><th>Customer</th></tr></thead><tbody>${f.map(hp=>`<tr><td>${hp.id}</td><td>${hp.status}</td><td>${hp.customer?.name}</td></tr>`).join('')}</tbody></table>`:'Select report'}window.onload=init;</script></body></html>
