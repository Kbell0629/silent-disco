<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Silent Disco Tracker</title>
  <style>
    body { font-family: Arial, sans-serif; text-align: center; padding: 20px; }
    button { padding: 15px; font-size: 18px; margin: 10px; background-color: #007bff; color: white; border: none; border-radius: 5px; }
    .form { display: none; flex-direction: column; gap: 10px; max-width: 400px; margin: 20px auto; }
    input, textarea { padding: 10px; font-size: 16px; }
    #statusList { text-align: left; }
  </style>
</head>
<body>
  <h1>Silent Disco Headphone Tracker</h1>
  <button onclick="showCheckout()">Checkout Headphone</button>
  <button onclick="showReturn()">Return Headphone</button>
  <button onclick="showStatus()">View Status</button>

  <div id="checkout" class="form">
    <h2>Checkout</h2>
    <button onclick="scanNFC('checkout')">Scan NFC Tag</button>
    <input id="headphoneId" placeholder="Headphone ID (e.g., HP123)" readonly>
    <input id="name" placeholder="Full Name">
    <input id="email" placeholder="Email">
    <input id="phone" placeholder="Phone Number">
    <textarea id="agreement" readonly rows="3">If not returned, $100 will be charged.</textarea>
    <input id="signature" placeholder="Sign by typing your name">
    <input id="card" placeholder="Card Last 4 Digits">
    <button onclick="checkout()">Complete Checkout</button>
  </div>

  <div id="return" class="form">
    <h2>Return</h2>
    <button onclick="scanNFC('return')">Scan NFC Tag</button>
    <input id="returnId" placeholder="Headphone ID" readonly>
    <button onclick="returnHeadphone()">Return</button>
  </div>

  <div id="status" class="form">
    <h2>Status</h2>
    <pre id="statusList"></pre>
  </div>

  <script>
    let headphones = JSON.parse(localStorage.getItem('headphones')) || {};

    function showCheckout() {
      toggleForms('checkout');
    }

    function showReturn() {
      toggleForms('return');
    }

    function showStatus() {
      toggleForms('status');
      document.getElementById('statusList').textContent = JSON.stringify(headphones, null, 2);
    }

    function toggleForms(active) {
      ['checkout', 'return', 'status'].forEach(id => {
        document.getElementById(id).style.display = id === active ? 'flex' : 'none';
      });
    }

    async function scanNFC(context) {
      if ('NDEFReader' in window) {
        try {
          const ndef = new NDEFReader();
          await ndef.scan();
          ndef.onreading = event => {
            const id = event.serialNumber || `HP${Object.keys(headphones).length + 1}`; // Fallback if no serial
            if (context === 'checkout') {
              document.getElementById('headphoneId').value = id;
            } else {
              document.getElementById('returnId').value = id;
            }
            alert(`Scanned headphone: ${id}`);
          };
          ndef.onreadingerror = () => alert('Error scanning NFC tag!');
        } catch (error) {
          alert('NFC scan failed: ' + error);
        }
      } else {
        // Fallback for non-NFC browsers (e.g., iOS)
        const id = prompt('NFC not supported. Enter headphone ID manually (e.g., HP123):');
        if (id) {
          if (context === 'checkout') document.getElementById('headphoneId').value = id;
          else document.getElementById('returnId').value = id;
        }
      }
    }

    function checkout() {
      const id = document.getElementById('headphoneId').value;
      const name = document.getElementById('name').value;
      const email = document.getElementById('email').value;
      const phone = document.getElementById('phone').value;
      const signature = document.getElementById('signature').value;
      const card = document.getElementById('card').value;

      if (!id || !name || !email || !phone || !signature || !card) {
        alert('Please fill all fields!');
        return;
      }
      if (signature.toLowerCase() !== name.toLowerCase()) {
        alert('Signature must match name!');
        return;
      }
      if (headphones[id] && headphones[id].status === 'checked_out') {
        alert('This headphone is already checked out!');
        return;
      }

      headphones[id] = {
        status: 'checked_out',
        customer: { name, email, phone },
        agreement: { text: 'If not returned, $100 charged.', signed_by: signature, amount: 100 },
        pre_auth: { card_last4: card, pre_auth_id: `PREAUTH-${id}-${Date.now()}`, amount: 100 }
      };
      localStorage.setItem('headphones', JSON.stringify(headphones));
      alert(`Headphone ${id} checked out!`);
      clearForm('checkout');
      showCheckout();
    }

    function returnHeadphone() {
      const id = document.getElementById('returnId').value;
      if (!id) {
        alert('Please scan a headphone!');
        return;
      }
      if (headphones[id] && headphones[id].status === 'checked_out') {
        headphones[id].status = 'returned';
        headphones[id].pre_auth = null;
        localStorage.setItem('headphones', JSON.stringify(headphones));
        alert(`Headphone ${id} returned!`);
        clearForm('return');
        showReturn();
      } else {
        alert('Headphone not found or not checked out!');
      }
    }

    function clearForm(formId) {
      document.getElementById(formId).querySelectorAll('input').forEach(input => input.value = '');
    }
  </script>
</body>
</html>
