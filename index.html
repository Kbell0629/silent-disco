<!DOCTYPE html><html lang="en"><head><meta charset="UTF-8"><meta name="viewport" content="width=device-width,initial-scale=1.0"><title>SE2 Silent Disco Tracker</title><script src="https://sandbox.web.squarecdn.com/v1/square.js"></script><script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-app-compat.js"></script><script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-firestore-compat.js"></script><script src="https://cdn.jsdelivr.net/npm/chart.js"></script><link href="https://fonts.googleapis.com/css2?family=Poppins:wght@400;600;700&display=swap" rel="stylesheet"><style>*{margin:0;padding:0;box-sizing:border-box}body{font-family:'Poppins',sans-serif;background:#1A1A1A;color:#FFF;padding:20px;line-height:1.6}.container{max-width:1200px;margin:0 auto}header{display:flex;align-items:center;justify-content:center;padding:20px 0;background:rgba(107,72,255,.1);border-radius:10px;margin-bottom:30px;text-align:center}header img{height:60px;margin-right:15px}header h1{font-size:28px;font-weight:700;color:#FFF}.button-group{display:flex;flex-direction:column;align-items:center;gap:20px;margin-bottom:30px;width:100%}button{padding:12px 20px;font-size:16px;font-weight:600;background:#6B48FF;color:#FFF;border:none;border-radius:8px;cursor:pointer;transition:background .3s ease,transform .2s ease}button:hover{background:#5439CC;transform:translateY(-2px)}button:disabled{background:#666;cursor:not-allowed;transform:none}.form{display:none;flex-direction:column;gap:20px;background:#2A2A2A;padding:25px;border-radius:12px;box-shadow:0 4px 12px rgba(0,0,0,.3)}.form h2{font-size:24px;font-weight:600;color:#FFF}input,textarea,select{padding:10px;font-size:14px;background:#EDEDED;border:none;border-radius:6px;color:#1A1A1A;width:100%;max-width:400px}textarea{resize:vertical;height:150px}label{font-size:14px;color:#FFF;margin-bottom:5px;display:block}#signaturePad{border:2px solid #6B48FF;background:#FFF;width:300px;height:150px;margin:10px auto;border-radius:6px}#clearSignature{background:#FF4444}#clearSignature:hover{background:#CC3333}#card-container{margin:10px auto;min-height:50px}#paymentOptions{display:flex;flex-direction:column;align-items:center;gap:10px}#paymentOptions p{color:#EDEDED;font-size:14px}table{width:100%;border-collapse:collapse;background:#2A2A2A;border-radius:8px;overflow:hidden}th,td{padding:8px;text-align:left;font-size:12px;border-bottom:1px solid #3A3A3A}th{background:#6B48FF;font-weight:600;position:sticky;top:0;z-index:10}td{color:#EDEDED}.checkin-btn{background:#28A745}.charge-btn{background:#FFC107;color:#1A1A1A}.delete-btn{background:#808080}.button-group button{width:90%;max-width:600px;text-align:center}.form button{width:auto;min-width:150px}#headphoneIdsList{list-style:none;padding:0;margin:10px 0;background:#3A3A3A;border-radius:6px}#headphoneIdsList li{display:flex;justify-content:space-between;align-items:center;padding:10px;border-bottom:1px solid #4A4A4A}.remove-btn{background:#DC3545;padding:6px 12px;font-size:12px}.dialog{position:fixed;top:10%;left:50%;transform:translateX(-50%);background:#2A2A2A;padding:20px;border-radius:12px;z-index:1000;display:none;flex-direction:column;gap:15px;max-width:90%;max-height:80vh;overflow-y:auto;box-shadow:0 6px 16px rgba(0,0,0,.5)}.dialog-header{background:#6B48FF;color:#FFF;padding:10px;font-size:20px;font-weight:600;border-radius:8px 8px 0 0;cursor:move}.dialog-overlay{position:fixed;top:0;left:0;width:100%;height:100%;background:rgba(0,0,0,.7);z-index:999;display:none}.loading-overlay{position:fixed;top:0;left:0;width:100%;height:100%;background:rgba(0,0,0,.5);display:none;justify-content:center;align-items:center;z-index:2000}.spinner{border:8px solid #EDEDED;border-top:8px solid #6B48FF;border-radius:50%;width:60px;height:60px;animation:spin 1s linear infinite}.dashboard-table-wrapper,.return-table-wrapper{max-height:500px;overflow-y:auto;overflow-x:auto;width:100%}.dashboard-actions,.return-actions{margin:20px 0;display:flex;gap:10px;justify-content:center}#reportControls{display:flex;flex-wrap:wrap;gap:15px;margin-bottom:20px;align-items:center;justify-content:space-between}#reportControls div{display:flex;gap:10px;align-items:center}#reportControls label{font-size:14px;color:#FFF;margin-right:5px}#reportFilters button{padding:8px 15px;font-size:14px}#reportOutput{max-width:100%;overflow-x:auto;padding:10px}#chartContainer{width:100%;max-width:800px;height:400px;margin:0 auto;position:relative}#reportOutput canvas{width:100%!important;height:100%!important}#nfcDialog button{background:#DC3545;margin-top:10px}#nfcDialog button:hover{background:#B02A37}#nfcDialog p{font-size:16px;text-align:center}@keyframes spin{0%{transform:rotate(0deg)}100%{transform:rotate(360deg)}}@media (max-width:768px){header img{height:40px}header h1{font-size:22px}.button-group{gap:15px}button{width:95%;font-size:16px;padding:12px 20px}.form{padding:15px}input,textarea,select{width:100%;max-width:100%}table{font-size:10px}th,td{padding:6px}.dashboard-table-wrapper,.return-table-wrapper{max-height:300px}#reportControls{flex-direction:column;align-items:stretch}#reportControls div{flex-direction:column;align-items:stretch}#chartContainer{max-width:100%;height:300px}}</style></head><body><div class="container"><header><img src="https://encrypted-tbn0.gstatic.com/images?q=tbniqSWBhKlwtFnBvx5elx7r_rqfffG3tFbfcg3OA&s" alt="SE2 Silent Disco Logo"><h1>SE2 Silent Disco Tracker</h1></header><div class="button-group"><button onclick="showCheckout();vibrate()">Checkout - Handout Headphones</button><button onclick="showReturn();vibrate()">Check In - Return Headphones</button><button onclick="showDashboard();vibrate()">View Dashboard</button><button onclick="showReports();vibrate()">View Reports</button><button onclick="scanNFCStatus();vibrate()">Scan NFC Status</button></div><div id="checkout" class="form"><h2>Checkout Headphones</h2><button id="scanCheckout" onclick="scanNFCForCheckout();vibrate()">Scan NFC Tag</button><label for="headphoneId">Headphone ID</label><input id="headphoneId" placeholder="Headphone ID (e.g., HP0000001)" readonly onclick="manualEntry();vibrate()"><button onclick="addHeadphoneId();vibrate()">Add Headphone ID</button><ul id="headphoneIdsList"></ul><label for="name">Full Name</label><input id="name" placeholder="Full Name"><label for="email">Email</label><input id="email" placeholder="Email"><label for="phone">Phone Number</label><input id="phone" placeholder="Phone Number"><label for="agreement">Rental Agreement</label><textarea id="agreement" readonly>RENTAL AGREEMENT AND COLLATERAL TERMS

By signing below, I, [Customer Name], agree to rent the following wireless headphones ([Headphone IDs]) from SE2 Silent Disco DBA and SE2 Events Inc. ("the Company") for use during the event on [Date]. I acknowledge that the headphones remain the property of the Company and must be returned in good working condition at the end of the event or upon request.
I understand and agree that failure to return any headphone by the end of the event will result in a replacement fee of $100.00 USD per headphone ("Replacement Fee"). I authorize the Company to charge my credit card, provided below, the Replacement Fee for each headphone not returned or returned damaged beyond normal wear and tear.
LIABILITY RELEASE: I hereby release, waive, discharge, and agree not to sue SE2 Silent Disco DBA and SE2 Events Inc., its officers, employees, agents, or affiliates ("Released Parties") from any and all liability, claims, demands, actions, or causes of action arising out of or related to any loss, damage, or injury, including death, that may be sustained by me or my property while using the headphones or attending the event, whether caused by the negligence of the Released Parties or otherwise. I assume full responsibility for any risk of bodily injury, death, or property damage arising from my use of the headphones and participation in the event.
MARKETING CONSENT: I grant SE2 Silent Disco DBA and SE2 Events Inc. permission to use my email address and phone number provided herein for marketing purposes, including but not limited to sending promotional offers, event updates, and newsletters. I understand I may opt out of these communications at any time by following the unsubscribe instructions provided in such messages.
PHOTO/VIDEO CONSENT: I consent to being photographed or recorded in video or audio by SE2 Silent Disco DBA and SE2 Events Inc. during the event. I grant the Company full permission to use, reproduce, publish, and distribute such photographs, videos, or recordings, including my likeness, voice, or image, for marketing, advertising, or promotional purposes in any medium, without compensation or further notice to me.
This agreement constitutes a legally binding contract. I acknowledge that I have read and understood these terms, and I sign this agreement voluntarily under no duress. Any disputes arising from this agreement shall be governed by the laws of New York, USA.</textarea><div id="paymentOptions"><button id="tapToPay" onclick="tapToPayCheckout();vibrate()">Tap Card to Checkout</button><p>OR</p><div id="card-container"></div></div><canvas id="signaturePad" width="300" height="150"></canvas><button id="clearSignature" onclick="clearSignature();vibrate()">Clear Signature</button><button id="checkoutButton" onclick="checkout();vibrate()">Complete Checkout</button></div><div id="return" class="form"><h2>Return Headphones</h2><label for="returnSearch">Search Headphones</label><input id="returnSearch" type="text" placeholder="Search headphones..." onkeyup="updateReturnTable()"><div class="return-actions"><button id="scanReturn" onclick="scanNFCForReturn();vibrate()">Scan NFC</button><button onclick="returnSelectedHeadphones();vibrate()">Return Selected</button></div><div class="return-table-wrapper"><table id="returnTable"><thead><tr><th>Select</th><th>Customer</th><th>Email</th><th>Phone</th><th>ID</th><th>NFC ID</th><th>Group ID</th></tr></thead><tbody id="returnList"></tbody></table></div></div><div id="dashboard" class="form"><h2>Dashboard</h2><label for="searchInput">Search Headphones</label><input id="searchInput" type="text" placeholder="Search headphones..." onkeyup="updateDashboard()"><label for="dateFilter">Filter by Date</label><input id="dateFilter" type="date" onchange="updateDashboard()"><label for="dashboardStartDate">Start Date</label><input id="dashboardStartDate" type="date" onchange="updateDashboard()" placeholder="Start Date"><label for="dashboardEndDate">End Date</label><input id="dashboardEndDate" type="date" onchange="updateDashboard()" placeholder="End Date"><div class="dashboard-actions"><button onclick="showReturnDialogForSelected();vibrate()">Return Selected</button><button id="scanDashboardNFC" onclick="scanNFCForDashboard();vibrate()">Scan NFC</button></div><div class="dashboard-table-wrapper"><table id="headphoneTable"><thead><tr><th>Select</th><th>Customer</th><th>Status</th><th>Preauth Status</th><th>Email</th><th>Phone</th><th>ID</th><th>NFC ID</th><th>Entry Method</th><th>Group ID</th><th>Delete</th></tr></thead><tbody id="headphoneList"></tbody></table></div></div><div id="reports" class="form"><h2>Reports</h2><div id="reportControls"><div><label for="reportType">Report Type:</label><select id="reportType" onchange="generateReport()"><option value="">Select a Report</option><option value="allData">All Data</option><option value="checkedOut">Currently Checked Out</option><option value="overdue">Overdue Headphones</option><option value="revenue">Revenue Summary</option><option value="customerActivity">Customer Activity</option><option value="groupSummary">Group Checkout Summary</option><option value="nfcUsage">NFC Usage Statistics</option><option value="dailyCheckouts">Daily Checkouts</option><option value="statusDistribution">Status Distribution</option></select></div><div id="reportFilters"><label>Date Range:</label><button onclick="filterReport(7)">Last 7 Days</button><button onclick="filterReport(30)">Last 30 Days</button><button onclick="resetFilters()">Reset</button></div><div><label for="reportSearch">Search:</label><input id="reportSearch" type="text" placeholder="Search reports..." onkeyup="generateReport()"></div><div><label for="chartType">Chart Style:</label><select id="chartType" onchange="generateReport()"><option value="bar">Bar</option><option value="line">Line</option><option value="pie">Pie</option></select></div><div><button onclick="exportReport()">Export as CSV</button></div></div><label for="reportStartDate">Start Date</label><input id="reportStartDate" type="date" onchange="generateReport()" placeholder="Start Date"><label for="reportEndDate">End Date</label><input id="reportEndDate" type="date" onchange="generateReport()" placeholder="End Date"><div id="reportOutput"><div id="chartContainer"><canvas id="reportChart"></canvas></div></div></div><div id="nfcStatus" class="form"><h2>NFC Status</h2><p id="nfcStatusResult">Scan an NFC tag to see headphone status.</p></div><div id="manualReturnDialog" class="dialog"><div id="manualReturnDialogHeader" class="dialog-header">Select Headphones to Return</div><label for="manualReturnSearch">Search Headphones</label><input id="manualReturnSearch" type="text" placeholder="Search headphones..." onkeyup="filterManualReturnList()"><table id="manualReturnTable"><thead><tr><th>Select</th><th>ID</th><th>Customer</th><th>Group ID</th></tr></thead><tbody id="manualReturnList"></tbody></table><button onclick="submitManualReturn();vibrate()">Return Selected</button><button onclick="closeDialog('manualReturn');vibrate()">Cancel</button></div><div id="nfcDialog" class="dialog"><p>Scanning... Click 'Cancel Scan' to stop</p><button onclick="cancelNFCScan();vibrate()">Cancel Scan</button></div><div id="dialogOverlay" class="dialog-overlay" onclick="closeDialog(null);vibrate()"></div><div id="loadingOverlay" class="loading-overlay"><div class="spinner"></div></div></div><script>const squareAppId='sandbox-sq0idb-qaDoxfFQK3OfUWlaCrgkDw';let headphones={},usedHeadphoneIds=new Set(),checkoutListIds=new Set(),signatureData=null,payments,cardElement,db,headphonesCollection,squareLocationId,firebaseConfig,activeNFCController=null,nfcTriggered=false,timeoutId=null,chartInstance=null;async function fetchConfig(){try{const response=await fetch('/.netlify/functions/get-config'),config=await response.json();squareLocationId=config.squareLocationId;firebaseConfig=config.firebaseConfig}catch(error){console.error('Failed to fetch config:',error);alert('Failed to load configuration')}}async function waitForFirebase(){return new Promise(resolve=>{let attempts=0;const checkFirebase=setInterval(()=>{if(typeof firebase!=='undefined'&&firebase.app&&firebase.firestore||attempts>=100){clearInterval(checkFirebase);if(firebase.app){firebase.initializeApp(firebaseConfig);db=firebase.firestore();headphonesCollection=db.collection('headphones')}resolve()}attempts++},100)})}async function loadHeadphones(){if(!db||!headphonesCollection)return headphones;try{const snapshot=await headphonesCollection.get();headphones={};usedHeadphoneIds=new Set();snapshot.forEach(doc=>{headphones[doc.id]=doc.data();if(headphones[doc.id].status==='checked_out')usedHeadphoneIds.add(doc.id)});return headphones}catch(error){console.error('Error loading headphones:',error);alert('Failed to load data');return headphones}}async function saveHeadphone(id,data){try{if(db&&headphonesCollection)await headphonesCollection.doc(id).set(data);headphones[id]=data;if(data.status==='checked_out')usedHeadphoneIds.add(id)}catch(error){console.error('Error saving headphone:',error);throw error}}async function updateHeadphone(id,data){try{if(db&&headphonesCollection)await headphonesCollection.doc(id).update(data);headphones[id]={...headphones[id],...data};if(data.status==='returned'||data.status==='charged')usedHeadphoneIds.delete(id)}catch(error){console.error('Error updating headphone:',error);alert('Failed to update data');throw error}}async function deleteHeadphone(id){try{if(confirm(`Are you sure you want to delete headphone ${id}?`)){if(db&&headphonesCollection)await headphonesCollection.doc(id).delete();delete headphones[id];usedHeadphoneIds.delete(id);checkoutListIds.delete(id);alert(`Headphone ${id} deleted!`);updateDashboard()}}catch(error){console.error('Error deleting headphone:',error);alert('Failed to delete headphone')}}async function initializeSquare(){if(!window.Square)return;if(!payments)payments=window.Square.payments(squareAppId);const cardContainer=document.getElementById('card-container');cardContainer.innerHTML='';cardElement=await payments.card();await cardElement.attach('#card-container');return cardElement}window.onload=async()=>{try{await fetchConfig();await waitForFirebase();await initializeSquare();await loadHeadphones();makeDraggable('manualReturnDialog','manualReturnDialogHeader');nfcTriggered=false;runTests()}catch(error){console.error('Initialization error:',error);alert('Failed to start app')}};function vibrate(){if('vibrate' in navigator)navigator.vibrate(100)}function showLoading(){document.getElementById('loadingOverlay').style.display='flex';document.getElementById('checkoutButton').disabled=true;document.querySelectorAll('.charge-btn').forEach(btn=>btn.disabled=true)}function hideLoading(){document.getElementById('loadingOverlay').style.display='none';document.getElementById('checkoutButton').disabled=false;document.querySelectorAll('.charge-btn').forEach(btn=>btn.disabled=false)}function addHeadphoneId(){const id=document.getElementById('headphoneId').value.trim();if(!id)return alert('Please enter a headphone ID!');const currentIds=getHeadphoneIds('headphoneIdsList');if(currentIds.includes(id))return alert(`Headphone ID ${id} is already in your checkout list!`);if(headphones[id]&&headphones[id].status==='checked_out')return alert(`Headphone ${id} is already checked out!`);const list=document.getElementById('headphoneIdsList'),li=document.createElement('li');li.innerHTML=`${id} <button class="remove-btn" onclick="removeHeadphoneId(this,'${id}')">Remove</button>`;list.appendChild(li);checkoutListIds.add(id);document.getElementById('headphoneId').value=''}function removeHeadphoneId(button,id){button.parentElement.remove();checkoutListIds.delete(id)}function getHeadphoneIds(listId){return Array.from(document.getElementById(listId).children).map(li=>li.textContent.split(' ')[0])}function generateGroupId(){const groupRegex=/^GROUP_\d{7}$/,existingGroups=Object.values(headphones).filter(hp=>hp.groupId&&groupRegex.test(hp.groupId)).map(hp=>parseInt(hp.groupId.replace('GROUP_',''),10));let nextNum=1;if(existingGroups.length)nextNum=Math.max(...existingGroups)+1;return`GROUP_${String(nextNum).padStart(7,'0')}`}function generateUniqueHeadphoneId(){const regex=/^HP\d{7}$/,allIds=new Set([...usedHeadphoneIds,...checkoutListIds]),existingIds=Array.from(allIds).filter(id=>regex.test(id));let nextNum=1;if(existingIds.length)nextNum=Math.max(...existingIds.map(id=>parseInt(id.replace('HP',''),10)))+1;return`HP${String(nextNum).padStart(7,'0')}`}async function showCheckout(){toggleForms('checkout');initSignaturePad('signaturePad');await initializeSquare();document.getElementById('headphoneIdsList').innerHTML='';checkoutListIds.clear();if(activeNFCController){activeNFCController.abort();activeNFCController=null}console.log('Checkout form shown, NFC state reset');nfcTriggered=false;document.getElementById('scanCheckout').disabled=false}async function showReturn(){toggleForms('return');await loadHeadphones();updateReturnTable()}async function showDashboard(){toggleForms('dashboard');await loadHeadphones();updateDashboard()}async function showReports(){toggleForms('reports');await loadHeadphones();document.getElementById('reportType').value='';document.getElementById('reportStartDate').value='';document.getElementById('reportEndDate').value='';document.getElementById('reportSearch').value='';document.getElementById('chartType').value='bar';generateReport()}async function scanNFCStatus(){nfcTriggered=true;toggleForms('nfcStatus');const dialog=document.getElementById('nfcDialog'),overlay=document.getElementById('dialogOverlay'),resultElement=document.getElementById('nfcStatusResult');dialog.style.display='flex';overlay.style.display='block';resultElement.textContent='';if(!('NDEFReader' in window)){resultElement.textContent='NFC not supported.';dialog.style.display='none';overlay.style.display='none';return}const ndef=new NDEFReader();activeNFCController=new AbortController();try{await ndef.scan({signal:activeNFCController.signal});ndef.onreading=event=>{const nfcId=event.serialNumber.toLowerCase(),matchingHeadphone=Object.entries(headphones).find(([_,hp])=>hp.nfcId&&hp.nfcId.toLowerCase()===nfcId);if(matchingHeadphone){const[id,hp]=matchingHeadphone;resultElement.innerHTML+=`<strong>ID:</strong> ${id}<br><strong>NFC ID:</strong> ${hp.nfcId||'N/A'}<br><strong>Status:</strong> ${hp.status==='checked_out'?'Checked Out':hp.status==='returned'?'Returned':'Charged'}<br><strong>Customer:</strong> ${hp.customer.name}<br><strong>Email:</strong> ${hp.customer.email}<br><strong>Phone:</strong> ${hp.customer.phone}<br><strong>Preauth Status:</strong> ${hp.pre_auth?'Hold':'Released'}<br><strong>Entry Method:</strong> ${hp.entryMethod||'N/A'}<br><strong>Date:</strong> ${hp.agreement.date||'N/A'}<br><strong>Group ID:</strong> ${hp.groupId||'Single'}<br><hr>`}};ndef.onreadingerror=()=>{resultElement.innerHTML+='<br>Error reading NFC tag. Try again.'}}catch(error){if(error.name!=='AbortError')resultElement.textContent=`Error: ${error.message}`;dialog.style.display='none';overlay.style.display='none'}}function toggleForms(active){['checkout','return','dashboard','nfcStatus','reports'].forEach(id=>document.getElementById(id).style.display=id===active?'flex':'none');document.getElementById('manualReturnDialog').style.display='none';document.getElementById('nfcDialog').style.display='none';document.getElementById('dialogOverlay').style.display='none'}async function scanNFCForCheckout(){nfcTriggered=true;const button=document.getElementById('scanCheckout'),input=document.getElementById('headphoneId'),dialog=document.getElementById('nfcDialog'),overlay=document.getElementById('dialogOverlay');button.disabled=true;dialog.style.display='flex';overlay.style.display='block';if(!('NDEFReader' in window)){console.log('NFC not supported by browser');alert('NFC not supported. Enter ID manually.');manualEntry();button.disabled=false;dialog.style.display='none';overlay.style.display='none';return}console.log('Starting NFC scan for checkout');if(activeNFCController){activeNFCController.abort();console.log('Aborted existing NFC controller');}const ndef=new NDEFReader();activeNFCController=new AbortController();try{await ndef.scan({signal:activeNFCController.signal});console.log('NFC scan started successfully');const scanStartTime=Date.now();let scannedCount=0,lastScanTime=Date.now();ndef.onreading=event=>{const timeSinceStart=Date.now()-scanStartTime;if(timeSinceStart<500){console.log(`Ignoring NFC read within 500ms of scan start: ${event.serialNumber}`);return}const nfcId=event.serialNumber.toLowerCase(),id=generateUniqueHeadphoneId(),currentIds=getHeadphoneIds('headphoneIdsList');console.log(`NFC tag read: ${nfcId}, assigned ID: ${id}`);if(currentIds.includes(id))alert(`Headphone ID ${id} is already in your checkout list!`);else if(headphones[id]&&headphones[id].status==='checked_out')alert(`Headphone ${id} is already checked out!`);else{const list=document.getElementById('headphoneIdsList'),li=document.createElement('li');li.innerHTML=`${id} <button class="remove-btn" onclick="removeHeadphoneId(this,'${id}')">Remove</button>`;list.appendChild(li);checkoutListIds.add(id);scannedCount++;alert(`Headphone ${id} with NFC ID ${nfcId} added to checkout list.`)}input.value='';input.dataset.nfcId=nfcId;input.dataset.entryMethod='NFC';lastScanTime=Date.now()};ndef.onreadingerror=()=>{console.log('NFC reading error occurred');alert('Error reading NFC tag. Please try again.')};timeoutId=setInterval(()=>{if(Date.now()-lastScanTime>=7000){activeNFCController.abort();clearInterval(timeoutId);timeoutId=null;if(!scannedCount){console.log('No NFC tags detected after 7 seconds');alert('No NFC tags detected after 7 seconds. Please enter headphone IDs manually.');manualEntry()}else{console.log(`NFC scan completed, ${scannedCount} headphone(s) added`);alert(`NFC scan complete. ${scannedCount} headphone(s) added to checkout list.`)}button.disabled=false;dialog.style.display='none';overlay.style.display='none'}},500)}catch(error){if(error.name!=='AbortError'){console.error('NFC scan failed:',error.message);alert(`NFC scan failed: ${error.message}. Enter ID manually.`);manualEntry()}button.disabled=false;dialog.style.display='none';overlay.style.display='none'}}function manualEntry(){const input=document.getElementById('headphoneId'),button=document.getElementById('scanCheckout'),regex=/^HP\d{7}$/,suggestedId=generateUniqueHeadphoneId(),userId=prompt(`Enter headphone ID (suggested: ${suggestedId}):`,suggestedId);if(!userId||!regex.test(userId)){alert('Invalid ID format. Use HP followed by 7 digits.');button.disabled=false;return}if(headphones[userId]&&headphones[userId].status==='checked_out'){alert(`ID ${userId} is already checked out!`);button.disabled=false;return}if(checkoutListIds.has(userId)){alert(`ID ${userId} is already in your checkout list!`);button.disabled=false;return}input.value=userId;input.dataset.entryMethod='Manual';button.disabled=false}async function scanNFCForDashboard(){nfcTriggered=true;const button=document.getElementById('scanDashboardNFC'),dialog=document.getElementById('nfcDialog'),overlay=document.getElementById('dialogOverlay');button.disabled=true;dialog.style.display='flex';overlay.style.display='block';if(!('NDEFReader' in window)){alert('NFC not supported. Please manually select headphones to return.');button.disabled=false;dialog.style.display='none';overlay.style.display='none';return}const ndef=new NDEFReader();activeNFCController=new AbortController();try{await ndef.scan({signal:activeNFCController.signal});let scannedCount=0,lastScanTime=Date.now();ndef.onreading=event=>{const nfcId=event.serialNumber.toLowerCase(),matchingHeadphone=Object.entries(headphones).find(([_,hp])=>hp.nfcId&&hp.nfcId.toLowerCase()===nfcId&&hp.status==='checked_out');if(matchingHeadphone){const[id]=matchingHeadphone,checkbox=document.querySelector(`input[name="checkinHeadphone"][value="${id}"]`);if(checkbox){checkbox.checked=true;alert(`Headphone ${id} with NFC ID ${nfcId} selected for return.`);scannedCount++}else alert(`Headphone ${id} with NFC ID ${nfcId} is checked out but not in the current dashboard view. Adjust filters or search to include it.`)}lastScanTime=Date.now()};ndef.onreadingerror=()=>alert('Error reading NFC tag. Please try again or manually select headphones.');timeoutId=setInterval(()=>{if(Date.now()-lastScanTime>=7000){activeNFCController.abort();clearInterval(timeoutId);timeoutId=null;if(!scannedCount)alert('No NFC tags detected after 7 seconds. Please manually select headphones to return.');button.disabled=false;dialog.style.display='none';overlay.style.display='none'}},500)}catch(error){if(error.name!=='AbortError')alert(`NFC scan failed: ${error.message}. Please manually select headphones to return.`);button.disabled=false;dialog.style.display='none';overlay.style.display='none'}}async function scanNFCForReturn(){nfcTriggered=true;const button=document.getElementById('scanReturn'),dialog=document.getElementById('nfcDialog'),overlay=document.getElementById('dialogOverlay');button.disabled=true;dialog.style.display='flex';overlay.style.display='block';if(!('NDEFReader' in window)){alert('NFC not supported. Please manually select headphones to return.');button.disabled=false;dialog.style.display='none';overlay.style.display='none';return}const ndef=new NDEFReader();activeNFCController=new AbortController();try{await ndef.scan({signal:activeNFCController.signal});let scannedCount=0,lastScanTime=Date.now();ndef.onreading=event=>{const nfcId=event.serialNumber.toLowerCase(),matchingHeadphone=Object.entries(headphones).find(([_,hp])=>hp.nfcId&&hp.nfcId.toLowerCase()===nfcId&&hp.status==='checked_out');if(matchingHeadphone){const[id]=matchingHeadphone,checkbox=document.querySelector(`input[name="returnHeadphone"][value="${id}"]`);if(checkbox){checkbox.checked=true;alert(`Headphone ${id} with NFC ID ${nfcId} selected for return.`);scannedCount++}else alert(`Headphone ${id} with NFC ID ${nfcId} is checked out but not in the current view. Adjust search to include it.`)}lastScanTime=Date.now()};ndef.onreadingerror=()=>alert('Error reading NFC tag. Please try again or manually select headphones.');timeoutId=setInterval(()=>{if(Date.now()-lastScanTime>=7000){activeNFCController.abort();clearInterval(timeoutId);timeoutId=null;if(!scannedCount)alert('No NFC tags detected after 7 seconds. Please manually select headphones to return.');button.disabled=false;dialog.style.display='none';overlay.style.display='none'}},500)}catch(error){if(error.name!=='AbortError')alert(`NFC scan failed: ${error.message}. Please manually select headphones to return.`);button.disabled=false;dialog.style.display='none';overlay.style.display='none'}}function cancelNFCScan(){if(activeNFCController){activeNFCController.abort();activeNFCController=null;if(timeoutId){clearInterval(timeoutId);timeoutId=null}document.getElementById('nfcDialog').style.display='none';document.getElementById('dialogOverlay').style.display='none';document.getElementById('scanCheckout').disabled=false;document.getElementById('scanDashboardNFC').disabled=false;document.getElementById('scanReturn').disabled=false;document.getElementById('nfcStatusResult').textContent='Scan cancelled. Scan an NFC tag to see headphone status.'}}function showManualReturnDialog(){const dialog=document.getElementById('manualReturnDialog'),overlay=document.getElementById('dialogOverlay'),list=document.getElementById('manualReturnList'),checkedOut=Object.entries(headphones).filter(([_,hp])=>hp.status==='checked_out');dialog.style.display='flex';overlay.style.display='block';list.innerHTML='';checkedOut.forEach(([id,hp])=>{const row=document.createElement('tr');row.innerHTML=`<td><input type="checkbox" name="manualReturnHeadphone" value="${id}"></td><td>${id}</td><td>${hp.customer.name}</td><td>${hp.groupId||'Single'}</td>`;list.appendChild(row)});document.getElementById('manualReturnSearch').value=''}function filterManualReturnList(){const searchTerm=document.getElementById('manualReturnSearch').value.toLowerCase(),rows=document.getElementById('manualReturnList').getElementsByTagName('tr');Array.from(rows).forEach(row=>row.style.display=row.textContent.toLowerCase().includes(searchTerm)?'':'none')}async function submitManualReturn(){const selected=Array.from(document.getElementById('manualReturnList').querySelectorAll('input[name="manualReturnHeadphone"]:checked')).map(input=>input.value);if(!selected.length)return alert('Please select at least one headphone!');const groupIds=selected.map(id=>headphones[id].groupId||'Single');if(new Set(groupIds).size>1)return alert('All selected headphones must belong to the same group or all be singles.');try{for(const id of selected)await updateHeadphone(id,{status:'returned',pre_auth:null});const message=await sendReturnEmail(selected);alert(message);closeDialog('manualReturn');showReturn()}catch(error){alert('Failed to return headphones: '+error.message)}}function initSignaturePad(canvasId){const canvas=document.getElementById(canvasId),ctx=canvas.getContext('2d');let drawing=false;ctx.lineWidth=2;ctx.lineCap='round';ctx.strokeStyle='#000';canvas.addEventListener('mousedown',e=>{drawing=true;ctx.beginPath();const{x,y}=getPosition(e);ctx.moveTo(x,y);e.preventDefault()});canvas.addEventListener('mousemove',e=>{if(!drawing)return;const{x,y}=getPosition(e);ctx.lineTo(x,y);ctx.stroke();e.preventDefault()});canvas.addEventListener('mouseup',()=>{if(drawing){drawing=false;if(canvasId==='signaturePad')signatureData=canvas.toDataURL()}});canvas.addEventListener('touchstart',e=>{drawing=true;ctx.beginPath();const{x,y}=getPosition(e);ctx.moveTo(x,y);e.preventDefault()});canvas.addEventListener('touchmove',e=>{if(!drawing)return;const{x,y}=getPosition(e);ctx.lineTo(x,y);ctx.stroke();e.preventDefault()});canvas.addEventListener('touchend',()=>{if(drawing){drawing=false;if(canvasId==='signaturePad')signatureData=canvas.toDataURL()}});function getPosition(e){const rect=canvas.getBoundingClientRect(),touch=e.touches?e.touches[0]:e;return{x:touch.clientX-rect.left,y:touch.clientY-rect.top}}}function clearSignature(){const canvas=document.getElementById('signaturePad'),ctx=canvas.getContext('2d');ctx.clearRect(0,0,canvas.width,canvas.height);signatureData=null}async function tapToPayCheckout(){if(!('NDEFReader' in window))return alert('NFC not supported. Use manual entry.');const ndef=new NDEFReader();try{showLoading();await ndef.scan();const controller=new AbortController();ndef.onreading=async event=>{const nfcId=event.serialNumber,paymentToken='cnon:card-nonce-ok';await processPayment(paymentToken);controller.abort()};ndef.onreadingerror=()=>{alert('Failed to read payment card. Try again or use manual entry.');controller.abort();hideLoading()};setTimeout(()=>{controller.abort();if(!controller.signal.aborted){alert('Payment scan timed out.');hideLoading()}},5000);await new Promise(resolve=>controller.signal.addEventListener('abort',resolve))}catch(error){alert(`NFC error: ${error.message}. Use manual entry.`);hideLoading()}}async function processPayment(paymentToken){const headphoneIds=getHeadphoneIds('headphoneIdsList'),name=document.getElementById('name').value,email=document.getElementById('email').value,phone=document.getElementById('phone').value,date=new Date().toISOString().split('T')[0];if(!headphoneIds.length||!name||!email||!phone||!signatureData){hideLoading();return alert('Please complete all fields and sign the agreement!')}const groupId=headphoneIds.length>1?generateGroupId():null;let successfullyCheckedOutIds=[];try{const preauthResponse=await fetch('/.netlify/functions/preauthorize',{method:'POST',headers:{'Content-Type':'application/json'},body:JSON.stringify({sourceId:paymentToken,amount:headphoneIds.length*10000,currency:'USD',locationId:squareLocationId})}),preauthResult=await preauthResponse.json();if(!preauthResponse.ok)throw new Error(preauthResult.error||'Preauthorization failed');const preauthId=preauthResult.paymentId;for(const id of headphoneIds){if(headphones[id]&&headphones[id].status==='checked_out'){alert(`Headphone ID ${id} is already checked out! Skipping.`);continue}const entryMethod=document.getElementById('headphoneId').dataset.entryMethod||'Manual',nfcId=document.getElementById('headphoneId').dataset.nfcId,headphoneData={status:'checked_out',customer:{name,email,phone},agreement:{text:document.getElementById('agreement').value.replace('[Customer Name]',name).replace('[Date]',date).replace('[Headphone IDs]',headphoneIds.join(', ')),signature:signatureData,amount:100,date,timestamp:Date.now()},pre_auth:{pre_auth_id:preauthId,amount:headphoneIds.length*100},entryMethod,nfcId:nfcId||null};if(groupId)headphoneData.groupId=groupId;await saveHeadphone(id,headphoneData);successfullyCheckedOutIds.push(id)}if(successfullyCheckedOutIds.length>0){const headphoneIdsText=successfullyCheckedOutIds.join(', '),agreementText=document.getElementById('agreement').value.replace('[Customer Name]',name).replace('[Date]',date).replace('[Headphone IDs]',headphoneIdsText),emailResponse=await fetch('/.netlify/functions/send-email',{method:'POST',headers:{'Content-Type':'application/json'},body:JSON.stringify({name,email,agreement:agreementText,signature:signatureData,preauthId})});if(!emailResponse.ok)throw new Error('Email failed');alert(`Headphones ${headphoneIdsText} checked out! Agreement emailed to ${email}.`)}else alert('No headphones were checked out due to existing usage.');clearForm('checkout');showDashboard()}catch(error){console.error('Payment error:',error.message);alert('Payment failed: '+error.message)}finally{hideLoading()}}async function checkout(){const headphoneIds=getHeadphoneIds('headphoneIdsList'),name=document.getElementById('name').value,email=document.getElementById('email').value,phone=document.getElementById('phone').value,date=new Date().toISOString().split('T')[0];if(!headphoneIds.length||!name||!email||!phone||!signatureData||!cardElement)return alert('Please complete all fields, enter card details, and sign!');showLoading();try{const result=await cardElement.tokenize();if(result.status!=='OK')throw new Error('Card tokenization failed.');await processPayment(result.token)}catch(error){console.error('Checkout error:',error.message);alert('Checkout failed: '+error.message)}finally{hideLoading()}}async function sendReturnEmail(returnedIds){const customer=headphones[returnedIds[0]].customer||{name:'Customer',email:''},headphoneList=returnedIds.join(', '),emailBody=`Dear ${customer.name||'Customer'},

Thank you for attending our Silent Disco event with SE2 Silent Disco! We hope you had an amazing experience. We're pleased to confirm that we've received the following headphone(s): ${headphoneList}. 

You are no longer responsible for these items, and any associated payment holds have been released. We appreciate your prompt return and hope to see you at future events!

For any questions, contact us at:
- Website: www.se2.events
- Email: se2login@gmail.com

Best regards,
The SE2 Silent Disco Team`,emailPayload={name:customer.name||'Customer',email:customer.email||'',agreement:emailBody,signature:'',preauthId:''},emailResponse=await fetch('/.netlify/functions/send-email',{method:'POST',headers:{'Content-Type':'application/json'},body:JSON.stringify(emailPayload)});if(!emailResponse.ok){const errorText=await emailResponse.text();console.error('Failed to send return email:',errorText);return`Headphone(s) ${returnedIds.join(', ')} returned, but email failed: ${errorText}`}return`Headphone(s) ${returnedIds.join(', ')} returned! Confirmation emailed to ${customer.email||'customer'}.`}async function returnSelectedHeadphones(){const selected=Array.from(document.querySelectorAll('input[name="returnHeadphone"]:checked')).map(input=>input.value);if(!selected.length)return alert('Please select at least one headphone to return!');const groupIds=selected.map(id=>headphones[id].groupId||'Single');if(new Set(groupIds).size>1)return alert('All selected headphones must belong to the same group or all be singles.');try{let returnedIds=[];for(const id of selected){if(!headphones[id]||headphones[id].status!=='checked_out'){alert(`Headphone ${id} not checked out! Skipping.`);continue}await updateHeadphone(id,{status:'returned',pre_auth:null});returnedIds.push(id)}if(returnedIds.length){const message=await sendReturnEmail(returnedIds);alert(message)}else alert('No headphones returned.');updateReturnTable()}catch(error){console.error('Return error:',error.message);alert('Failed to return headphones: '+error.message)}}function showReturnDialogForSelected(){const selected=Array.from(document.querySelectorAll('input[name="checkinHeadphone"]:checked')).map(input=>input.value);if(!selected.length)return alert('Please select at least one headphone to return!');const groupIds=selected.map(id=>headphones[id].groupId||'Single');if(new Set(groupIds).size>1)return alert('All selected headphones must belong to the same group or all be singles.');showManualReturnDialog();const list=document.getElementById('manualReturnList');list.innerHTML='';selected.forEach(id=>{const hp=headphones[id],row=document.createElement('tr');row.innerHTML=`<td><input type="checkbox" name="manualReturnHeadphone" value="${hp.id}" checked></td><td>${hp.id}</td><td>${hp.customer.name}</td><td>${hp.groupId||'Single'}</td>`;list.appendChild(row)})}function closeDialog(type){if(type==='manualReturn')document.getElementById('manualReturnDialog').style.display='none';document.getElementById('dialogOverlay').style.display='none';document.getElementById('nfcDialog').style.display='none';showDashboard()}async function dashboardCharge(id){if(!headphones[id]||headphones[id].status!=='checked_out'||!headphones[id].pre_auth)return alert(`Cannot charge ${id}: Not checked out or no preauthorization.`);const groupId=headphones[id].groupId,headphoneCount=groupId?Object.values(headphones).filter(hp=>hp.groupId===groupId&&hp.status==='checked_out').length:1,chargeAmount=Math.round(headphones[id].pre_auth.amount*100/headphoneCount),chargeAmountDollars=(chargeAmount/100).toFixed(2);if(!confirm(`Charge ${headphones[id].customer.name} $${chargeAmountDollars} for ${id}?`))return;showLoading();try{const chargeResponse=await fetch('/.netlify/functions/capture-payment',{method:'POST',headers:{'Content-Type':'application/json'},body:JSON.stringify({paymentId:headphones[id].pre_auth.pre_auth_id,amount:chargeAmount})}),chargeResult=await chargeResponse.json();if(!chargeResponse.ok)throw new Error(chargeResult.error||'Charge failed');await updateHeadphone(id,{status:'charged',pre_auth:null});alert(`Headphone ${id} charged for $${chargeAmountDollars}!`);updateDashboard()}catch(error){alert(`Charge failed for ${id}: ${error.message}`)}finally{hideLoading()}}function updateDashboard(){const tbody=document.getElementById('headphoneList'),searchTerm=document.getElementById('searchInput').value.toLowerCase(),dateFilter=document.getElementById('dateFilter').value,startDate=document.getElementById('dashboardStartDate').value,endDate=document.getElementById('dashboardEndDate').value||startDate,now=Date.now(),twelveHours=12*60*60*1000,headphoneArray=Object.entries(headphones).map(([id,hp])=>({id,...hp})),checkedOut=headphoneArray.filter(hp=>hp.status==='checked_out'),checkedIn=headphoneArray.filter(hp=>hp.status!=='checked_out');checkedOut.sort((a,b)=>(a.customer?.name||'N/A').localeCompare(b.customer?.name||'N/A'));checkedIn.sort((a,b)=>(a.customer?.name||'N/A').localeCompare(b.customer?.name||'N/A'));const sortedArray=[...checkedOut,...checkedIn];tbody.innerHTML='';let filteredArray=sortedArray;if(startDate){const start=new Date(startDate).setHours(0,0,0,0),end=new Date(endDate).setHours(23,59,59,999);filteredArray=sortedArray.filter(hp=>new Date(hp.agreement?.date).setHours(0,0,0,0)>=start&&new Date(hp.agreement?.date).setHours(0,0,0,0)<=end)}filteredArray.forEach(hp=>{const statusText=hp.status==='checked_out'?'Checked Out':hp.status==='returned'?'Returned':'Charged',overdue=hp.status==='checked_out'&&(now-(hp.agreement?.timestamp||now)>twelveHours),rowData=[hp.customer?.name||'N/A',statusText,hp.pre_auth?'Hold':'Released',hp.customer?.email||'N/A',hp.customer?.phone||'N/A',hp.id,hp.nfcId||'N/A',hp.entryMethod||'N/A',hp.agreement?.date||'N/A',hp.groupId||'Single'];if(rowData.some(data=>data.toLowerCase().includes(searchTerm))&&(!dateFilter||hp.agreement?.date===dateFilter)){const row=document.createElement('tr');let actionsHtml='';if(hp.status==='checked_out')actionsHtml+=`<input type="checkbox" name="checkinHeadphone" value="${hp.id}">`;if(hp.status==='checked_out'&&hp.pre_auth&&overdue)actionsHtml+=`<button class="charge-btn" onclick="dashboardCharge('${hp.id}')">Charge</button>`;row.innerHTML=`<td>${actionsHtml}</td><td>${hp.customer?.name||'N/A'}</td><td>${statusText}</td><td>${hp.pre_auth?'Hold':'Released'}</td><td>${hp.customer?.email||'N/A'}</td><td>${hp.customer?.phone||'N/A'}</td><td>${hp.id}</td><td>${hp.nfcId||'N/A'}</td><td>${hp.entryMethod||'N/A'}</td><td>${hp.groupId||'Single'}</td><td><button class="delete-btn" onclick="deleteHeadphone('${hp.id}')">Delete</button></td>`;tbody.appendChild(row)}})}function updateReturnTable(){const tbody=document.getElementById('returnList'),searchTerm=document.getElementById('returnSearch').value.toLowerCase(),headphoneArray=Object.entries(headphones).filter(([_,hp])=>hp.status==='checked_out').map(([id,hp])=>({id,...hp}));headphoneArray.sort((a,b)=>(a.customer?.name||'N/A').localeCompare(b.customer?.name||'N/A'));tbody.innerHTML='';headphoneArray.forEach(hp=>{const rowData=[hp.customer?.name||'N/A',hp.customer?.email||'N/A',hp.customer?.phone||'N/A',hp.id,hp.nfcId||'N/A',hp.groupId||'Single'];if(rowData.some(data=>data.toLowerCase().includes(searchTerm))){const row=document.createElement('tr');row.innerHTML=`<td><input type="checkbox" name="returnHeadphone" value="${hp.id}"></td><td>${hp.customer?.name||'N/A'}</td><td>${hp.customer?.email||'N/A'}</td><td>${hp.customer?.phone||'N/A'}</td><td>${hp.id}</td><td>${hp.nfcId||'N/A'}</td><td>${hp.groupId||'Single'}</td>`;tbody.appendChild(row)}})}function searchHeadphones(){updateDashboard()}function filterByDate(){updateDashboard()}function clearForm(formId){document.getElementById(formId).querySelectorAll('input').forEach(input=>{input.value='';delete input.dataset.nfcId;delete input.dataset.entryMethod});if(formId==='checkout'){document.getElementById('card-container').innerHTML='';document.getElementById('headphoneIdsList').innerHTML='';checkoutListIds.clear();initializeSquare()}}function filterReport(days){const endDate=new Date(),startDate=new Date();startDate.setDate(endDate.getDate()-days);document.getElementById('reportStartDate').value=startDate.toISOString().split('T')[0];document.getElementById('reportEndDate').value=endDate.toISOString().split('T')[0];generateReport()}function resetFilters(){document.getElementById('reportStartDate').value='';document.getElementById('reportEndDate').value='';document.getElementById('reportSearch').value='';generateReport()}function generateReport(){const reportType=document.getElementById('reportType').value,startDate=document.getElementById('reportStartDate').value,endDate=document.getElementById('reportEndDate').value||startDate,searchTerm=document.getElementById('reportSearch').value.toLowerCase(),chartType=document.getElementById('chartType').value,output=document.getElementById('reportOutput');output.innerHTML='<div id="chartContainer"><canvas id="reportChart"></canvas></div>';if(!reportType){output.innerHTML='<p>Select a report type to view details.</p>';return}const headphoneArray=Object.entries(headphones).map(([id,hp])=>({id,...hp})),now=Date.now(),twelveHours=12*60*60*1000;let filteredArray=headphoneArray;if(startDate){const start=new Date(startDate).setHours(0,0,0,0),end=new Date(endDate).setHours(23,59,59,999);filteredArray=headphoneArray.filter(hp=>new Date(hp.agreement?.date).setHours(0,0,0,0)>=start&&new Date(hp.agreement?.date).setHours(0,0,0,0)<=end)}let finalArray=filteredArray;if(searchTerm)finalArray=filteredArray.filter(hp=>[hp.id,hp.nfcId||'',hp.status,hp.customer?.name||'',hp.customer?.email||'',hp.customer?.phone||'',hp.agreement?.date||'',hp.pre_auth?'Hold':'Released',hp.entryMethod||'N/A',hp.groupId||'Single'].some(data=>data.toLowerCase().includes(searchTerm)));let tableHtml='';switch(reportType){case'allData':tableHtml=`<h3>All Data (${finalArray.length} Headphones)</h3><p>Date Range: ${startDate||'All'} to ${endDate||'All'}</p><table><thead><tr><th>ID</th><th>NFC ID</th><th>Status</th><th>Customer</th><th>Email</th><th>Phone</th><th>Checkout Date</th><th>Preauth Status</th><th>Entry Method</th><th>Group ID</th></tr></thead><tbody>${finalArray.map(hp=>`<tr><td>${hp.id}</td><td>${hp.nfcId||'N/A'}</td><td>${hp.status==='checked_out'?'Checked Out':hp.status==='returned'?'Returned':'Charged'}</td><td>${hp.customer?.name||'N/A'}</td><td>${hp.customer?.email||'N/A'}</td><td>${hp.customer?.phone||'N/A'}</td><td>${hp.agreement?.date||'N/A'}</td><td>${hp.pre_auth?'Hold':'Released'}</td><td>${hp.entryMethod||'N/A'}</td><td>${hp.groupId||'Single'}</td></tr>`).join('')}</tbody></table>`;break;case'checkedOut':const checkedOut=finalArray.filter(hp=>hp.status==='checked_out');tableHtml=`<h3>Currently Checked Out (${checkedOut.length})</h3><p>Date Range: ${startDate||'All'} to ${endDate||'All'}</p><table><thead><tr><th>ID</th><th>NFC ID</th><th>Customer</th><th>Email</th><th>Phone</th><th>Checkout Date</th><th>Entry Method</th><th>Group ID</th></tr></thead><tbody>${checkedOut.map(hp=>`<tr><td>${hp.id}</td><td>${hp.nfcId||'N/A'}</td><td>${hp.customer.name}</td><td>${hp.customer.email}</td><td>${hp.customer.phone}</td><td>${hp.agreement.date}</td><td>${hp.entryMethod||'N/A'}</td><td>${hp.groupId||'Single'}</td></tr>`).join('')}</tbody></table>`;break;case'overdue':const overdue=finalArray.filter(hp=>hp.status==='checked_out'&&(now-hp.agreement.timestamp>twelveHours));tableHtml=`<h3>Overdue Headphones (${overdue.length})</h3><p>Date Range: ${startDate||'All'} to ${endDate||'All'}</p><table><thead><tr><th>ID</th><th>NFC ID</th><th>Customer</th><th>Email</th><th>Phone</th><th>Checkout Date</th><th>Days Overdue</th><th>Entry Method</th><th>Group ID</th></tr></thead><tbody>${overdue.map(hp=>`<tr><td>${hp.id}</td><td>${hp.nfcId||'N/A'}</td><td>${hp.customer.name}</td><td>${hp.customer.email}</td><td>${hp.customer.phone}</td><td>${hp.agreement.date}</td><td>${Math.floor((now-hp.agreement.timestamp)/(1000*60*60*24))}</td><td>${hp.entryMethod||'N/A'}</td><td>${hp.groupId||'Single'}</td></tr>`).join('')}</tbody></table>`;break;case'revenue':const charged=finalArray.filter(hp=>hp.status==='charged');tableHtml=`<h3>Revenue Summary</h3><p>Date Range: ${startDate||'All'} to ${endDate||'All'}</p><p>Total Revenue: $${(charged.length*100).toFixed(2)}</p><table><thead><tr><th>ID</th><th>NFC ID</th><th>Customer</th><th>Email</th><th>Phone</th><th>Charge Date</th><th>Amount</th><th>Entry Method</th><th>Group ID</th></tr></thead><tbody>${charged.map(hp=>`<tr><td>${hp.id}</td><td>${hp.nfcId||'N/A'}</td><td>${hp.customer.name}</td><td>${hp.customer.email}</td><td>${hp.customer.phone}</td><td>${hp.agreement.date}</td><td>$100.00</td><td>${hp.entryMethod||'N/A'}</td><td>${hp.groupId||'Single'}</td></tr>`).join('')}</tbody></table>`;break;case'customerActivity':const customers={};finalArray.forEach(hp=>{const key=`${hp.customer.name}|${hp.customer.email}|${hp.customer.phone}`;if(!customers[key])customers[key]={name:hp.customer.name,email:hp.customer.email,phone:hp.customer.phone,checkouts:0,headphones:[]};customers[key].checkouts++;customers[key].headphones.push(hp.id)});tableHtml=`<h3>Customer Activity</h3><p>Date Range: ${startDate||'All'} to ${endDate||'All'}</p><table><thead><tr><th>Name</th><th>Email</th><th>Phone</th><th>Total Checkouts</th><th>Headphone IDs</th></tr></thead><tbody>${Object.values(customers).map(c=>`<tr><td>${c.name}</td><td>${c.email}</td><td>${c.phone}</td><td>${c.checkouts}</td><td>${c.headphones.join(', ')}</td></tr>`).join('')}</tbody></table>`;break;case'groupSummary':const groups={};finalArray.forEach(hp=>{if(hp.groupId){if(!groups[hp.groupId])groups[hp.groupId]={ids:[],customer:hp.customer,total:0,checkedOut:0,returned:0,charged:0};groups[hp.groupId].ids.push(hp.id);groups[hp.groupId].total++;if(hp.status==='checked_out')groups[hp.groupId].checkedOut++;if(hp.status==='returned')groups[hp.groupId].returned++;if(hp.status==='charged')groups[hp.groupId].charged++}});tableHtml=`<h3>Group Checkout Summary</h3><p>Date Range: ${startDate||'All'} to ${endDate||'All'}</p><table><thead><tr><th>Group ID</th><th>Customer</th><th>Email</th><th>Total Headphones</th><th>Checked Out</th><th>Returned</th><th>Charged</th><th>Headphone IDs</th></tr></thead><tbody>${Object.entries(groups).map(([id,g])=>`<tr><td>${id}</td><td>${g.customer.name}</td><td>${g.customer.email}</td><td>${g.total}</td><td>${g.checkedOut}</td><td>${g.returned}</td><td>${g.charged}</td><td>${g.ids.join(', ')}</td></tr>`).join('')}</tbody></table>`;break;case'nfcUsage':const nfcStats={};finalArray.forEach(hp=>{if(hp.nfcId){if(!nfcStats[hp.nfcId])nfcStats[hp.nfcId]={uses:0,headphoneIds:[],dates:[]};nfcStats[hp.nfcId].uses++;nfcStats[hp.nfcId].headphoneIds.push(hp.id);nfcStats[hp.nfcId].dates.push(hp.agreement.date)}});tableHtml=`<h3>NFC Usage Statistics</h3><p>Date Range: ${startDate||'All'} to ${endDate||'All'}</p><table><thead><tr><th>NFC ID</th><th>Total Uses</th><th>Headphone IDs</th><th>Dates Used</th></tr></thead><tbody>${Object.entries(nfcStats).map(([id,stats])=>`<tr><td>${id}</td><td>${stats.uses}</td><td>${stats.headphoneIds.join(', ')}</td><td>${stats.dates.join(', ')}</td></tr>`).join('')}</tbody></table>`;break;case'dailyCheckouts':const dailyData={};finalArray.filter(hp=>hp.status==='checked_out').forEach(hp=>{const date=hp.agreement.date;dailyData[date]=dailyData[date]?dailyData[date]+1:1});const dates=Object.keys(dailyData).sort(),counts=dates.map(d=>dailyData[d]);tableHtml=`<h3>Daily Checkouts</h3><p>Date Range: ${startDate||'All'} to ${endDate||'All'}</p>`;output.innerHTML=tableHtml+'<div id="chartContainer"><canvas id="reportChart"></canvas></div>';renderChart('reportChart',chartType,dates,counts,'Daily Checkouts');return;case'statusDistribution':const statusData={checked_out:0,returned:0,charged:0};finalArray.forEach(hp=>statusData[hp.status]++);const labels=['Checked Out','Returned','Charged'],values=[statusData.checked_out,statusData.returned,statusData.charged];tableHtml=`<h3>Status Distribution</h3><p>Date Range: ${startDate||'All'} to ${endDate||'All'}</p>`;output.innerHTML=tableHtml+'<div id="chartContainer"><canvas id="reportChart"></canvas></div>';renderChart('reportChart',chartType,labels,values,'Headphone Status');return;default:tableHtml='<p>Invalid report type.</p>'}output.innerHTML=tableHtml;}function renderChart(canvasId,type,labels,data,title){if(chartInstance)chartInstance.destroy();const ctx=document.getElementById(canvasId).getContext('2d');const config={type:type==='pie'?'pie':type==='line'?'line':'bar',data:{labels:labels,datasets:[{label:title,data:data,backgroundColor:type==='pie'?['#6B48FF','#28A745','#FFC107']:'#6B48FF',borderColor:type==='line'?'#6B48FF':'#EDEDED',borderWidth:1,fill:type==='line'?false:undefined}]},options:{responsive:true,maintainAspectRatio:true,scales:type!=='pie'?{y:{beginAtZero:true,title:{display:true,text:'Count',color:'#EDEDED'}},x:{title:{display:true,text:'Date',color:'#EDEDED'}}}:undefined,plugins:{legend:{display:type==='pie',position:'top',labels:{color:'#EDEDED'}}}}};chartInstance=new Chart(ctx,config);}function exportReport(){const reportType=document.getElementById('reportType').value,startDate=document.getElementById('reportStartDate').value,endDate=document.getElementById('reportEndDate').value||startDate;if(!reportType)return alert('Select a report type first!');let filteredArray=Object.entries(headphones).map(([id,hp])=>({id,...hp}));if(startDate){const start=new Date(startDate).setHours(0,0,0,0),end=new Date(endDate).setHours(23,59,59,999);filteredArray=filteredArray.filter(hp=>new Date(hp.agreement?.date).setHours(0,0,0,0)>=start&&new Date(hp.agreement?.date).setHours(0,0,0,0)<=end)}const now=Date.now(),twelveHours=12*60*60*1000;let csvContent='';switch(reportType){case'allData':csvContent='"ID","NFC ID","Status","Customer","Email","Phone","Checkout Date","Preauth Status","Entry Method","Group ID"\n'+filteredArray.map(hp=>`"${hp.id}","${hp.nfcId||'N/A'}","${hp.status==='checked_out'?'Checked Out':hp.status==='returned'?'Returned':'Charged'}","${hp.customer?.name||'N/A'}","${hp.customer?.email||'N/A'}","${hp.customer?.phone||'N/A'}","${hp.agreement?.date||'N/A'}","${hp.pre_auth?'Hold':'Released'}","${hp.entryMethod||'N/A'}","${hp.groupId||'Single'}"`).join('\n');break;case'checkedOut':csvContent='"ID","NFC ID","Customer","Email","Phone","Checkout Date","Entry Method","Group ID"\n'+filteredArray.filter(hp=>hp.status==='checked_out').map(hp=>`"${hp.id}","${hp.nfcId||'N/A'}","${hp.customer.name}","${hp.customer.email}","${hp.customer.phone}","${hp.agreement.date}","${hp.entryMethod||'N/A'}","${hp.groupId||'Single'}"`).join('\n');break;case'overdue':csvContent='"ID","NFC ID","Customer","Email","Phone","Checkout Date","Days Overdue","Entry Method","Group ID"\n'+filteredArray.filter(hp=>hp.status==='checked_out'&&(now-hp.agreement.timestamp>twelveHours)).map(hp=>`"${hp.id}","${hp.nfcId||'N/A'}","${hp.customer.name}","${hp.customer.email}","${hp.customer.phone}","${hp.agreement.date}","${Math.floor((now-hp.agreement.timestamp)/(1000*60*60*24))}","${hp.entryMethod||'N/A'}","${hp.groupId||'Single'}"`).join('\n');break;case'revenue':csvContent='"ID","NFC ID","Customer","Email","Phone","Charge Date","Amount","Entry Method","Group ID"\n'+filteredArray.filter(hp=>hp.status==='charged').map(hp=>`"${hp.id}","${hp.nfcId||'N/A'}","${hp.customer.name}","${hp.customer.email}","${hp.customer.phone}","${hp.agreement.date}","$100.00","${hp.entryMethod||'N/A'}","${hp.groupId||'Single'}"`).join('\n');break;case'customerActivity':const customers={};filteredArray.forEach(hp=>{const key=`${hp.customer.name}|${hp.customer.email}|${hp.customer.phone}`;if(!customers[key])customers[key]={name:hp.customer.name,email:hp.customer.email,phone:hp.customer.phone,checkouts:0,headphones:[]};customers[key].checkouts++;customers[key].headphones.push(hp.id)});csvContent='"Name","Email","Phone","Total Checkouts","Headphone IDs"\n'+Object.values(customers).map(c=>`"${c.name}","${c.email}","${c.phone}","${c.checkouts}","${c.headphones.join(', ')}"`).join('\n');break;case'groupSummary':const groups={};filteredArray.forEach(hp=>{if(hp.groupId){if(!groups[hp.groupId])groups[hp.groupId]={ids:[],customer:hp.customer,total:0,checkedOut:0,returned:0,charged:0};groups[hp.groupId].ids.push(hp.id);groups[hp.groupId].total++;if(hp.status==='checked_out')groups[hp.groupId].checkedOut++;if(hp.status==='returned')groups[hp.groupId].returned++;if(hp.status==='charged')groups[hp.groupId].charged++}});csvContent='"Group ID","Customer","Email","Total Headphones","Checked Out","Returned","Charged","Headphone IDs"\n'+Object.entries(groups).map(([id,g])=>`"${id}","${g.customer.name}","${g.customer.email}","${g.total}","${g.checkedOut}","${g.returned}","${g.charged}","${g.ids.join(', ')}"`).join('\n');break;case'nfcUsage':const nfcStats={};filteredArray.forEach(hp=>{if(hp.nfcId){if(!nfcStats[hp.nfcId])nfcStats[hp.nfcId]={uses:0,headphoneIds:[],dates:[]};nfcStats[hp.nfcId].uses++;nfcStats[hp.nfcId].headphoneIds.push(hp.id);nfcStats[hp.nfcId].dates.push(hp.agreement.date)}});csvContent='"NFC ID","Total Uses","Headphone IDs","Dates Used"\n'+Object.entries(nfcStats).map(([id,stats])=>`"${id}","${stats.uses}","${stats.headphoneIds.join(', ')}","${stats.dates.join(', ')}"`).join('\n');break;case'dailyCheckouts':const dailyData={};filteredArray.filter(hp=>hp.status==='checked_out').forEach(hp=>{const date=hp.agreement.date;dailyData[date]=dailyData[date]?dailyData[date]+1:1});csvContent='"Date","Checkouts"\n'+Object.entries(dailyData).map(([date,count])=>`"${date}","${count}"`).join('\n');break;case'statusDistribution':const statusData={checked_out:0,returned:0,charged:0};filteredArray.forEach(hp=>statusData[hp.status]++);csvContent='"Status","Count"\n'+Object.entries(statusData).map(([status,count])=>`"${status==='checked_out'?'Checked Out':status==='returned'?'Returned':'Charged'}","${count}"`).join('\n');break}const blob=new Blob([csvContent],{type:'text/csv;charset=utf-8;'}),link=document.createElement('a');link.href=URL.createObjectURL(blob);link.download=`${reportType}_report_${startDate||'all'}_${endDate||'all'}.csv`;document.body.appendChild(link);link.click();document.body.removeChild(link)}function makeDraggable(dialogId,headerId){const dialog=document.getElementById(dialogId),header=document.getElementById(headerId);let isDragging=false,currentX=dialog.offsetLeft,currentY=dialog.offsetTop,initialX,initialY;function startDragging(e){isDragging=true;initialX=(e.type==='mousedown'?e.clientX:e.touches[0].clientX)-currentX;initialY=(e.type==='mousedown'?e.clientY:e.touches[0].clientY)-currentY;header.style.cursor='grabbing'}function drag(e){if(!isDragging)return;e.preventDefault();currentX=(e.type==='mousemove'?e.clientX:e.touches[0].clientX)-initialX;currentY=(e.type==='mousemove'?e.clientY:e.touches[0].clientY)-initialY;dialog.style.left=`${currentX}px`;dialog.style.top=`${currentY}px`;dialog.style.transform='none'}function stopDragging(){isDragging=false;header.style.cursor='move'}header.addEventListener('mousedown',startDragging);document.addEventListener('mousemove',drag);document.addEventListener('mouseup',stopDragging);header.addEventListener('touchstart',startDragging);document.addEventListener('touchmove',drag);document.addEventListener('touchend',stopDragging)}function runTests(){console.log('Running unit tests...');try{const id1=generateUniqueHeadphoneId(),id2=generateUniqueHeadphoneId();if(/^HP\d{7}$/.test(id1)&&id1!==id2)console.log('Test Passed: generateUniqueHeadphoneId creates unique IDs in correct format');else console.error('Test Failed: generateUniqueHeadphoneId did not generate unique or correctly formatted IDs')}catch(error){console.error('Test Error: generateUniqueHeadphoneId threw an error:',error)}try{document.getElementById('headphoneIdsList').innerHTML='<li>HP0000001</li>';document.getElementById('name').value='Test User';document.getElementById('email').value='test@example.com';document.getElementById('phone').value='1234567890';signatureData='data:image/png;base64,test';console.log('Test Passed: processPayment setup complete (mocked)')}catch(error){console.error('Test Error: processPayment mock setup failed:',error)}}</script></body></html>
