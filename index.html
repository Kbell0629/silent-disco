<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Silent Disco Tracker</title>
  <script src="https://sandbox.web.squarecdn.com/v1/square.js"></script>
  <!-- Firebase SDK - Trying a different version -->
  <script src="https://www.gstatic.com/firebasejs/10.12.2/firebase-app.js"></script>
  <script src="https://www.gstatic.com/firebasejs/10.12.2/firebase-firestore.js"></script>
  <style>
    body { font-family: Arial, sans-serif; text-align: center; padding: 20px; }
    button { padding: 15px; font-size: 18px; margin: 10px; background-color: #007bff; color: white; border: none; border-radius: 5px; }
    .form { display: none; flex-direction: column; gap: 10px; max-width: 90%; margin: 20px auto; }
    input, textarea { padding: 8px; font-size: 14px; }
    #searchInput, #dateFilter { padding: 10px; width: 80%; max-width: 300px; margin-bottom: 10px; }
    #statusList { text-align: left; }
    #signaturePad { border: 2px solid #000; background: #f0f0f0; width: 250px; height: 120px; margin: 10px auto; }
    #clearSignature { font-size: 14px; padding: 10px; background: #ff4444; }
    #card-container { margin: 10px auto; min-height: 50px; }
    table { width: 100%; border-collapse: collapse; table-layout: auto; }
    th, td { border: 1px solid #ddd; padding: 5px; text-align: left; white-space: nowrap; overflow: hidden; text-overflow: ellipsis; font-size: 12px; }
    th { background-color: #f2f2f2; }
    .checkin-btn { background-color: #28a745; padding: 4px; margin: 1px; font-size: 12px; }
    .checkout-btn { background-color: #dc3545; padding: 4px; margin: 1px; font-size: 12px; }
    .charge-btn { background-color: #ffc107; padding: 4px; margin: 1px; font-size: 12px; }
    #dashboard { overflow-x: auto; }
    .dialog { 
      position: absolute; 
      top: 10%; 
      left: 50%; 
      transform: translateX(-50%); 
      background: white; 
      padding: 15px; 
      border: 2px solid #000; 
      z-index: 1000; 
      display: none; 
      flex-direction: column; 
      gap: 8px; 
      max-width: 90%; 
      max-height: 80vh; 
      overflow-y: auto; 
      border-radius: 5px; 
      box-shadow: 0 4px 8px rgba(0, 0, 0, 0.2); 
    }
    .dialog-header { 
      background: #007bff; 
      color: white; 
      padding: 5px; 
      cursor: move; 
      font-size: 16px; 
      text-align: center; 
      border-radius: 5px 5px 0 0; 
    }
    .dialog-overlay { 
      position: fixed; 
      top: 0; 
      left: 0; 
      width: 100%; 
      height: 100%; 
      background: rgba(0, 0, 0, 0.5); 
      z-index: 999; 
      display: none; 
    }
    #dialogSignaturePad { border: 2px solid #000; background: #f0f0f0; width: 250px; height: 120px; margin: 8px auto; }
    #dialogCardContainer { margin: 8px auto; min-height: 50px; }
  </style>
</head>
<body>
  <h1>Silent Disco Headphone Tracker</h1>
  <button onclick="showCheckout(); vibrate()">Checkout Headphone</button>
  <button onclick="showReturn(); vibrate()">Return Headphone</button>
  <button onclick="showDashboard(); vibrate()">View Dashboard</button>
  <button onclick="scanNFCStatus(); vibrate()">Scan NFC Status</button>

  <div id="checkout" class="form">
    <h2>Checkout</h2>
    <button id="scanCheckout" onclick="scanNFC('checkout'); vibrate()">Scan NFC Tag</button>
    <input id="headphoneId" placeholder="Headphone ID (e.g., HP123)" readonly>
    <input id="name" placeholder="Full Name">
    <input id="email" placeholder="Email">
    <input id="phone" placeholder="Phone Number">
    <textarea id="agreement" readonly rows="12">RENTAL AGREEMENT AND COLLATERAL TERMS

By signing below, I, [Customer Name], agree to rent one (1) pair of wireless headphones from SE2 Silent Disco DBA and SE2 Events Inc. ("the Company") for use during the event on [Date]. I acknowledge that the headphones remain the property of the Company and must be returned in good working condition at the end of the event or upon request.
I understand and agree that failure to return the headphones by the end of the event will result in a replacement fee of $100.00 USD ("Replacement Fee"). I authorize the Company to charge my credit card, provided below, the Replacement Fee if the headphones are not returned or are returned damaged beyond normal wear and tear.
LIABILITY RELEASE: I hereby release, waive, discharge, and agree not to sue SE2 Silent Disco DBA and SE2 Events Inc., its officers, employees, agents, or affiliates ("Released Parties") from any and all liability, claims, demands, actions, or causes of action arising out of or related to any loss, damage, or injury, including death, that may be sustained by me or my property while using the headphones or attending the event, whether caused by the negligence of the Released Parties or otherwise. I assume full responsibility for any risk of bodily injury, death, or property damage arising from my use of the headphones and participation in the event.
MARKETING CONSENT: I grant SE2 Silent Disco DBA and SE2 Events Inc. permission to use my email address and phone number provided herein for marketing purposes, including but not limited to sending promotional offers, event updates, and newsletters. I understand I may opt out of these communications at any time by following the unsubscribe instructions provided in such messages.
PHOTO/VIDEO CONSENT: I consent to being photographed or recorded in video or audio by SE2 Silent Disco DBA and SE2 Events Inc. during the event. I grant the Company full permission to use, reproduce, publish, and distribute such photographs, videos, or recordings, including my likeness, voice, or image, for marketing, advertising, or promotional purposes in any medium, without compensation or further notice to me.
This agreement constitutes a legally binding contract. I acknowledge that I have read and understood these terms, and I sign this agreement voluntarily under no duress. Any disputes arising from this agreement shall be governed by the laws of New York, USA.</textarea>
    <div id="card-container"></div>
    <canvas id="signaturePad" width="250" height="120"></canvas>
    <button id="clearSignature" onclick="clearSignature(); vibrate()">Clear Signature</button>
    <button onclick="checkout(); vibrate()">Complete Checkout</button>
  </div>
  <div id="return" class="form">
    <h2>Return</h2>
    <button id="scanReturn" onclick="scanNFC('return'); vibrate()">Scan NFC Tag</button>
    <input id="returnId" placeholder="Headphone ID" readonly>
    <button onclick="returnHeadphone(); vibrate()">Return</button>
  </div>

  <div id="dashboard" class="form">
    <h2>Dashboard</h2>
    <input id="searchInput" type="text" placeholder="Search headphones..." onkeyup="searchHeadphones()">
    <input id="dateFilter" type="date" onchange="filterByDate()">
    <table id="headphoneTable">
      <thead>
        <tr>
          <th>Actions</th>
          <th>Customer</th>
          <th>Status</th>
          <th>Preauth Status</th>
          <th>Email</th>
          <th>Phone</th>
          <th>ID</th>
        </tr>
      </thead>
      <tbody id="headphoneList"></tbody>
    </table>
  </div>

  <div id="nfcStatus" class="form">
    <h2>NFC Status</h2>
    <p id="nfcStatusResult">Scan an NFC tag to see headphone status.</p>
  </div>

  <!-- Checkout Dialog -->
  <div id="checkoutDialog" class="dialog">
    <div id="checkoutDialogHeader" class="dialog-header">Checkout Headphone</div>
    <button id="dialogScanCheckout" onclick="scanNFC('dialogCheckout'); vibrate()">Scan NFC Tag</button>
    <input id="dialogHeadphoneId" placeholder="Headphone ID (e.g., HP123)" readonly>
    <input id="dialogName" placeholder="Full Name">
    <input id="dialogEmail" placeholder="Email">
    <input id="dialogPhone" placeholder="Phone Number">
    <textarea id="dialogAgreement" readonly rows="10">RENTAL AGREEMENT AND COLLATERAL TERMS

By signing below, I, [Customer Name], agree to rent one (1) pair of wireless headphones from SE2 Silent Disco DBA and SE2 Events Inc. ("the Company") for use during the event on [Date]. I acknowledge that the headphones remain the property of the Company and must be returned in good working condition at the end of the event or upon request.
I understand and agree that failure to return the headphones by the end of the event will result in a replacement fee of $100.00 USD ("Replacement Fee"). I authorize the Company to charge my credit card, provided below, the Replacement Fee if the headphones are not returned or are returned damaged beyond normal wear and tear.
LIABILITY RELEASE: I hereby release, waive, discharge, and agree not to sue SE2 Silent Disco DBA and SE2 Events Inc., its officers, employees, agents, or affiliates ("Released Parties") from any and all liability, claims, demands, actions, or causes of action arising out of or related to any loss, damage, or injury, including death, that may be sustained by me or my property while using the headphones or attending the event, whether caused by the negligence of the Released Parties or otherwise. I assume full responsibility for any risk of bodily injury, death, or property damage arising from my use of the headphones and participation in the event.
MARKETING CONSENT: I grant SE2 Silent Disco DBA and SE2 Events Inc. permission to use my email address and phone number provided herein for marketing purposes, including but not limited to sending promotional offers, event updates, and newsletters. I understand I may opt out of these communications at any time by following the unsubscribe instructions provided in such messages.
PHOTO/VIDEO CONSENT: I consent to being photographed or recorded in video or audio by SE2 Silent Disco DBA and SE2 Events Inc. during the event. I grant the Company full permission to use, reproduce, publish, and distribute such photographs, videos, or recordings, including my likeness, voice, or image, for marketing, advertising, or promotional purposes in any medium, without compensation or further notice to me.
This agreement constitutes a legally binding contract. I acknowledge that I have read and understood these terms, and I sign this agreement voluntarily under no duress. Any disputes arising from this agreement shall be governed by the laws of New York, USA.</textarea>
    <div id="dialogCardContainer"></div>
    <canvas id="dialogSignaturePad" width="250" height="120"></canvas>
    <button onclick="clearDialogSignature(); vibrate()">Clear Signature</button>
    <button onclick="submitCheckoutDialog(); vibrate()">Complete Checkout</button>
    <button onclick="closeDialog('checkout'); vibrate()">Cancel</button>
  </div>

  <!-- Return Dialog -->
  <div id="returnDialog" class="dialog">
    <div id="returnDialogHeader" class="dialog-header">Return Headphone</div>
    <button id="dialogScanReturn" onclick="scanNFC('dialogReturn'); vibrate()">Scan NFC Tag</button>
    <input id="dialogReturnId" placeholder="Headphone ID" readonly>
    <button onclick="submitReturnDialog(); vibrate()">Return</button>
    <button onclick="closeDialog('return'); vibrate()">Cancel</button>
  </div>

  <div id="dialogOverlay" class="dialog-overlay" onclick="closeDialog(null); vibrate()"></div>

  <script>
    const squareAppId = 'sandbox-sq0idb-qaDoxfFQK3OfUWlaCrgkDw';
    let headphones = {};
    let signatureData = null;
    let dialogSignatureData = null;
    let payments;
    let cardElement;
    let dialogCardElement;
    let db;
    let headphonesCollection;
    let isFirebaseInitialized = false;

    // Your Firebase Configuration
    const firebaseConfig = {
      apiKey: "AIzaSyAjHcOfj2LkeRkFi_RKAd9umJ80a8ujBPM",
      authDomain: "silentdiscotracker.firebaseapp.com",
      projectId: "silentdiscotracker",
      storageBucket: "silentdiscotracker.firebasestorage.app",
      messagingSenderId: "527385130136",
      appId: "1:527385130136:web:2eb9c37ede5a942a1ccced"
    };

    // Wait for Firebase to load and initialize
    async function waitForFirebase() {
      return new Promise((resolve, reject) => {
        const maxAttempts = 100; // ~10 seconds timeout
        let attempts = 0;
        console.log('Waiting for Firebase SDK to load...');
        const checkFirebase = setInterval(() => {
          attempts++;
          if (typeof firebase !== 'undefined' && firebase.app && firebase.firestore) {
            clearInterval(checkFirebase);
            try {
              firebase.initializeApp(firebaseConfig);
              db = firebase.firestore();
              headphonesCollection = db.collection('headphones');
              isFirebaseInitialized = true;
              console.log('Firebase initialized successfully after', attempts, 'attempts');
              resolve();
            } catch (error) {
              console.error('Firebase initialization failed:', error);
              clearInterval(checkFirebase);
              reject(error);
            }
          } else if (attempts >= maxAttempts) {
            clearInterval(checkFirebase);
            console.error('Firebase SDK failed to load after', attempts, 'attempts');
            alert('Firebase failed to load. Proceeding without database sync.');
            isFirebaseInitialized = false; // Allow app to proceed without Firebase
            resolve(); // Resolve anyway to continue with Square
          }
        }, 100);
      });
    }

    // Firebase Functions
    async function loadHeadphones() {
      if (!isFirebaseInitialized) {
        console.warn('Firebase not initialized, returning local headphones');
        return headphones;
      }
      try {
        const snapshot = await headphonesCollection.get();
        headphones = {};
        snapshot.forEach(doc => {
          headphones[doc.id] = doc.data();
        });
        console.log('Headphones loaded from Firebase:', headphones);
        return headphones;
      } catch (error) {
        console.error('Error loading headphones:', error);
        alert('Failed to load data from Firebase.');
        return headphones;
      }
    }

    async function saveHeadphone(id, data) {
      if (!isFirebaseInitialized || !headphonesCollection) {
        console.warn('Firebase not initialized, saving locally only');
        headphones[id] = data;
        return;
      }
      try {
        await headphonesCollection.doc(id).set(data);
        headphones[id] = data;
        console.log('Saved headphone to Firebase:', id, data);
      } catch (error) {
        console.error('Error saving headphone:', error);
        alert('Failed to save to Firebase: ' + error.message);
        throw error;
      }
    }

    async function updateHeadphone(id, data) {
      if (!isFirebaseInitialized || !headphonesCollection) {
        console.warn('Firebase not initialized, updating locally only');
        headphones[id] = { ...headphones[id], ...data };
        return;
      }
      try {
        await headphonesCollection.doc(id).update(data);
        headphones[id] = { ...headphones[id], ...data };
        console.log('Updated headphone in Firebase:', id, data);
      } catch (error) {
        console.error('Error updating headphone:', error);
        alert('Failed to update Firebase: ' + error.message);
        throw error;
      }
    }

    async function initializeSquare() {
      if (!window.Square) {
        console.error('Square SDK not loaded');
        return;
      }
      if (!payments) {
        payments = window.Square.payments(squareAppId);
      }
      const cardContainer = document.getElementById('card-container');
      cardContainer.innerHTML = '';
      cardElement = await payments.card();
      await cardElement.attach('#card-container');
      console.log('Square card field initialized');
      return cardElement;
    }

    // Initialize everything on load
    window.onload = async () => {
      try {
        await waitForFirebase(); // Wait for Firebase to load and initialize
        await initializeSquare();
        await loadHeadphones();
        makeDraggable('checkoutDialog', 'checkoutDialogHeader');
        makeDraggable('returnDialog', 'returnDialogHeader');
        console.log('App initialization complete');
      } catch (error) {
        console.error('Error during initialization:', error);
        alert('Failed to initialize app: ' + error.message);
      }
    };

    function vibrate() {
      if ('vibrate' in navigator) navigator.vibrate(100);
    }

    async function showCheckout() {
      toggleForms('checkout');
      initSignaturePad('signaturePad');
      await initializeSquare();
    }

    function showReturn() { 
      toggleForms('return'); 
    }

    async function showDashboard() {
      toggleForms('dashboard');
      await loadHeadphones();
      updateDashboard();
    }

    async function scanNFCStatus() {
      toggleForms('nfcStatus');
      const resultElement = document.getElementById('nfcStatusResult');
      resultElement.textContent = 'Scanning...';

      if ('NDEFReader' in window) {
        const ndef = new NDEFReader();
        try {
          await ndef.scan();
          const controller = new AbortController();
          ndef.onreading = event => {
            const id = event.serialNumber || prompt('Enter headphone ID manually:');
            if (id && headphones[id]) {
              const hp = headphones[id];
              resultElement.innerHTML = `
                <strong>ID:</strong> ${id}<br>
                <strong>Status:</strong> ${hp.status === 'checked_out' ? 'Checked Out' : hp.status === 'returned' ? 'Returned' : 'Charged'}<br>
                <strong>Customer:</strong> ${hp.customer.name}<br>
                <strong>Email:</strong> ${hp.customer.email}<br>
                <strong>Phone:</strong> ${hp.customer.phone}<br>
                <strong>Preauth Status:</strong> ${hp.pre_auth ? 'Hold' : 'Released'}<br>
                <strong>Date:</strong> ${hp.agreement.date || 'N/A'}
              `;
            } else {
              resultElement.textContent = `Headphone ${id} not found.`;
            }
            controller.abort();
          };
          ndef.onreadingerror = () => {
            resultElement.textContent = 'NFC scan failed. Try again.';
            controller.abort();
          };
          setTimeout(() => {
            controller.abort();
            if (resultElement.textContent === 'Scanning...') {
              resultElement.textContent = 'Scan timed out.';
            }
          }, 5000);
          await new Promise((resolve) => {
            controller.signal.addEventListener('abort', resolve);
          });
        } catch (error) {
          resultElement.textContent = `Error: ${error.message}`;
        }
      } else {
        resultElement.textContent = 'NFC not supported.';
      }
    }

    function toggleForms(active) {
      ['checkout', 'return', 'dashboard', 'nfcStatus'].forEach(id => {
        document.getElementById(id).style.display = id === active ? 'flex' : 'none';
      });
      document.getElementById('checkoutDialog').style.display = 'none';
      document.getElementById('returnDialog').style.display = 'none';
      document.getElementById('dialogOverlay').style.display = 'none';
    }

    async function scanNFC(context) {
      const button = document.getElementById(context === 'checkout' ? 'scanCheckout' : context === 'return' ? 'scanReturn' : context === 'dialogCheckout' ? 'dialogScanCheckout' : 'dialogScanReturn');
      const input = document.getElementById(context === 'checkout' ? 'headphoneId' : context === 'return' ? 'returnId' : context === 'dialogCheckout' ? 'dialogHeadphoneId' : 'dialogReturnId');
      button.disabled = true;
      if ('NDEFReader' in window) {
        const ndef = new NDEFReader();
        try {
          await ndef.scan();
          const controller = new AbortController();
          ndef.onreading = event => {
            const id = event.serialNumber || `HP${Date.now()}`;
            input.value = id;
            alert(`Scanned headphone: ${id}`);
            controller.abort();
            button.disabled = false;
          };
          ndef.onreadingerror = () => {
            alert('No NFC tag detected. Try again or enter manually.');
            manualEntry(context);
            controller.abort();
            button.disabled = false;
          };
          setTimeout(() => {
            controller.abort();
            if (!button.disabled) return;
            alert('Scan timed out. Try again or enter manually.');
            manualEntry(context);
            button.disabled = false;
          }, 5000);
          await new Promise((resolve) => {
            controller.signal.addEventListener('abort', resolve);
          });
        } catch (error) {
          alert(`NFC error: ${error.message}. Enter ID manually.`);
          manualEntry(context);
          button.disabled = false;
        }
      } else {
        alert('NFC not supported. Enter ID manually.');
        manualEntry(context);
        button.disabled = false;
      }
    }

    function manualEntry(context) {
      const id = prompt('Enter headphone ID (e.g., HP123):');
      const input = document.getElementById(context === 'checkout' ? 'headphoneId' : context === 'return' ? 'returnId' : context === 'dialogCheckout' ? 'dialogHeadphoneId' : 'dialogReturnId');
      const button = document.getElementById(context === 'checkout' ? 'scanCheckout' : context === 'return' ? 'scanReturn' : context === 'dialogCheckout' ? 'dialogScanCheckout' : 'dialogScanReturn');
      if (id) input.value = id;
      button.disabled = false;
    }

    function initSignaturePad(canvasId) {
      const canvas = document.getElementById(canvasId);
      const ctx = canvas.getContext('2d');
      let drawing = false;

      ctx.lineWidth = 2;
      ctx.lineCap = 'round';
      ctx.strokeStyle = '#000';

      canvas.addEventListener('mousedown', startDrawing);
      canvas.addEventListener('mousemove', draw);
      canvas.addEventListener('mouseup', stopDrawing);
      canvas.addEventListener('touchstart', startDrawing);
      canvas.addEventListener('touchmove', draw);
      canvas.addEventListener('touchend', stopDrawing);

      function startDrawing(e) {
        drawing = true;
        ctx.beginPath();
        const { x, y } = getPosition(e);
        ctx.moveTo(x, y);
        e.preventDefault();
      }

      function draw(e) {
        if (!drawing) return;
        const { x, y } = getPosition(e);
        ctx.lineTo(x, y);
        ctx.stroke();
        e.preventDefault();
      }

      function stopDrawing() {
        if (drawing) {
          drawing = false;
          if (canvasId === 'signaturePad') {
            signatureData = canvas.toDataURL();
          } else {
            dialogSignatureData = canvas.toDataURL();
          }
        }
      }

      function getPosition(e) {
        const rect = canvas.getBoundingClientRect();
        const touch = e.touches ? e.touches[0] : e;
        return {
          x: touch.clientX - rect.left,
          y: touch.clientY - rect.top
        };
      }
    }

    function clearSignature() {
      const canvas = document.getElementById('signaturePad');
      const ctx = canvas.getContext('2d');
      ctx.clearRect(0, 0, canvas.width, canvas.height);
      signatureData = null;
    }

    function clearDialogSignature() {
      const canvas = document.getElementById('dialogSignaturePad');
      const ctx = canvas.getContext('2d');
      ctx.clearRect(0, 0, canvas.width, canvas.height);
      dialogSignatureData = null;
    }

    async function checkout() {
      const id = document.getElementById('headphoneId').value;
      const name = document.getElementById('name').value;
      const email = document.getElementById('email').value;
      const phone = document.getElementById('phone').value;
      const date = new Date().toISOString().split('T')[0];

      if (!id || !name || !email || !phone || !signatureData || !cardElement) {
        alert('Please fill all fields, enter card details, and sign the agreement!');
        return;
      }

      const agreementText = document.getElementById('agreement').value
        .replace('[Customer Name]', name)
        .replace('[Date]', date);

      if (headphones[id] && headphones[id].status === 'checked_out') {
        alert('This headphone is already checked out!');
        return;
      }

      try {
        console.log('Starting card tokenization...');
        const result = await cardElement.tokenize();
        console.log('Tokenization result:', result);
        if (result.status !== 'OK') throw new Error('Card tokenization failed: ' + (result.errors?.[0]?.message || 'Unknown error'));
        const paymentToken = result.token;
        console.log('Payment token:', paymentToken);

        console.log('Sending preauthorization request...');
        const preauthResponse = await fetch('/.netlify/functions/preauthorize', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({
            sourceId: paymentToken,
            amount: 10000,
            currency: 'USD',
            locationId: 'LQ7MAQD7N37E5'
          })
        });

        const preauthResult = await preauthResponse.json();
        console.log('Preauthorization response:', preauthResult);
        if (!preauthResponse.ok) throw new Error(preauthResult.error || 'Preauthorization failed');
        const preauthId = preauthResult.paymentId;

        const headphoneData = {
          status: 'checked_out',
          customer: { name, email, phone },
          agreement: { text: agreementText, signature: signatureData, amount: 100, date: date, timestamp: Date.now() },
          pre_auth: { pre_auth_id: preauthId, amount: 100 }
        };

        await saveHeadphone(id, headphoneData);

        console.log('Sending email...');
        const emailResponse = await fetch('/.netlify/functions/send-email', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({
            name: name,
            email: email,
            agreement: agreementText,
            signature: signatureData,
            preauthId: preauthId
          })
        });

        if (emailResponse.ok) {
          alert(`Headphone ${id} checked out! Agreement emailed to ${email}. Preauthorization completed.`);
          clearForm('checkout');
          showDashboard();
        } else {
          throw new Error('Email failed');
        }
      } catch (error) {
        console.error('Checkout error:', error.message);
        alert('Checkout failed: ' + error.message);
      }
    }

    async function returnHeadphone() {
      const id = document.getElementById('returnId').value;
      if (!id) {
        alert('Please scan a headphone!');
        return;
      }
      if (headphones[id] && headphones[id].status === 'checked_out') {
        const updatedData = {
          status: 'returned',
          pre_auth: null
        };
        await updateHeadphone(id, updatedData);
        alert(`Headphone ${id} returned!`);
        clearForm('return');
        showDashboard();
      } else {
        alert('Headphone not found or not checked out!');
      }
    }

    async function showCheckoutDialog(id) {
      document.getElementById('dialogHeadphoneId').value = id;
      document.getElementById('dialogName').value = '';
      document.getElementById('dialogEmail').value = '';
      document.getElementById('dialogPhone').value = '';
      clearDialogSignature();
      document.getElementById('checkoutDialog').style.display = 'flex';
      document.getElementById('dialogOverlay').style.display = 'block';
      initSignaturePad('dialogSignaturePad');
      await initDialogCard();
    }

    async function initDialogCard() {
      if (!window.Square) {
        console.error('Square SDK not loaded');
        return;
      }
      if (!payments) {
        payments = window.Square.payments(squareAppId);
      }
      const dialogCardContainer = document.getElementById('dialogCardContainer');
      dialogCardContainer.innerHTML = '';
      dialogCardElement = await payments.card();
      await dialogCardElement.attach('#dialogCardContainer');
    }

    function showReturnDialog(id) {
      document.getElementById('dialogReturnId').value = id;
      document.getElementById('returnDialog').style.display = 'flex';
      document.getElementById('dialogOverlay').style.display = 'block';
    }

    function closeDialog(type) {
      if (type === 'checkout') {
        document.getElementById('checkoutDialog').style.display = 'none';
      } else if (type === 'return') {
        document.getElementById('returnDialog').style.display = 'none';
      }
      document.getElementById('dialogOverlay').style.display = 'none';
      showDashboard();
    }

    async function submitCheckoutDialog() {
      const id = document.getElementById('dialogHeadphoneId').value;
      const name = document.getElementById('dialogName').value;
      const email = document.getElementById('dialogEmail').value;
      const phone = document.getElementById('dialogPhone').value;
      const date = new Date().toISOString().split('T')[0];

      if (!id || !name || !email || !phone || !dialogSignatureData || !dialogCardElement) {
        alert('Please fill all fields, enter card details, and sign the agreement!');
        return;
      }

      const agreementText = document.getElementById('dialogAgreement').value
        .replace('[Customer Name]', name)
        .replace('[Date]', date);

      if (headphones[id] && headphones[id].status === 'checked_out') {
        alert('This headphone is already checked out!');
        return;
      }

      try {
        console.log('Starting dialog card tokenization...');
        const result = await dialogCardElement.tokenize();
        console.log('Tokenization result:', result);
        if (result.status !== 'OK') throw new Error('Card tokenization failed: ' + (result.errors?.[0]?.message || 'Unknown error'));
        const paymentToken = result.token;
        console.log('Payment token:', paymentToken);

        console.log('Sending preauthorization request...');
        const preauthResponse = await fetch('/.netlify/functions/preauthorize', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({
            sourceId: paymentToken,
            amount: 10000,
            currency: 'USD',
            locationId: 'LQ7MAQD7N37E5'
          })
        });

        const preauthResult = await preauthResponse.json();
        console.log('Preauthorization response:', preauthResult);
        if (!preauthResponse.ok) throw new Error(preauthResult.error || 'Preauthorization failed');
        const preauthId = preauthResult.paymentId;

        const headphoneData = {
          status: 'checked_out',
          customer: { name, email, phone },
          agreement: { text: agreementText, signature: dialogSignatureData, amount: 100, date: date, timestamp: Date.now() },
          pre_auth: { pre_auth_id: preauthId, amount: 100 }
        };

        await saveHeadphone(id, headphoneData);

        console.log('Sending email...');
        const emailResponse = await fetch('/.netlify/functions/send-email', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({
            name: name,
            email: email,
            agreement: agreementText,
            signature: dialogSignatureData,
            preauthId: preauthId
          })
        });

        if (emailResponse.ok) {
          alert(`Headphone ${id} checked out! Agreement emailed to ${email}. Preauthorization completed.`);
          closeDialog('checkout');
        } else {
          throw new Error('Email failed');
        }
      } catch (error) {
        console.error('Checkout error:', error.message);
        alert('Checkout failed: ' + error.message);
      }
    }

    async function submitReturnDialog() {
      const id = document.getElementById('dialogReturnId').value;
      if (!id) {
        alert('Please scan or enter a headphone ID!');
        return;
      }
      if (headphones[id] && headphones[id].status === 'checked_out') {
        const updatedData = {
          status: 'returned',
          pre_auth: null
        };
        await updateHeadphone(id, updatedData);
        alert(`Headphone ${id} returned!`);
        closeDialog('return');
      } else {
        alert('Headphone not found or not checked out!');
      }
    }

    async function dashboardCharge(id) {
      if (headphones[id] && headphones[id].status === 'checked_out' && headphones[id].pre_auth) {
        const confirmCharge = confirm(`Are you sure ${headphones[id].customer.name} did not return headphone ${id}? This will charge their card $100.`);
        if (confirmCharge) {
          try {
            const chargeResponse = await fetch('/.netlify/functions/capture-payment', {
              method: 'POST',
              headers: { 'Content-Type': 'application/json' },
              body: JSON.stringify({
                paymentId: headphones[id].pre_auth.pre_auth_id,
                amount: headphones[id].pre_auth.amount
              })
            });
            const chargeResult = await chargeResponse.json();
            if (!chargeResponse.ok) throw new Error(chargeResult.error || 'Charge failed');
            
            const updatedData = {
              status: 'charged',
              pre_auth: null
            };
            await updateHeadphone(id, updatedData);
            
            alert(`Headphone ${id} charged successfully!`);
            updateDashboard();
          } catch (error) {
            alert(`Charge failed for ${id}: ${error.message}`);
          }
        }
      } else {
        alert(`Cannot charge for ${id}: Not checked out or no preauthorization available.`);
      }
    }

    function updateDashboard() {
      const tbody = document.getElementById('headphoneList');
      const searchTerm = document.getElementById('searchInput').value.toLowerCase();
      const dateFilter = document.getElementById('dateFilter').value;
      const now = Date.now();
      const twelveHours = 12 * 60 * 60 * 1000;
      tbody.innerHTML = '';
      Object.keys(headphones).forEach(id => {
        const hp = headphones[id];
        const statusText = hp.status === 'checked_out' ? 'Checked Out' : hp.status === 'returned' ? 'Returned' : 'Charged';
        const checkoutTime = hp.agreement?.timestamp || now;
        const overdue = hp.status === 'checked_out' && (now - checkoutTime > twelveHours);
        const rowData = [
          hp.customer?.name || 'N/A',
          statusText,
          hp.pre_auth ? 'Hold' : 'Released',
          hp.customer?.email || 'N/A',
          hp.customer?.phone || 'N/A',
          id,
          hp.agreement?.date || 'N/A'
        ];
        if (
          rowData.some(data => data.toLowerCase().includes(searchTerm)) &&
          (!dateFilter || hp.agreement?.date === dateFilter)
        ) {
          const row = document.createElement('tr');
          let actionsHtml = '';
          if (hp.status !== 'checked_out') {
            actionsHtml += `<button class="checkout-btn" onclick="showCheckoutDialog('${id}')">Check Out</button>`;
          }
          if (hp.status === 'checked_out') {
            actionsHtml += `<button class="checkin-btn" onclick="showReturnDialog('${id}')">Check In</button>`;
          }
          if (hp.status === 'checked_out' && hp.pre_auth && overdue) {
            actionsHtml += `<button class="charge-btn" onclick="dashboardCharge('${id}')">Charge</button>`;
          }
          row.innerHTML = `
            <td>${actionsHtml}</td>
            <td>${hp.customer?.name || 'N/A'}</td>
            <td>${statusText}</td>
            <td>${hp.pre_auth ? 'Hold' : 'Released'}</td>
            <td>${hp.customer?.email || 'N/A'}</td>
            <td>${hp.customer?.phone || 'N/A'}</td>
            <td>${id}</td>
          `;
          tbody.appendChild(row);
        }
      });
    }

    function searchHeadphones() {
      updateDashboard();
    }

    function filterByDate() {
      updateDashboard();
    }

    function clearForm(formId) {
      document.getElementById(formId).querySelectorAll('input').forEach(input => input.value = '');
      if (formId === 'checkout') {
        document.getElementById('card-container').innerHTML = '';
        initializeSquare();
      }
    }

    function makeDraggable(dialogId, headerId) {
      const dialog = document.getElementById(dialogId);
      const header = document.getElementById(headerId);
      let isDragging = false;
      let currentX;
      let currentY;
      let initialX;
      let initialY;

      header.addEventListener('mousedown', startDragging);
      document.addEventListener('mousemove', drag);
      document.addEventListener('mouseup', stopDragging);
      header.addEventListener('touchstart', startDragging);
      document.addEventListener('touchmove', drag);
      document.addEventListener('touchend', stopDragging);

      function startDragging(e) {
        isDragging = true;
        if (e.type === 'mousedown') {
          initialX = e.clientX - currentX;
          initialY = e.clientY - currentY;
        } else {
          initialX = e.touches[0].clientX - currentX;
          initialY = e.touches[0].clientY - currentY;
        }
        header.style.cursor = 'grabbing';
      }

      function drag(e) {
        if (isDragging) {
          e.preventDefault();
          let x, y;
          if (e.type === 'mousemove') {
            x = e.clientX - initialX;
            y = e.clientY - initialY;
          } else {
            x = e.touches[0].clientX - initialX;
            y = e.touches[0].clientY - initialY;
          }
          currentX = x;
          currentY = y;
          dialog.style.left = `${x}px`;
          dialog.style.top = `${y}px`;
          dialog.style.transform = 'none';
        }
      }

      function stopDragging() {
        isDragging = false;
        header.style.cursor = 'move';
      }

      currentX = dialog.offsetLeft;
      currentY = dialog.offsetTop;
    }
  </script>
</body>
</html>
