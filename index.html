<!DOCTYPE html><html lang="en"><head><meta charset="UTF-8"><meta name="viewport" content="width=device-width,initial-scale=1.0"><title>SE2 Silent Disco Tracker</title><script src="https://sandbox.web.squarecdn.com/v1/square.js"></script><script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-app-compat.js"></script><script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-firestore-compat.js"></script><script src="https://cdn.jsdelivr.net/npm/chart.js"></script><link href="https://fonts.googleapis.com/css2?family=Poppins:wght@400;600;700&display=swap" rel="stylesheet"></head><body><div class="container"><header><img src="https://encrypted-tbn0.gstatic.com/images?q=tbn:ANd8GcSWBhKlwtFnBvx5elx7r_rqfffG3tFbfcg3OA&s" alt="SE2 Silent Disco Logo"><h1>SE2 Silent Disco Tracker</h1></header><div class="button-group"><button onclick="sc();v()">Checkout - Handout Headphones</button><button onclick="sr();v()">Check In - Return Headphones</button><button onclick="sd();v()">View Dashboard</button><button onclick="srs();v()">View Reports</button><button onclick="sn();v()">Scan NFC Status</button></div><div id="checkout" class="form"><h2>Checkout Headphones</h2><button id="scanCheckout" onclick="sfc();v()">Scan NFC Tag</button><label for="headphoneId">Headphone ID</label><input id="headphoneId" placeholder="Headphone ID (e.g., HP0000001)" readonly onclick="me();v()"><button onclick="ah();v()">Add Headphone ID</button><ul id="headphoneIdsList"></ul><label for="name">Full Name</label><input id="name" placeholder="Full Name"><label for="email">Email</label><input id="email" placeholder="Email"><label for="phone">Phone Number</label><input id="phone" placeholder="Phone Number"><label for="agreement">Rental Agreement</label><textarea id="agreement" readonly>RENTAL AGREEMENT AND COLLATERAL TERMS

By signing below, I, [Customer Name], agree to rent the following wireless headphones ([Headphone IDs]) from SE2 Silent Disco DBA and SE2 Events Inc. ("the Company") for use during the event on [Date]. I acknowledge that the headphones remain the property of the Company and must be returned in good working condition at the end of the event or upon request.

I understand and agree that failure to return any headphone by the end of the event will result in a replacement fee of $100.00 USD per headphone ("Replacement Fee"). I authorize the Company to charge my credit card, provided below, the Replacement Fee for each headphone not returned or returned damaged beyond normal wear and tear.

LIABILITY RELEASE: I hereby release, waive, discharge, and agree not to sue SE2 Silent Disco DBA and SE2 Events Inc., its officers, employees, agents, or affiliates ("Released Parties") from any and all liability, claims, demands, actions, or causes of action arising out of or related to any loss, damage, or injury, including death, that may be sustained by me or my property while using the headphones or attending the event, whether caused by the negligence of the Released Parties or otherwise. I assume full responsibility for any risk of bodily injury, death, or property damage arising from my use of the headphones and participation in the event.

MARKETING CONSENT: I grant SE2 Silent Disco DBA and SE2 Events Inc. permission to use my email address and phone number provided herein for marketing purposes, including but not limited to sending promotional offers, event updates, and newsletters. I understand I may opt out of these communications at any time by following the unsubscribe instructions provided in such messages.

PHOTO/VIDEO CONSENT: I consent to being photographed or recorded in video or audio by SE2 Silent Disco DBA and SE2 Events Inc. during the event. I grant the Company full permission to use, reproduce, publish, and distribute such photographs, videos, or recordings, including my likeness, voice, or image, for marketing, advertising, or promotional purposes in any medium, without compensation or further notice to me.

PERSONAL DATA CONSENT: I consent to the Company collecting, processing, and storing my personal data (including my full name, email address, phone number, and payment information) as necessary to facilitate this rental agreement, process payments, and manage event-related services. The Company may use this data to contact me regarding this rental, future events, or promotional offers, and to comply with legal obligations. I understand that my data will be stored securely and retained only as long as necessary for these purposes or as required by law. I have the right to request access to, correction of, or deletion of my personal data by contacting the Company at se2login@gmail.com, subject to applicable legal requirements. For more details, I may refer to the Companyâ€™s Privacy Policy at www.se2.events/privacy.

This agreement constitutes a legally binding contract. I acknowledge that I have read and understood these terms, and I sign this agreement voluntarily under no duress. Any disputes arising from this agreement shall be governed by the laws of New York, USA.</textarea><div id="paymentOptions"><button id="tapToPay" onclick="tpc();v()">Tap Card to Checkout</button><p>OR</p><div id="card-container"></div></div><canvas id="signaturePad" width="300" height="150"></canvas><button id="clearSignature" onclick="cs();v()">Clear Signature</button><button id="checkoutButton" onclick="co();v()">Complete Checkout</button></div><div id="return" class="form"><h2>Return Headphones</h2><label for="returnSearch">Search Headphones</label><input id="returnSearch" type="text" placeholder="Search headphones..." onkeyup="ur()"><div class="return-actions"><button id="scanReturn" onclick="sfr();v()">Scan NFC</button><button onclick="rsh();v()">Return Selected</button></div><div class="return-table-wrapper"><table id="returnTable"><thead><tr><th>Select</th><th>Customer</th><th>Email</th><th>Phone</th><th>ID</th><th>NFC ID</th><th>Group ID</th></tr></thead><tbody id="returnList"></tbody></table></div></div><div id="dashboard" class="form"><h2>Dashboard</h2><label for="searchInput">Search Headphones</label><input id="searchInput" type="text" placeholder="Search headphones..." onkeyup="ud()"><label for="dateFilter">Filter by Date</label><input id="dateFilter" type="date" onchange="ud()"><label for="dashboardStartDate">Start Date</label><input id="dashboardStartDate" type="date" onchange="ud()" placeholder="Start Date"><label for="dashboardEndDate">End Date</label><input id="dashboardEndDate" type="date" onchange="ud()" placeholder="End Date"><div class="dashboard-actions"><button onclick="srd();v()">Return Selected</button><button id="scanDashboardNFC" onclick="sfd();v()">Scan NFC</button></div><div class="dashboard-table-wrapper"><table id="headphoneTable"><thead><tr><th>Check In</th><th>Charge</th><th>Customer</th><th>Status</th><th>Preauth Status</th><th>Email</th><th>Phone</th><th>ID</th><th>NFC ID</th><th>Entry Method</th><th>Group ID</th><th>Delete</th></tr></thead><tbody id="headphoneList"></tbody></table></div></div><div id="reports" class="form"><h2>Reports</h2><div id="reportControls"><div><label for="reportType">Report Type:</label><select id="reportType" onchange="gr()"><option value="">Select a Report</option><option value="allData">All Data</option><option value="checkedOut">Currently Checked Out</option><option value="overdue">Overdue Headphones</option><option value="revenue">Revenue Summary</option><option value="customerActivity">Customer Activity</option><option value="groupSummary">Group Checkout Summary</option><option value="nfcUsage">NFC Usage Statistics</option><option value="dailyCheckouts">Daily Checkouts</option><option value="statusDistribution">Status Distribution</option></select></div><div id="reportFilters"><label>Date Range:</label><button onclick="fr(7)">Last 7 Days</button><button onclick="fr(30)">Last 30 Days</button><button onclick="rf()">Reset</button></div><div><label for="reportSearch">Search:</label><input id="reportSearch" type="text" placeholder="Search reports..." onkeyup="gr()"></div><div><label for="chartType">Chart Style:</label><select id="chartType" onchange="gr()"><option value="bar">Bar</option><option value="line">Line</option><option value="pie">Pie</option></select></div><div><button onclick="er()">Export as CSV</button></div></div><label for="reportStartDate">Start Date</label><input id="reportStartDate" type="date" onchange="gr()" placeholder="Start Date"><label for="reportEndDate">End Date</label><input id="reportEndDate" type="date" onchange="gr()" placeholder="End Date"><div id="reportOutput"><div id="chartContainer"><canvas id="reportChart"></canvas></div></div></div><div id="nfcStatus" class="form"><h2>NFC Status</h2><p id="nfcStatusResult">Scan an NFC tag to see headphone status.</p></div><div id="manualReturnDialog" class="dialog"><div id="manualReturnDialogHeader" class="dialog-header">Select Headphones to Return</div><label for="manualReturnSearch">Search Headphones</label><input id="manualReturnSearch" type="text" placeholder="Search headphones..." onkeyup="fm()"><table id="manualReturnTable"><thead><tr><th>Select</th><th>ID</th><th>Customer</th><th>Group ID</th></tr></thead><tbody id="manualReturnList"></tbody></table><button onclick="smr();v()">Return Selected</button><button onclick="cd('manualReturn');v()">Cancel</button></div><div id="nfcDialog" class="dialog"><p>Scanning... Click 'Cancel Scan' to stop</p><button onclick="cn();v()">Cancel Scan</button></div><div id="dialogOverlay" class="dialog-overlay" onclick="cd(null);v()"></div><div id="loadingOverlay" class="loading-overlay"><div class="spinner"></div></div></div><style>*{margin:0;padding:0;box-sizing:border-box}body{font-family:'Poppins',sans-serif;background:#1A1A1A;color:#FFF;padding:20px;line-height:1.6}.container{max-width:1200px;margin:0 auto}header{display:flex;align-items:center;justify-content:center;padding:20px 0;background:rgba(107,72,255,.1);border-radius:10px;margin-bottom:30px;text-align:center}header img{height:60px;margin-right:15px}header h1{font-size:28px;font-weight:700;color:#FFF}.button-group{display:flex;flex-direction:column;align-items:center;gap:20px;margin-bottom:30px;width:100%}button{padding:12px 20px;font-size:16px;font-weight:600;background:#6B48FF;color:#FFF;border:none;border-radius:8px;cursor:pointer;transition:background .3s ease,transform .2s ease}button:hover{background:#5439CC;transform:translateY(-2px)}button:disabled{background:#666;cursor:not-allowed;transform:none}.form{display:none;flex-direction:column;gap:20px;background:#2A2A2A;padding:25px;border-radius:12px;box-shadow:0 4px 12px rgba(0,0,0,.3)}.form h2{font-size:24px;font-weight:600;color:#FFF}input,textarea,select{padding:10px;font-size:14px;background:#EDEDED;border:none;border-radius:6px;color:#1A1A1A;width:100%;max-width:400px}textarea{resize:vertical;height:150px}label{font-size:14px;color:#FFF;margin-bottom:5px;display:block}#signaturePad{border:2px solid #6B48FF;background:#FFF;width:300px;height:150px;margin:10px auto;border-radius:6px}#clearSignature{background:#FF4444}#clearSignature:hover{background:#CC3333}#card-container{margin:10px auto;min-height:50px}#paymentOptions{display:flex;flex-direction:column;align-items:center;gap:10px}#paymentOptions p{color:#EDEDED;font-size:14px}table{width:100%;border-collapse:collapse;background:#2A2A2A;border-radius:8px;overflow:hidden}th,td{padding:8px;text-align:left;font-size:12px;border-bottom:1px solid #3A3A3A;white-space:nowrap}th{background:#6B48FF;font-weight:600;position:sticky;top:0;z-index:10}td{color:#EDEDED}.checkin-btn{background:#28A745}.charge-btn{background:#FFC107;color:#1A1A1A;padding:4px 8px;font-size:10px}.delete-btn{background:#808080;padding:4px 8px;font-size:10px}.button-group button{width:90%;max-width:600px;text-align:center}.form button{width:auto;min-width:150px}#headphoneIdsList{list-style:none;padding:0;margin:10px 0;background:#3A3A3A;border-radius:6px}#headphoneIdsList li{display:flex;justify-content:space-between;align-items:center;padding:10px;border-bottom:1px solid #4A4A4A}.remove-btn{background:#DC3545;padding:6px 12px;font-size:12px}.dialog{position:fixed;top:10%;left:50%;transform:translateX(-50%);background:#2A2A2A;padding:20px;border-radius:12px;z-index:1000;display:none;flex-direction:column;gap:15px;max-width:90%;max-height:80vh;overflow-y:auto;box-shadow:0 6px 16px rgba(0,0,0,.5)}.dialog-header{background:#6B48FF;color:#FFF;padding:10px;font-size:20px;font-weight:600;border-radius:8px 8px 0 0;cursor:move}.dialog-overlay{position:fixed;top:0;left:0;width:100%;height:100%;background:rgba(0,0,0,.7);z-index:999;display:none}.loading-overlay{position:fixed;top:0;left:0;width:100%;height:100%;background:rgba(0,0,0,.5);display:none;justify-content:center;align-items:center;z-index:2000}.spinner{border:8px solid #EDEDED;border-top:8px solid #6B48FF;border-radius:50%;width:60px;height:60px;animation:spin 1s linear infinite}.dashboard-table-wrapper,.return-table-wrapper{max-height:500px;overflow-y:auto;overflow-x:auto;width:100%;-webkit-overflow-scrolling:touch}.dashboard-actions,.return-actions{margin:20px 0;display:flex;gap:10px;justify-content:center}#reportControls{display:flex;flex-wrap:wrap;gap:15px;margin-bottom:20px;align-items:center;justify-content:space-between}#reportControls div{display:flex;gap:10px;align-items:center}#reportControls label{font-size:14px;color:#FFF;margin-right:5px}#reportFilters button{padding:8px 15px;font-size:14px}#reportOutput{max-width:100%;overflow-x:auto;padding:10px}#chartContainer{width:100%;max-width:800px;height:400px;margin:0 auto;position:relative}#reportOutput canvas{width:100%!important;height:100%!important}#nfcDialog button{background:#DC3545;margin-top:10px}#nfcDialog button:hover{background:#B02A37}#nfcDialog p{font-size:16px;text-align:center}@keyframes spin{0%{transform:rotate(0deg)}100%{transform:rotate(360deg)}}@media (max-width:768px){header img{height:40px}header h1{font-size:22px}.button-group{gap:15px}button{width:95%;font-size:16px;padding:12px 20px}.form{padding:15px}input,textarea,select{width:100%;max-width:100%}table{font-size:10px}th,td{padding:6px}.dashboard-table-wrapper,.return-table-wrapper{max-height:300px}#reportControls{flex-direction:column;align-items:stretch}#reportControls div{flex-direction:column;align-items:stretch}#chartContainer{max-width:100%;height:300px}}
</style><script>const sqAppId='sandbox-sq0idb-qaDoxfFQK3OfUWlaCrgkDw';let hp={},u=new Set(),cl=new Set(),nm=new Map(),sig=null,pay,card,db,hc,sqLoc,fbCfg,ac=null,nt=false,ti=null,ci=null;async function fc(){try{const r=await fetch('/.netlify/functions/get-config'),c=await r.json();sqLoc=c.squareLocationId;fbCfg=c.firebaseConfig}catch(e){console.error('Failed to fetch config:',e);alert('Failed to load configuration')}}async function wf(){return new Promise(r=>{let a=0;const i=setInterval(()=>{if((typeof firebase!=='undefined'&&firebase.app&&firebase.firestore)||a>=100){clearInterval(i);if(firebase.app){firebase.initializeApp(fbCfg);db=firebase.firestore();hc=db.collection('headphones')}r()}a++},100)})}async function lh(){if(!db||!hc)return hp;try{const s=await hc.get();hp={};u=new Set();s.forEach(d=>{hp[d.id]=d.data();if(hp[d.id].status==='checked_out')u.add(d.id)});return hp}catch(e){console.error('Error loading headphones:',e);alert('Failed to load data');return hp}}async function sh(id,d){try{if(db&&hc)await hc.doc(id).set(d);hp[id]=d;if(d.status==='checked_out')u.add(id)}catch(e){console.error('Error saving headphone:',e);throw e}}async function uh(id,d){try{if(db&&hc)await hc.doc(id).update(d);hp[id]={...hp[id],...d};if(d.status==='returned'||d.status==='charged')u.delete(id)}catch(e){console.error('Error updating headphone:',e);alert('Failed to update data');throw e}}async function dh(id){try{if(confirm(`Are you sure you want to delete headphone ${id}?`)){if(db&&hc)await hc.doc(id).delete();delete hp[id];u.delete(id);cl.delete(id);alert(`Headphone ${id} deleted!`);ud()}}catch(e){console.error('Error deleting headphone:',e);alert('Failed to delete headphone')}}async function is(){if(!window.Square)return;if(!pay)pay=window.Square.payments(sqAppId);const c=document.getElementById('card-container');c.innerHTML='';card=await pay.card();await card.attach('#card-container');return card}window.onload=async()=>{try{await fc();await wf();await is();await lh();md('manualReturnDialog','manualReturnDialogHeader');nt=false;rt()}catch(e){console.error('Initialization error:',e);alert('Failed to start app')}};function v(){if('vibrate' in navigator)navigator.vibrate(100)}function sl(){document.getElementById('loadingOverlay').style.display='flex';document.getElementById('checkoutButton').disabled=true;document.querySelectorAll('.charge-btn').forEach(b=>b.disabled=true)}function hl(){document.getElementById('loadingOverlay').style.display='none';document.getElementById('checkoutButton').disabled=false;document.querySelectorAll('.charge-btn').forEach(b=>b.disabled=false)}function ah(){const id=document.getElementById('headphoneId').value.trim();if(!id)return alert('Please enter a headphone ID!');const ci=gh('headphoneIdsList');if(ci.includes(id))return alert(`Headphone ID ${id} is already in your checkout list!`);if(hp[id]&&hp[id].status==='checked_out')return alert(`Headphone ${id} is already checked out!`);const l=document.getElementById('headphoneIdsList'),li=document.createElement('li');li.innerHTML=`${id} <button class="remove-btn" onclick="rh(this,'${id}')">Remove</button>`;l.appendChild(li);cl.add(id);document.getElementById('headphoneId').value='';console.log(`Manually added headphone ID: ${id}`)}function rh(b,id){b.parentElement.remove();cl.delete(id);nm.forEach((h,n)=>{if(h===id)nm.delete(n)});console.log(`Removed headphone ID: ${id}`)}function gh(li){return Array.from(document.getElementById(li).children).map(l=>l.textContent.split(' ')[0])}function gg(){const r=/^GROUP_\d{7}$/,e=Object.values(hp).filter(h=>h.groupId&&r.test(h.groupId)).map(h=>parseInt(h.groupId.replace('GROUP_',''),10));let n=1;if(e.length)n=Math.max(...e)+1;return`GROUP_${String(n).padStart(7,'0')}`}function gu(){const r=/^HP\d{7}$/,a=new Set([...u,...cl]),e=Array.from(a).filter(id=>r.test(id));let n=1;if(e.length)n=Math.max(...e.map(id=>parseInt(id.replace('HP',''),10)))+1;return`HP${String(n).padStart(7,'0')}`}async function sc(){tf('checkout');ip('signaturePad');await is();document.getElementById('headphoneIdsList').innerHTML='';cl.clear();nm.clear();document.getElementById('headphoneId').value='';if(ac){ac.abort();ac=null}console.log('Checkout form shown, NFC state and list reset');console.log('checkoutListIds:',Array.from(cl));console.log('headphoneIdsList innerHTML:',document.getElementById('headphoneIdsList').innerHTML);nt=false;document.getElementById('scanCheckout').disabled=false}async function sr(){tf('return');await lh();ur()}async function sd(){tf('dashboard');await lh();ud()}async function srs(){tf('reports');await lh();document.getElementById('reportType').value='';document.getElementById('reportStartDate').value='';document.getElementById('reportEndDate').value='';document.getElementById('reportSearch').value='';document.getElementById('chartType').value='bar';gr()}async function sn(){nt=true;tf('nfcStatus');const d=document.getElementById('nfcDialog'),o=document.getElementById('dialogOverlay'),r=document.getElementById('nfcStatusResult');d.style.display='flex';o.style.display='block';r.textContent='';if(!('NDEFReader' in window)){r.textContent='NFC not supported.';d.style.display='none';o.style.display='none';return}const n=new NDEFReader();ac=new AbortController();try{await n.scan({signal:ac.signal});n.onreading=e=>{const ni=e.serialNumber.toLowerCase(),m=Object.entries(hp).find(([_,h])=>h.nfcId&&h.nfcId.toLowerCase()===ni);if(m){const[id,h]=m;r.innerHTML+=`<strong>ID:</strong> ${id}<br><strong>NFC ID:</strong> ${h.nfcId||'N/A'}<br><strong>Status:</strong> ${h.status==='checked_out'?'Checked Out':h.status==='returned'?'Returned':'Charged'}<br><strong>Customer:</strong> ${h.customer.name}<br><strong>Email:</strong> ${h.customer.email}<br><strong>Phone:</strong> ${h.customer.phone}<br><strong>Preauth Status:</strong> ${h.pre_auth?'Hold':'Released'}<br><strong>Entry Method:</strong> ${h.entryMethod||'N/A'}<br><strong>Date:</strong> ${h.agreement.date||'N/A'}<br><strong>Group ID:</strong> ${h.groupId||'Single'}<br><hr>`}};n.onreadingerror=()=>{r.innerHTML+='<br>Error reading NFC tag. Try again.'}}catch(e){if(e.name!=='AbortError')r.textContent=`Error: ${e.message}`;d.style.display='none';o.style.display='none'}}function tf(a){['checkout','return','dashboard','nfcStatus','reports'].forEach(id=>document.getElementById(id).style.display=id===a?'flex':'none');document.getElementById('manualReturnDialog').style.display='none';document.getElementById('nfcDialog').style.display='none';document.getElementById('dialogOverlay').style.display='none'}async function sfc(){nt=true;const b=document.getElementById('scanCheckout'),i=document.getElementById('headphoneId'),d=document.getElementById('nfcDialog'),o=document.getElementById('dialogOverlay');b.disabled=true;d.style.display='flex';o.style.display='block';if(!('NDEFReader' in window)){console.log('NFC not supported by browser');alert('NFC not supported. Enter ID manually.');me();b.disabled=false;d.style.display='none';o.style.display='none';return}console.log('Starting NFC scan for checkout');if(ac){ac.abort();console.log('Aborted existing NFC controller')}const n=new NDEFReader();ac=new AbortController();try{await n.scan({signal:ac.signal});console.log('NFC scan started successfully');const st=Date.now();let sc=0,lt=Date.now();n.onreading=e=>{const ts=Date.now()-st;if(ts<500){console.log(`Ignoring NFC read within 500ms of scan start: ${e.serialNumber}`);return}const ni=e.serialNumber.toLowerCase(),ci=gh('headphoneIdsList');if(nm.has(ni)){const ei=nm.get(ni);alert(`Error: NFC tag ${ni} is already linked to headphone ${ei} in the checkout list!`);return}const id=gu();console.log(`NFC tag read: ${ni}, assigned ID: ${id}`);if(ci.includes(id))alert(`Headphone ID ${id} is already in your checkout list!`);else if(hp[id]&&hp[id].status==='checked_out')alert(`Headphone ${id} is already checked out!`);else{const l=document.getElementById('headphoneIdsList'),li=document.createElement('li');li.innerHTML=`${id} <button class="remove-btn" onclick="rh(this,'${id}')">Remove</button>`;l.appendChild(li);cl.add(id);nm.set(ni,id);sc++;alert(`Headphone ${id} with NFC ID ${ni} added to checkout list.`)}i.value='';i.dataset.nfcId=ni;i.dataset.entryMethod='NFC';lt=Date.now()};n.onreadingerror=()=>{console.log('NFC reading error occurred');alert('Error reading NFC tag. Please try again.')};ti=setInterval(()=>{if(Date.now()-lt>=7000){ac.abort();clearInterval(ti);ti=null;if(!sc){console.log('No NFC tags detected after 7 seconds');alert('No NFC tags detected after 7 seconds. Please enter headphone IDs manually.');me()}else{console.log(`NFC scan completed, ${sc} headphone(s) added`);alert(`NFC scan complete. ${sc} headphone(s) added to checkout list.`)}b.disabled=false;d.style.display='none';o.style.display='none'}},500)}catch(e){if(e.name!=='AbortError'){console.error('NFC scan failed:',e.message);alert(`NFC scan failed: ${e.message}. Enter ID manually.`);me()}b.disabled=false;d.style.display='none';o.style.display='none'}}function me(){const i=document.getElementById('headphoneId'),b=document.getElementById('scanCheckout'),r=/^HP\d{7}$/,s=gu(),u=prompt(`Enter headphone ID (suggested: ${s}):`,s);if(!u||!r.test(u)){alert('Invalid ID format. Use HP followed by 7 digits.');b.disabled=false;return}if(hp[u]&&hp[u].status==='checked_out'){alert(`ID ${u} is already checked out!`);b.disabled=false;return}if(cl.has(u)){alert(`ID ${u} is already in your checkout list!`);b.disabled=false;return}i.value=u;i.dataset.entryMethod='Manual';b.disabled=false}async function sfd(){nt=true;const b=document.getElementById('scanDashboardNFC'),d=document.getElementById('nfcDialog'),o=document.getElementById('dialogOverlay');b.disabled=true;d.style.display='flex';o.style.display='block';if(!('NDEFReader' in window)){alert('NFC not supported. Please manually select headphones to return.');b.disabled=false;d.style.display='none';o.style.display='none';return}const n=new NDEFReader();ac=new AbortController();try{await n.scan({signal:ac.signal});let sc=0,lt=Date.now();n.onreading=e=>{const ni=e.serialNumber.toLowerCase(),m=Object.entries(hp).find(([_,h])=>h.nfcId&&h.nfcId.toLowerCase()===ni&&h.status==='checked_out');if(m){const[id]=m,c=document.querySelector(`input[name="checkinHeadphone"][value="${id}"]`);if(c){c.checked=true;alert(`Headphone ${id} with NFC ID ${ni} selected for return.`);sc++}else alert(`Headphone ${id} with NFC ID ${ni} is checked out but not in the current dashboard view. Adjust filters or search to include it.`)}lt=Date.now()};n.onreadingerror=()=>alert('Error reading NFC tag. Please try again or manually select headphones.');ti=setInterval(()=>{if(Date.now()-lt>=7000){ac.abort();clearInterval(ti);ti=null;if(!sc)alert('No NFC tags detected after 7 seconds. Please manually select headphones to return.');b.disabled=false;d.style.display='none';o.style.display='none'}},500)}catch(e){if(e.name!=='AbortError')alert(`NFC scan failed: ${e.message}. Please manually select headphones to return.`);b.disabled=false;d.style.display='none';o.style.display='none'}}async function sfr(){nt=true;const b=document.getElementById('scanReturn'),d=document.getElementById('nfcDialog'),o=document.getElementById('dialogOverlay');b.disabled=true;d.style.display='flex';o.style.display='block';if(!('NDEFReader' in window)){alert('NFC not supported. Please manually select headphones to return.');b.disabled=false;d.style.display='none';o.style.display='none';return}const n=new NDEFReader();ac=new AbortController();try{await n.scan({signal:ac.signal});let sc=0,lt=Date.now();n.onreading=e=>{const ni=e.serialNumber.toLowerCase(),m=Object.entries(hp).find(([_,h])=>h.nfcId&&h.nfcId.toLowerCase()===ni&&h.status==='checked_out');if(m){const[id]=m,c=document.querySelector(`input[name="returnHeadphone"][value="${id}"]`);if(c){c.checked=true;alert(`Headphone ${id} with NFC ID ${ni} selected for return.`);sc++}else alert(`Headphone ${id} with NFC ID ${ni} is checked out but not in the current view. Adjust search to include it.`)}lt=Date.now()};n.onreadingerror=()=>alert('Error reading NFC tag. Please try again or manually select headphones.');ti=setInterval(()=>{if(Date.now()-lt>=7000){ac.abort();clearInterval(ti);ti=null;if(!sc)alert('No NFC tags detected after 7 seconds. Please manually select headphones to return.');b.disabled=false;d.style.display='none';o.style.display='none'}},500)}catch(e){if(e.name!=='AbortError')alert(`NFC scan failed: ${e.message}. Please manually select headphones to return.`);b.disabled=false;d.style.display='none';o.style.display='none'}}function cn(){if(ac){ac.abort();ac=null;if(ti){clearInterval(ti);ti=null}document.getElementById('nfcDialog').style.display='none';document.getElementById('dialogOverlay').style.display='none';document.getElementById('scanCheckout').disabled=false;document.getElementById('scanDashboardNFC').disabled=false;document.getElementById('scanReturn').disabled=false;document.getElementById('nfcStatusResult').textContent='Scan cancelled. Scan an NFC tag to see headphone status.'}}function sm(){const d=document.getElementById('manualReturnDialog'),o=document.getElementById('dialogOverlay'),l=document.getElementById('manualReturnList'),co=Object.entries(hp).filter(([_,h])=>h.status==='checked_out');d.style.display='flex';o.style.display='block';l.innerHTML='';co.forEach(([id,h])=>{const r=document.createElement('tr');r.innerHTML=`<td><input type="checkbox" name="manualReturnHeadphone" value="${id}"></td><td>${id}</td><td>${h.customer.name}</td><td>${h.groupId||'Single'}</td>`;l.appendChild(r)});document.getElementById('manualReturnSearch').value=''}function fm(){const s=document.getElementById('manualReturnSearch').value.toLowerCase(),r=document.getElementById('manualReturnList').getElementsByTagName('tr');Array.from(r).forEach(r=>r.style.display=r.textContent.toLowerCase().includes(s)?'':'none')}async function smr(){const s=Array.from(document.getElementById('manualReturnList').querySelectorAll('input[name="manualReturnHeadphone"]:checked')).map(i=>i.value);if(!s.length)return alert('Please select at least one headphone!');const g=s.map(id=>hp[id].groupId||'Single');if(new Set(g).size>1)return alert('All selected headphones must belong to the same group or all be singles.');try{for(const id of s)await uh(id,{status:'returned',pre_auth:null});const m=await se(s);alert(m);cd('manualReturn');sr()}catch(e){alert('Failed to return headphones: '+e.message)}}function ip(c){const cv=document.getElementById(c),ctx=cv.getContext('2d');let d=false;ctx.lineWidth=2;ctx.lineCap='round';ctx.strokeStyle='#000';cv.addEventListener('mousedown',e=>{d=true;ctx.beginPath();const{x,y}=gp(e);ctx.moveTo(x,y);e.preventDefault()});cv.addEventListener('mousemove',e=>{if(!d)return;const{x,y}=gp(e);ctx.lineTo(x,y);ctx.stroke();e.preventDefault()});cv.addEventListener('mouseup',()=>{if(d){d=false;if(c==='signaturePad')sig=cv.toDataURL()}});cv.addEventListener('touchstart',e=>{d=true;ctx.beginPath();const{x,y}=gp(e);ctx.moveTo(x,y);e.preventDefault()});cv.addEventListener('touchmove',e=>{if(!d)return;const{x,y}=gp(e);ctx.lineTo(x,y);ctx.stroke();e.preventDefault()});cv.addEventListener('touchend',()=>{if(d){d=false;if(c==='signaturePad')sig=cv.toDataURL()}});function gp(e){const r=cv.getBoundingClientRect(),t=e.touches?e.touches[0]:e;return{x:t.clientX-r.left,y:t.clientY-r.top}}}function cs(){const c=document.getElementById('signaturePad'),ctx=c.getContext('2d');ctx.clearRect(0,0,c.width,c.height);sig=null}async function tpc(){if(!('NDEFReader' in window))return alert('NFC not supported. Use manual entry.');const n=new NDEFReader();try{sl();await n.scan();const c=new AbortController();n.onreading=async e=>{const ni=e.serialNumber,pt='cnon:card-nonce-ok';await pp(pt);c.abort()};n.onreadingerror=()=>{alert('Failed to read payment card. Try again or use manual entry.');c.abort();hl()};setTimeout(()=>{c.abort();if(!c.signal.aborted){alert('Payment scan timed out.');hl()}},5000);await new Promise(r=>c.signal.addEventListener('abort',r))}catch(e){alert(`NFC error: ${e.message}. Use manual entry.`);hl()}}async function pp(pt){const hi=gh('headphoneIdsList'),n=document.getElementById('name').value,e=document.getElementById('email').value,p=document.getElementById('phone').value,d=new Date().toISOString().split('T')[0];if(!hi.length||!n||!e||!p||!sig){hl();return alert('Please complete all fields and sign the agreement!')}const g=hi.length>1?gg():null;let si=[];try{const r=await fetch('/.netlify/functions/preauthorize',{method:'POST',headers:{'Content-Type':'application/json'},body:JSON.stringify({sourceId:pt,amount:hi.length*10000,currency:'USD',locationId:sqLoc})}),pr=await r.json();if(!r.ok)throw new Error(pr.error||'Preauthorization failed');const pi=pr.paymentId;for(const id of hi){if(hp[id]&&hp[id].status==='checked_out'){alert(`Headphone ID ${id} is already checked out! Skipping.`);continue}const em=document.getElementById('headphoneId').dataset.entryMethod||'Manual',ni=document.getElementById('headphoneId').dataset.nfcId,hd={status:'checked_out',customer:{name:n,email:e,phone:p},agreement:{text:document.getElementById('agreement').value.replace('[Customer Name]',n).replace('[Date]',d).replace('[Headphone IDs]',hi.join(', ')),signature:sig,amount:100,date:d,timestamp:Date.now()},pre_auth:{pre_auth_id:pi,amount:hi.length*100},entryMethod:em,nfcId:ni||null};if(g)hd.groupId=g;await sh(id,hd);si.push(id)}if(si.length>0){const ht=si.join(', '),at=document.getElementById('agreement').value.replace('[Customer Name]',n).replace('[Date]',d).replace('[Headphone IDs]',ht),er=await fetch('/.netlify/functions/send-email',{method:'POST',headers:{'Content-Type':'application/json'},body:JSON.stringify({name:n,email:e,agreement:at,signature:sig,preauthId:pi})});if(!er.ok)throw new Error('Email failed');alert(`Headphones ${ht} checked out! Agreement emailed to ${e}.`)}else alert('No headphones were checked out due to existing usage.');cf('checkout');sd()}catch(e){console.error('Payment error:',e.message);alert('Payment failed: '+e.message)}finally{hl()}}async function co(){const hi=gh('headphoneIdsList'),n=document.getElementById('name').value,e=document.getElementById('email').value,p=document.getElementById('phone').value,d=new Date().toISOString().split('T')[0];if(!hi.length||!n||!e||!p||!sig||!card)return alert('Please complete all fields, enter card details, and sign!');sl();try{const r=await card.tokenize();if(r.status!=='OK')throw new Error('Card tokenization failed.');await pp(r.token)}catch(e){console.error('Checkout error:',e.message);alert('Checkout failed: '+e.message)}finally{hl()}}async function se(ri){const c=hp[ri[0]].customer||{name:'Customer',email:''},hl=ri.join(', '),eb=`Dear ${c.name||'Customer'},

Thank you for attending our Silent Disco event with SE2 Silent Disco! We hope you had an amazing experience. We're pleased to confirm that we've received the following headphone(s): ${hl}. 

You are no longer responsible for these items, and any associated payment holds have been released. We appreciate your prompt return and hope to see you at future events!

For any questions, contact us at:
- Website: www.se2.events
- Email: se2login@gmail.com

Best regards,
The SE2 Silent Disco Team`,ep={name:c.name||'Customer',email:c.email||'',agreement:eb,signature:'',preauthId:''},er=await fetch('/.netlify/functions/send-email',{method:'POST',headers:{'Content-Type':'application/json'},body:JSON.stringify(ep)});if(!er.ok){const et=await er.text();console.error('Failed to send return email:',et);return`Headphone(s) ${ri.join(', ')} returned, but email failed: ${et}`}return`Headphone(s) ${ri.join(', ')} returned! Confirmation emailed to ${c.email||'customer'}.`}async function rsh(){const s=Array.from(document.querySelectorAll('input[name="returnHeadphone"]:checked')).map(i=>i.value);if(!s.length)return alert('Please select at least one headphone to return!');const g=s.map(id=>hp[id].groupId||'Single');if(new Set(g).size>1)return alert('All selected headphones must belong to the same group or all be singles.');try{let ri=[];for(const id of s){if(!hp[id]||hp[id].status!=='checked_out'){alert(`Headphone ${id} not checked out! Skipping.`);continue}await uh(id,{status:'returned',pre_auth:null});ri.push(id)}if(ri.length){const m=await se(ri);alert(m)}else alert('No headphones returned.');ur()}catch(e){console.error('Return error:',e.message);alert('Failed to return headphones: '+e.message)}}function srd(){const s=Array.from(document.querySelectorAll('input[name="checkinHeadphone"]:checked')).map(i=>i.value);if(!s.length)return alert('Please select at least one headphone to return!');const g=s.map(id=>hp[id].groupId||'Single');if(new Set(g).size>1)return alert('All selected headphones must belong to the same group or all be singles.');sm();const l=document.getElementById('manualReturnList');l.innerHTML='';s.forEach(id=>{const h=hp[id],r=document.createElement('tr');r.innerHTML=`<td><input type="checkbox" name="manualReturnHeadphone" value="${h.id}" checked></td><td>${h.id}</td><td>${h.customer.name}</td><td>${h.groupId||'Single'}</td>`;l.appendChild(r)})}function cd(t){if(t==='manualReturn')document.getElementById('manualReturnDialog').style.display='none';document.getElementById('dialogOverlay').style.display='none';document.getElementById('nfcDialog').style.display='none';sd()}async function dc(id){if(!hp[id]||hp[id].status!=='checked_out'||!hp[id].pre_auth)return alert(`Cannot charge ${id}: Not checked out or no preauthorization.`);const g=hp[id].groupId,hc=g?Object.values(hp).filter(h=>h.groupId===g&&h.status==='checked_out').length:1,ca=Math.round(hp[id].pre_auth.amount*100/hc),cad=(ca/100).toFixed(2);if(!confirm(`Charge ${hp[id].customer.name} $${cad} for ${id}?`))return;sl();try{const r=await fetch('/.netlify/functions/capture-payment',{method:'POST',headers:{'Content-Type':'application/json'},body:JSON.stringify({paymentId:hp[id].pre_auth.pre_auth_id,amount:ca})}),cr=await r.json();if(!r.ok)throw new Error(cr.error||'Charge failed');await uh(id,{status:'charged',pre_auth:null});alert(`Headphone ${id} charged for $${cad}!`);ud()}catch(e){alert(`Charge failed for ${id}: ${e.message}`)}finally{hl()}}function ud(){const t=document.getElementById('headphoneList'),s=document.getElementById('searchInput').value.toLowerCase(),df=document.getElementById('dateFilter').value,sd=document.getElementById('dashboardStartDate').value,ed=document.getElementById('dashboardEndDate').value||sd,n=Date.now(),tw=12*60*60*1000,ha=Object.entries(hp).map(([id,h])=>({id,...h})),co=ha.filter(h=>h.status==='checked_out'),ci=ha.filter(h=>h.status!=='checked_out');co.sort((a,b)=>(a.customer?.name||'N/A').localeCompare(b.customer?.name||'N/A'));ci.sort((a,b)=>(a.customer?.name||'N/A').localeCompare(b.customer?.name||'N/A'));const sa=[...co,...ci];t.innerHTML='';let fa=sa;if(sd){const st=new Date(sd).setHours(0,0,0,0),en=new Date(ed).setHours(23,59,59,999);fa=sa.filter(h=>new Date(h.agreement?.date).setHours(0,0,0,0)>=st&&new Date(h.agreement?.date).setHours(0,0,0,0)<=en)}fa.forEach(h=>{const st=h.status==='checked_out'?'Checked Out':h.status==='returned'?'Returned':'Charged',o=h.status==='checked_out'&&(n-(h.agreement?.timestamp||n)>tw),rd=[h.customer?.name||'N/A',st,h.pre_auth?'Hold':'Released',h.customer?.email||'N/A',h.customer?.phone||'N/A',h.id,h.nfcId||'N/A',h.entryMethod||'N/A',h.agreement?.date||'N/A',h.groupId||'Single'];if(rd.some(d=>d.toLowerCase().includes(s))&&(!df||h.agreement?.date===df)){const r=document.createElement('tr');let ch=h.status==='checked_out'?`<input type="checkbox" name="checkinHeadphone" value="${h.id}">`:'',ca=h.status==='checked_out'&&h.pre_auth&&o?`<button class="charge-btn" onclick="dc('${h.id}')">Charge</button>`:'';r.innerHTML=`<td>${ch}</td><td>${ca}</td><td>${h.customer?.name||'N/A'}</td><td>${st}</td><td>${h.pre_auth?'Hold':'Released'}</td><td>${h.customer?.email||'N/A'}</td><td>${h.customer?.phone||'N/A'}</td><td>${h.id}</td><td>${h.nfcId||'N/A'}</td><td>${h.entryMethod||'N/A'}</td><td>${h.groupId||'Single'}</td><td><button class="delete-btn" onclick="dh('${h.id}')">Delete</button></td>`;t.appendChild(r)}})}function ur(){const t=document.getElementById('returnList'),s=document.getElementById('returnSearch').value.toLowerCase(),ha=Object.entries(hp).filter(([_,h])=>h.status==='checked_out').map(([id,h])=>({id,...h}));ha.sort((a,b)=>(a.customer?.name||'N/A').localeCompare(b.customer?.name||'N/A'));t.innerHTML='';ha.forEach(h=>{const rd=[h.customer?.name||'N/A',h.customer?.email||'N/A',h.customer?.phone||'N/A',h.id,h.nfcId||'N/A',h.groupId||'Single'];if(rd.some(d=>d.toLowerCase().includes(s))){const r=document.createElement('tr');r.innerHTML=`<td><input type="checkbox" name="returnHeadphone" value="${h.id}"></td><td>${h.customer?.name||'N/A'}</td><td>${h.customer?.email||'N/A'}</td><td>${h.customer?.phone||'N/A'}</td><td>${h.id}</td><td>${h.nfcId||'N/A'}</td><td>${h.groupId||'Single'}</td>`;t.appendChild(r)}})}function sh(){ud()}function fd(){ud()}function cf(f){document.getElementById(f).querySelectorAll('input').forEach(i=>{i.value='';delete i.dataset.nfcId;delete i.dataset.entryMethod});if(f==='checkout'){document.getElementById('card-container').innerHTML='';document.getElementById('headphoneIdsList').innerHTML='';cl.clear();nm.clear();is()}}function fr(d){const e=new Date(),s=new Date();s.setDate(e.getDate()-d);document.getElementById('reportStartDate').value=s.toISOString().split('T')[0];document.getElementById('reportEndDate').value=e.toISOString().split('T')[0];gr()}function rf(){document.getElementById('reportStartDate').value='';document.getElementById('reportEndDate').value='';document.getElementById('reportSearch').value='';gr()}function gr(){const rt=document.getElementById('reportType').value,sd=document.getElementById('reportStartDate').value,ed=document.getElementById('reportEndDate').value||sd,rs=document.getElementById('reportSearch').value.toLowerCase(),ct=document.getElementById('chartType').value,o=document.getElementById('reportOutput');o.innerHTML='<div id="chartContainer"><canvas id="reportChart"></canvas></div>';if(!rt){o.innerHTML='<p>Select a report type to view details.</p>';return}const ha=Object.entries(hp).map(([id,h])=>({id,...h})),n=Date.now(),tw=12*60*60*1000;let fa=ha,th='';if(sd){const st=new Date(sd).setHours(0,0,0,0),en=new Date(ed).setHours(23,59,59,999);fa=ha.filter(h=>new Date(h.agreement?.date).setHours(0,0,0,0)>=st&&new Date(h.agreement?.date).setHours(0,0,0,0)<=en)}let fn=fa;if(rs)fn=fa.filter(h=>[h.id,h.nfcId||'',h.status,h.customer?.name||'',h.customer?.email||'',h.customer?.phone||'',h.agreement?.date||'',h.pre_auth?'Hold':'Released',h.entryMethod||'N/A',h.groupId||'Single'].some(d=>d.toLowerCase().includes(rs)));switch(rt){case'allData':th=`<h3>All Data (${fn.length} Headphones)</h3><p>Date Range: ${sd||'All'} to ${ed||'All'}</p><table><thead><tr><th>ID</th><th>NFC ID</th><th>Status</th><th>Customer</th><th>Email</th><th>Phone</th><th>Checkout Date</th><th>Preauth Status</th><th>Entry Method</th><th>Group ID</th></tr></thead><tbody>${fn.map(h=>`<tr><td>${h.id}</td><td>${h.nfcId||'N/A'}</td><td>${h.status==='checked_out'?'Checked Out':h.status==='returned'?'Returned':'Charged'}</td><td>${h.customer?.name||'N/A'}</td><td>${h.customer?.email||'N/A'}</td><td>${h.customer?.phone||'N/A'}</td><td>${h.agreement?.date||'N/A'}</td><td>${h.pre_auth?'Hold':'Released'}</td><td>${h.entryMethod||'N/A'}</td><td>${h.groupId||'Single'}</td></tr>`).join('')}</tbody></table>`;break;case'checkedOut':const co=fn.filter(h=>h.status==='checked_out');th=`<h3>Currently Checked Out (${co.length})</h3><p>Date Range: ${sd||'All'} to ${ed||'All'}</p><table><thead><tr><th>ID</th><th>NFC ID</th><th>Customer</th><th>Email</th><th>Phone</th><th>Checkout Date</th><th>Entry Method</th><th>Group ID</th></tr></thead><tbody>${co.map(h=>`<tr><td>${h.id}</td><td>${h.nfcId||'N/A'}</td><td>${h.customer.name}</td><td>${h.customer.email}</td><td>${h.customer.phone}</td><td>${h.agreement.date}</td><td>${h.entryMethod||'N/A'}</td><td>${h.groupId||'Single'}</td></tr>`).join('')}</tbody></table>`;break;case'overdue':const ov=fn.filter(h=>h.status==='checked_out'&&(n-h.agreement.timestamp>tw));th=`<h3>Overdue Headphones (${ov.length})</h3><p>Date Range: ${sd||'All'} to ${ed||'All'}</p><table><thead><tr><th>ID</th><th>NFC ID</th><th>Customer</th><th>Email</th><th>Phone</th><th>Checkout Date</th><th>Days Overdue</th><th>Entry Method</th><th>Group ID</th></tr></thead><tbody>${ov.map(h=>`<tr><td>${h.id}</td><td>${h.nfcId||'N/A'}</td><td>${h.customer.name}</td><td>${h.customer.email}</td><td>${h.customer.phone}</td><td>${h.agreement.date}</td><td>${Math.floor((n-h.agreement.timestamp)/(1000*60*60*24))}</td><td>${h.entryMethod||'N/A'}</td><td>${h.groupId||'Single'}</td></tr>`).join('')}</tbody></table>`;break;case'revenue':const ch=fn.filter(h=>h.status==='charged');th=`<h3>Revenue Summary</h3><p>Date Range: ${sd||'All'} to ${ed||'All'}</p><p>Total Revenue: $${(ch.length*100).toFixed(2)}</p><table><thead><tr><th>ID</th><th>NFC ID</th><th>Customer</th><th>Email</th><th>Phone</th><th>Charge Date</th><th>Amount</th><th>Entry Method</th><th>Group ID</th></tr></thead><tbody>${ch.map(h=>`<tr><td>${h.id}</td><td>${h.nfcId||'N/A'}</td><td>${h.customer.name}</td><td>${h.customer.email}</td><td>${h.customer.phone}</td><td>${h.agreement.date}</td><td>$100.00</td><td>${h.entryMethod||'N/A'}</td><td>${h.groupId||'Single'}</td></tr>`).join('')}</tbody></table>`;break;case'customerActivity':const cs={};fn.forEach(h=>{const k=`${h.customer.name}|${h.customer.email}|${h.customer.phone}`;if(!cs[k])cs[k]={name:h.customer.name,email:h.customer.email,phone:h.customer.phone,checkouts:0,headphones:[]};cs[k].checkouts++;cs[k].headphones.push(h.id)});th=`<h3>Customer Activity</h3><p>Date Range: ${sd||'All'} to ${ed||'All'}</p><table><thead><tr><th>Name</th><th>Email</th><th>Phone</th><th>Total Checkouts</th><th>Headphone IDs</th></tr></thead><tbody>${Object.values(cs).map(c=>`<tr><td>${c.name}</td><td>${c.email}</td><td>${c.phone}</td><td>${c.checkouts}</td><td>${c.headphones.join(', ')}</td></tr>`).join('')}</tbody></table>`;break;case'groupSummary':const gs={};fn.forEach(h=>{if(h.groupId){if(!gs[h.groupId])gs[h.groupId]={ids:[],customer:h.customer,total:0,checkedOut:0,returned:0,charged:0};gs[h.groupId].ids.push(h.id);gs[h.groupId].total++;if(h.status==='checked_out')gs[h.groupId].checkedOut++;if(h.status==='returned')gs[h.groupId].returned++;if(h.status==='charged')gs[h.groupId].charged++}});th=`<h3>Group Checkout Summary</h3><p>Date Range: ${sd||'All'} to ${ed||'All'}</p><table><thead><tr><th>Group ID</th><th>Customer</th><th>Email</th><th>Total Headphones</th><th>Checked Out</th><th>Returned</th><th>Charged</th><th>Headphone IDs</th></tr></thead><tbody>${Object.entries(gs).map(([id,g])=>`<tr><td>${id}</td><td>${g.customer.name}</td><td>${g.customer.email}</td><td>${g.total}</td><td>${g.checkedOut}</td><td>${g.returned}</td><td>${g.charged}</td><td>${g.ids.join(', ')}</td></tr>`).join('')}</tbody></table>`;break;case'nfcUsage':const ns={};fn.forEach(h=>{if(h.nfcId){if(!ns[h.nfcId])ns[h.nfcId]={uses:0,headphoneIds:[],dates:[]};ns[h.nfcId].uses++;ns[h.nfcId].headphoneIds.push(h.id);ns[h.nfcId].dates.push(h.agreement.date)}});th=`<h3>NFC Usage Statistics</h3><p>Date Range: ${sd||'All'} to ${ed||'All'}</p><table><thead><tr><th>NFC ID</th><th>Total Uses</th><th>Headphone IDs</th><th>Dates Used</th></tr></thead><tbody>${Object.entries(ns).map(([id,s])=>`<tr><td>${id}</td><td>${s.uses}</td><td>${s.headphoneIds.join(', ')}</td><td>${s.dates.join(', ')}</td></tr>`).join('')}</tbody></table>`;break;case'dailyCheckouts':const dd={};fn.filter(h=>h.status==='checked_out').forEach(h=>{const dt=h.agreement.date;dd[dt]=dd[dt]?dd[dt]+1:1});const ds=Object.keys(dd).sort(),cnt=ds.map(d=>dd[d]);th=`<h3>Daily Checkouts</h3><p>Date Range: ${sd||'All'} to ${ed||'All'}</p>`;o.innerHTML=th+'<div id="chartContainer"><canvas id="reportChart"></canvas></div>';rc('reportChart',ct,ds,cnt,'Daily Checkouts');return;case'statusDistribution':const sd={checked_out:0,returned:0,charged:0};fn.forEach(h=>sd[h.status]++);const l=['Checked Out','Returned','Charged'],v=[sd.checked_out,sd.returned,sd.charged];th=`<h3>Status Distribution</h3><p>Date Range: ${sd||'All'} to ${ed||'All'}</p>`;o.innerHTML=th+'<div id="chartContainer"><canvas id="reportChart"></canvas></div>';rc('reportChart',ct,l,v,'Headphone Status');return;default:th='<p>Invalid report type.</p>'}o.innerHTML=th;}function rc(ci,t,l,d,ti){if(ci)ci.destroy();const ctx=document.getElementById(ci).getContext('2d'),cfg={type:t==='pie'?'pie':t==='line'?'line':'bar',data:{labels:l,datasets:[{label:ti,data:d,backgroundColor:t==='pie'?['#6B48FF','#28A745','#FFC107']:'#6B48FF',borderColor:t==='line'?'#6B48FF':'#EDEDED',borderWidth:1,fill:t==='line'?false:undefined}]},options:{responsive:true,maintainAspectRatio:true,scales:t!=='pie'?{y:{beginAtZero:true,title:{display:true,text:'Count',color:'#EDEDED'}},x:{title:{display:true,text:'Date',color:'#EDEDED'}}}:undefined,plugins:{legend:{display:t==='pie',position:'top',labels:{color:'#EDEDED'}}}}};ci=new Chart(ctx,cfg);}function er(){const rt=document.getElementById('reportType').value,sd=document.getElementById('reportStartDate').value,ed=document.getElementById('reportEndDate').value||sd;if(!rt)return alert('Select a report type first!');let fa=Object.entries(hp).map(([id,h])=>({id,...h}));if(sd){const st=new Date(sd).setHours(0,0,0,0),en=new Date(ed).setHours(23,59,59,999);fa=fa.filter(h=>new Date(h.agreement?.date).setHours(0,0,0,0)>=st&&new Date(h.agreement?.date).setHours(0,0,0,0)<=en)}const n=Date.now(),tw=12*60*60*1000;let cc='';switch(rt){case'allData':cc='"ID","NFC ID","Status","Customer","Email","Phone","Checkout Date","Preauth Status","Entry Method","Group ID"\n'+fa.map(h=>`"${h.id}","${h.nfcId||'N/A'}","${h.status==='checked_out'?'Checked Out':h.status==='returned'?'Returned':'Charged'}","${h.customer?.name||'N/A'}","${h.customer?.email||'N/A'}","${h.customer?.phone||'N/A'}","${h.agreement?.date||'N/A'}","${h.pre_auth?'Hold':'Released'}","${h.entryMethod||'N/A'}","${h.groupId||'Single'}"`).join('\n');break;case'checkedOut':cc='"ID","NFC ID","Customer","Email","Phone","Checkout Date","Entry Method","Group ID"\n'+fa.filter(h=>h.status==='checked_out').map(h=>`"${h.id}","${h.nfcId||'N/A'}","${h.customer.name}","${h.customer.email}","${h.customer.phone}","${h.agreement.date}","${h.entryMethod||'N/A'}","${h.groupId||'Single'}"`).join('\n');break;case'overdue':cc='"ID","NFC ID","Customer","Email","Phone","Checkout Date","Days Overdue","Entry Method","Group ID"\n'+fa.filter(h=>h.status==='checked_out'&&(n-h.agreement.timestamp>tw)).map(h=>`"${h.id}","${h.nfcId||'N/A'}","${h.customer.name}","${h.customer.email}","${h.customer.phone}","${h.agreement.date}","${Math.floor((n-h.agreement.timestamp)/(1000*60*60*24))}","${h.entryMethod||'N/A'}","${h.groupId||'Single'}"`).join('\n');break;case'revenue':cc='"ID","NFC ID","Customer","Email","Phone","Charge Date","Amount","Entry Method","Group ID"\n'+fa.filter(h=>h.status==='charged').map(h=>`"${h.id}","${h.nfcId||'N/A'}","${h.customer.name}","${h.customer.email}","${h.customer.phone}","${h.agreement.date}","$100.00","${h.entryMethod||'N/A'}","${h.groupId||'Single'}"`).join('\n');break;case'customerActivity':const cs={};fa.forEach(h=>{const k=`${h.customer.name}|${h.customer.email}|${h.customer.phone}`;if(!cs[k])cs[k]={name:h.customer.name,email:h.customer.email,phone:h.customer.phone,checkouts:0,headphones:[]};cs[k].checkouts++;cs[k].headphones.push(h.id)});cc='"Name","Email","Phone","Total Checkouts","Headphone IDs"\n'+Object.values(cs).map(c=>`"${c.name}","${c.email}","${c.phone}","${c.checkouts}","${c.headphones.join(', ')}"`).join('\n');break;case'groupSummary':const gs={};fa.forEach(h=>{if(h.groupId){if(!gs[h.groupId])gs[h.groupId]={ids:[],customer:h.customer,total:0,checkedOut:0,returned:0,charged:0};gs[h.groupId].ids.push(h.id);gs[h.groupId].total++;if(h.status==='checked_out')gs[h.groupId].checkedOut++;if(h.status==='returned')gs[h.groupId].returned++;if(h.status==='charged')gs[h.groupId].charged++}});cc='"Group ID","Customer","Email","Total Headphones","Checked Out","Returned","Charged","Headphone IDs"\n'+Object.entries(gs).map(([id,g])=>`"${id}","${g.customer.name}","${g.customer.email}","${g.total}","${g.checkedOut}","${g.returned}","${g.charged}","${g.ids.join(', ')}"`).join('\n');break;case'nfcUsage':const ns={};fa.forEach(h=>{if(h.nfcId){if(!ns[h.nfcId])ns[h.nfcId]={uses:0,headphoneIds:[],dates:[]};ns[h.nfcId].uses++;ns[h.nfcId].headphoneIds.push(h.id);ns[h.nfcId].dates.push(h.agreement.date)}});cc='"NFC ID","Total Uses","Headphone IDs","Dates Used"\n'+Object.entries(ns).map(([id,s])=>`"${id}","${s.uses}","${s.headphoneIds.join(', ')}","${s.dates.join(', ')}"`).join('\n');break;case'dailyCheckouts':const dd={};fa.filter(h=>h.status==='checked_out').forEach(h=>{const dt=h.agreement.date;dd[dt]=dd[dt]?dd[dt]+1:1});cc='"Date","Checkouts"\n'+Object.entries(dd).map(([d,c])=>`"${d}","${c}"`).join('\n');break;case'statusDistribution':const sd={checked_out:0,returned:0,charged:0};fa.forEach(h=>sd[h.status]++);cc='"Status","Count"\n'+Object.entries(sd).map(([s,c])=>`"${s==='checked_out'?'Checked Out':s==='returned'?'Returned':'Charged'}","${c}"`).join('\n');break}const b=new Blob([cc],{type:'text/csv;charset=utf-8;'}),l=document.createElement('a');l.href=URL.createObjectURL(b);l.download=`${rt}_report_${sd||'all'}_${ed||'all'}.csv`;document.body.appendChild(l);l.click();document.body.removeChild(l)}function md(d,h){const dialog=document.getElementById(d),header=document.getElementById(h);let dr=false,cx=dialog.offsetLeft,cy=dialog.offsetTop,ix,iy;function sd(e){dr=true;ix=(e.type==='mousedown'?e.clientX:e.touches[0].clientX)-cx;iy=(e.type==='mousedown'?e.clientY:e.touches[0].clientY)-cy;header.style.cursor='grabbing'}function move(e){if(!dr)return;e.preventDefault();cx=(e.type==='mousemove'?e.clientX:e.touches[0].clientX)-ix;cy=(e.type==='mousemove'?e.clientY:e.touches[0].clientY)-iy;dialog.style.left=`${cx}px`;dialog.style.top=`${cy}px`;dialog.style.transform='none'}function st(){dr=false;header.style.cursor='move'}header.addEventListener('mousedown',sd);document.addEventListener('mousemove',move);document.addEventListener('mouseup',st);header.addEventListener('touchstart',sd);document.addEventListener('touchmove',move);document.addEventListener('touchend',st)}function rt(){console.log('Running unit tests...');try{const i1=gu(),i2=gu();if(/^HP\d{7}$/.test(i1)&&i1!==i2)console.log('Test Passed: generateUniqueHeadphoneId creates unique IDs in correct format');else console.error('Test Failed: generateUniqueHeadphoneId did not generate unique or correctly formatted IDs')}catch(e){console.error('Test Error: generateUniqueHeadphoneId threw an error:',e)}try{document.getElementById('headphoneIdsList').innerHTML='<li>HP0000001</li>';document.getElementById('name').value='Test User';document.getElementById('email').value='test@example.com';document.getElementById('phone').value='1234567890';sig='data:image/png;base64,test';console.log('Test Passed: processPayment setup complete (mocked)')}catch(e){console.error('Test Error: processPayment mock setup failed:',e)}}</script></body></html>
