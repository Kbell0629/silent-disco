<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>SE2 Silent Disco Tracker</title>
  <script src="https://sandbox.web.squarecdn.com/v1/square.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-firestore-compat.js"></script>
  <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@400;600;700&display=swap" rel="stylesheet">
  <style>
    *{margin:0;padding:0;box-sizing:border-box;}
    body{font-family:'Poppins',sans-serif;background:#1A1A1A;color:#FFF;padding:20px;line-height:1.6;}
    .container{max-width:1200px;margin:0 auto;}
    header{display:flex;align-items:center;justify-content:center;padding:20px 0;background:rgba(107,72,255,0.1);border-radius:10px;margin-bottom:30px;}
    header img{height:60px;margin-right:15px;}
    header h1{font-size:28px;font-weight:700;}
    .button-group{display:flex;flex-direction:column;align-items:center;gap:20px;margin-bottom:30px;width:100%;}
    button{padding:15px 30px;font-size:18px;font-weight:600;background:#6B48FF;color:#FFF;border:none;border-radius:10px;cursor:pointer;transition:background 0.3s ease,transform 0.2s ease;width:90%;max-width:600px;text-align:center;}
    button:hover{background:#5439CC;transform:translateY(-2px);}
    button:disabled{background:#666;cursor:not-allowed;transform:none;}
    .form{display:none;flex-direction:column;gap:20px;background:#2A2A2A;padding:25px;border-radius:12px;box-shadow:0 4px 12px rgba(0,0,0,0.3);}
    .form h2{font-size:24px;font-weight:600;color:#6B48FF;}
    input,textarea,select{padding:10px;font-size:14px;background:#EDEDED;border:none;border-radius:6px;color:#1A1A1A;width:100%;max-width:400px;}
    textarea{resize:vertical;height:150px;}
    #signaturePad{border:2px solid #6B48FF;background:#FFF;width:300px;height:150px;margin:10px auto;border-radius:6px;}
    #clearSignature{background:#FF4444;}
    #clearSignature:hover{background:#CC3333;}
    #card-container{margin:10px auto;min-height:50px;}
    #paymentOptions{display:flex;flex-direction:column;align-items:center;gap:10px;}
    #paymentOptions p{color:#EDEDED;font-size:14px;}
    table{width:100%;border-collapse:collapse;background:#2A2A2A;border-radius:8px;overflow:hidden;}
    th,td{padding:12px;text-align:left;font-size:14px;border-bottom:1px solid #3A3A3A;}
    th{background:#6B48FF;font-weight:600;position:sticky;top:0;z-index:10;}
    td{color:#EDEDED;}
    .checkin-btn{background:#28A745;}
    .charge-btn{background:#FFC107;color:#1A1A1A;}
    .delete-btn{background:#808080;}
    .button-group button,.form button{width:auto;min-width:150px;}
    #headphoneIdsList,#dialogHeadphoneIdsList,#returnHeadphoneIdsList{list-style:none;padding:0;margin:10px 0;background:#3A3A3A;border-radius:6px;}
    #headphoneIdsList li,#dialogHeadphoneIdsList li,#returnHeadphoneIdsList li{display:flex;justify-content:space-between;align-items:center;padding:10px;border-bottom:1px solid #4A4A4A;}
    .remove-btn{background:#DC3545;padding:6px 12px;font-size:12px;}
    .dialog{position:fixed;top:10%;left:50%;transform:translateX(-50%);background:#2A2A2A;padding:20px;border-radius:12px;z-index:1000;display:none;flex-direction:column;gap:15px;max-width:90%;max-height:80vh;overflow-y:auto;box-shadow:0 6px 16px rgba(0,0,0,0.5);}
    .dialog-header{background:#6B48FF;color:#FFF;padding:10px;font-size:20px;font-weight:600;border-radius:8px 8px 0 0;cursor:move;}
    .dialog-overlay{position:fixed;top:0;left:0;width:100%;height:100%;background:rgba(0,0,0,0.7);z-index:999;display:none;}
    .loading-overlay{position:fixed;top:0;left:0;width:100%;height:100%;background:rgba(0,0,0,0.5);display:none;justify-content:center;align-items:center;z-index:2000;}
    .spinner{border:8px solid #EDEDED;border-top:8px solid #6B48FF;border-radius:50%;width:60px;height:60px;animation:spin 1s linear infinite;}
    .dashboard-table-wrapper{max-height:400px;overflow-y:auto;overflow-x:auto;width:100%;}
    @keyframes spin{0%{transform:rotate(0deg);}100%{transform:rotate(360deg);}}
    @media (max-width:768px){
      header img{height:40px;}
      header h1{font-size:22px;}
      .button-group{gap:15px;}
      button{width:95%;font-size:16px;padding:12px 20px;}
      .form{padding:15px;}
      input,textarea,select{width:100%;}
      table{font-size:12px;}
      th,td{padding:8px;}
      .dashboard-table-wrapper{max-height:300px;}
    }
  </style>
</head>
<body>
  <div class="container">
    <header>
      <img src="https://encrypted-tbn0.gstatic.com/images?q=tbniqSWBhKlwtFnBvx5elx7r_rqfffG3tFbfcg3OA&s" alt="SE2 Silent Disco Logo">
      <h1>SE2 Silent Disco Tracker</h1>
    </header>
    <div class="button-group">
      <button onclick="showCheckout();vibrate()">Checkout - Handout Headphones</button>
      <button onclick="showReturn();vibrate()">Check In - Return Headphones</button>
      <button onclick="showDashboard();vibrate()">View Dashboard</button>
      <button onclick="showReports();vibrate()">View Reports</button>
      <button onclick="scanNFCStatus();vibrate()">Scan NFC Status</button>
    </div>

    <div id="checkout" class="form">
      <h2>Checkout Headphones</h2>
      <button id="scanCheckout" onclick="scanNFC('checkout');vibrate()">Scan NFC Tag</button>
      <input id="headphoneId" placeholder="Headphone ID (e.g., HP0000001)" readonly onclick="manualEntry('checkout');vibrate()">
      <button onclick="addHeadphoneId();vibrate()">Add Headphone ID</button>
      <ul id="headphoneIdsList"></ul>
      <input id="name" placeholder="Full Name">
      <input id="email" placeholder="Email">
      <input id="phone" placeholder="Phone Number">
      <textarea id="agreement" readonly>RENTAL AGREEMENT AND COLLATERAL TERMS

By signing below, I, [Customer Name], agree to rent the following wireless headphones ([Headphone IDs]) from SE2 Silent Disco DBA and SE2 Events Inc. ("the Company") for use during the event on [Date]. I acknowledge that the headphones remain the property of the Company and must be returned in good working condition at the end of the event or upon request.
I understand and agree that failure to return any headphone by the end of the event will result in a replacement fee of $100.00 USD per headphone ("Replacement Fee"). I authorize the Company to charge my credit card, provided below, the Replacement Fee for each headphone not returned or returned damaged beyond normal wear and tear.
LIABILITY RELEASE: I hereby release, waive, discharge, and agree not to sue SE2 Silent Disco DBA and SE2 Events Inc., its officers, employees, agents, or affiliates ("Released Parties") from any and all liability, claims, demands, actions, or causes of action arising out of or related to any loss, damage, or injury, including death, that may be sustained by me or my property while using the headphones or attending the event, whether caused by the negligence of the Released Parties or otherwise. I assume full responsibility for any risk of bodily injury, death, or property damage arising from my use of the headphones and participation in the event.
MARKETING CONSENT: I grant SE2 Silent Disco DBA and SE2 Events Inc. permission to use my email address and phone number provided herein for marketing purposes, including but not limited to sending promotional offers, event updates, and newsletters. I understand I may opt out of these communications at any time by following the unsubscribe instructions provided in such messages.
PHOTO/VIDEO CONSENT: I consent to being photographed or recorded in video or audio by SE2 Silent Disco DBA and SE2 Events Inc. during the event. I grant the Company full permission to use, reproduce, publish, and distribute such photographs, videos, or recordings, including my likeness, voice, or image, for marketing, advertising, or promotional purposes in any medium, without compensation or further notice to me.
This agreement constitutes a legally binding contract. I acknowledge that I have read and understood these terms, and I sign this agreement voluntarily under no duress. Any disputes arising from this agreement shall be governed by the laws of New York, USA.</textarea>
      <div id="paymentOptions">
        <button id="tapToPay" onclick="tapToPayCheckout();vibrate()">Tap Card to Checkout</button>
        <p>OR</p>
        <div id="card-container"></div>
      </div>
      <canvas id="signaturePad" width="300" height="150"></canvas>
      <button id="clearSignature" onclick="clearSignature();vibrate()">Clear Signature</button>
      <button id="checkoutButton" onclick="checkout();vibrate()">Complete Checkout</button>
    </div>

    <div id="return" class="form">
      <h2>Return Headphones</h2>
      <button id="scanReturn" onclick="scanNFC('return');vibrate()">Scan NFC Tag</button>
      <input id="returnId" placeholder="Headphone ID (e.g., HP0000001)" readonly onclick="showManualReturnDialog('return');vibrate()">
      <button onclick="addReturnHeadphoneId();vibrate()">Add Headphone ID</button>
      <ul id="returnHeadphoneIdsList"></ul>
      <button onclick="returnHeadphones();vibrate()">Return All</button>
    </div>

    <div id="dashboard" class="form">
      <h2>Dashboard</h2>
      <input id="searchInput" type="text" placeholder="Search headphones..." onkeyup="searchHeadphones()">
      <input id="dateFilter" type="date" onchange="filterByDate()">
      <div class="dashboard-table-wrapper">
        <table id="headphoneTable">
          <thead>
            <tr>
              <th>Actions</th>
              <th>Customer</th>
              <th>Status</th>
              <th>Preauth Status</th>
              <th>Email</th>
              <th>Phone</th>
              <th>ID</th>
              <th>NFC ID</th>
              <th>Entry Method</th>
              <th>Group ID</th>
              <th>Delete</th>
            </tr>
          </thead>
          <tbody id="headphoneList"></tbody>
        </table>
      </div>
    </div>

    <div id="reports" class="form">
      <h2>Reports</h2>
      <select id="reportType" onchange="generateReport()">
        <option value="">Select a Report</option>
        <option value="allData">All Data</option>
        <option value="checkedOut">Currently Checked Out Headphones</option>
        <option value="overdue">Overdue Headphones</option>
        <option value="revenue">Revenue Summary</option>
        <option value="customerActivity">Customer Activity</option>
        <option value="groupSummary">Group Checkout Summary</option>
        <option value="nfcUsage">NFC Usage Statistics</option>
      </select>
      <input id="reportStartDate" type="date" onchange="generateReport()" placeholder="Start Date">
      <input id="reportEndDate" type="date" onchange="generateReport()" placeholder="End Date">
      <input id="reportSearch" type="text" placeholder="Search reports..." onkeyup="generateReport()">
      <button onclick="exportReport()">Export as CSV</button>
      <div id="reportOutput"></div>
    </div>

    <div id="nfcStatus" class="form">
      <h2>NFC Status</h2>
      <p id="nfcStatusResult">Scan an NFC tag to see headphone status.</p>
    </div>

    <div id="returnDialog" class="dialog">
      <div id="returnDialogHeader" class="dialog-header">Return Headphones</div>
      <button id="dialogScanReturn" onclick="scanNFC('dialogReturn');vibrate()">Scan NFC Tag</button>
      <input id="dialogReturnId" placeholder="Headphone ID (e.g., HP0000001)" readonly onclick="showManualReturnDialog('dialogReturn');vibrate()">
      <button onclick="addDialogReturnHeadphoneId();vibrate()">Add Headphone ID</button>
      <ul id="dialogReturnHeadphoneIdsList"></ul>
      <button onclick="submitReturnDialog();vibrate()">Return All</button>
      <button onclick="closeDialog('return');vibrate()">Cancel</button>
    </div>

    <div id="manualReturnDialog" class="dialog">
      <div id="manualReturnDialogHeader" class="dialog-header">Select Headphones to Return</div>
      <input id="manualReturnSearch" type="text" placeholder="Search headphones..." onkeyup="filterManualReturnList()">
      <table id="manualReturnTable">
        <thead>
          <tr>
            <th>Select</th>
            <th>ID</th>
            <th>Customer</th>
            <th>Group ID</th>
          </tr>
        </thead>
        <tbody id="manualReturnList"></tbody>
      </table>
      <button onclick="submitManualReturn();vibrate()">Return Selected</button>
      <button onclick="closeDialog('manualReturn');vibrate()">Cancel</button>
    </div>

    <div id="dialogOverlay" class="dialog-overlay" onclick="closeDialog(null);vibrate()"></div>
    <div id="loadingOverlay" class="loading-overlay">
      <div class="spinner"></div>
    </div>
  </div>

  <script>
    const squareAppId='sandbox-sq0idb-qaDoxfFQK3OfUWlaCrgkDw';
    let headphones={},usedHeadphoneIds=new Set(),checkoutListIds=new Set(),signatureData=null,payments,cardElement,db,headphonesCollection,squareLocationId,firebaseConfig;

    async function fetchConfig(){try{const r=await fetch('/.netlify/functions/get-config');const c=await r.json();squareLocationId=c.squareLocationId;firebaseConfig=c.firebaseConfig;}catch(e){console.error('Failed to fetch config:',e);alert('Failed to load configuration.');}}

    async function waitForFirebase(){return new Promise(r=>{const m=100;let a=0;const i=setInterval(()=>{if(typeof firebase!=='undefined'&&firebase.app&&firebase.firestore||a>=m){clearInterval(i);if(firebase.app){firebase.initializeApp(firebaseConfig);db=firebase.firestore();headphonesCollection=db.collection('headphones');}r();}a++;},100);});}

    async function loadHeadphones(){if(!db||!headphonesCollection)return headphones;try{const s=await headphonesCollection.get();headphones={};usedHeadphoneIds=new Set();s.forEach(d=>{headphones[d.id]=d.data();if(headphones[d.id].status==='checked_out')usedHeadphoneIds.add(d.id);});return headphones;}catch(e){console.error('Error loading headphones:',e);alert('Failed to load data.');return headphones;}}

    async function saveHeadphone(id,data){try{if(db&&headphonesCollection)await headphonesCollection.doc(id).set(data);headphones[id]=data;if(data.status==='checked_out')usedHeadphoneIds.add(id);}catch(e){console.error('Error saving headphone:',e);throw e;}}

    async function updateHeadphone(id,data){try{if(db&&headphonesCollection)await headphonesCollection.doc(id).update(data);headphones[id]={...headphones[id],...data};if(data.status==='returned'||data.status==='charged')usedHeadphoneIds.delete(id);}catch(e){console.error('Error updating headphone:',e);alert('Failed to update data.');throw e;}}

    async function deleteHeadphone(id){try{if(confirm(`Are you sure you want to delete headphone ${id}?`)){if(db&&headphonesCollection)await headphonesCollection.doc(id).delete();delete headphones[id];usedHeadphoneIds.delete(id);checkoutListIds.delete(id);alert(`Headphone ${id} deleted!`);updateDashboard();}}catch(e){console.error('Error deleting headphone:',e);alert('Failed to delete headphone.');}}

    async function initializeSquare(){if(!window.Square)return;if(!payments)payments=window.Square.payments(squareAppId);const c=document.getElementById('card-container');c.innerHTML='';cardElement=await payments.card();await cardElement.attach('#card-container');return cardElement;}

    window.onload=async()=>{try{await fetchConfig();await waitForFirebase();await initializeSquare();await loadHeadphones();makeDraggable('returnDialog','returnDialogHeader');makeDraggable('manualReturnDialog','manualReturnDialogHeader');}catch(e){console.error('Initialization error:',e);alert('Failed to start app.');}};

    function vibrate(){if('vibrate' in navigator)navigator.vibrate(100);}

    function showLoading(){document.getElementById('loadingOverlay').style.display='flex';document.getElementById('checkoutButton').disabled=true;document.querySelectorAll('.charge-btn').forEach(b=>b.disabled=true);}

    function hideLoading(){document.getElementById('loadingOverlay').style.display='none';document.getElementById('checkoutButton').disabled=false;document.querySelectorAll('.charge-btn').forEach(b=>b.disabled=false);}

    function addHeadphoneId(){const id=document.getElementById('headphoneId').value.trim();if(!id)return alert('Please scan or enter a headphone ID!');const c=getHeadphoneIds('headphoneIdsList');if(c.includes(id))return alert(`Headphone ID ${id} is already in your checkout list!`);if(headphones[id]&&headphones[id].status==='checked_out')return alert(`Headphone ${id} is already checked out!`);const l=document.getElementById('headphoneIdsList');const li=document.createElement('li');li.innerHTML=`${id} <button class="remove-btn" onclick="removeHeadphoneId(this,'${id}')">Remove</button>`;l.appendChild(li);checkoutListIds.add(id);document.getElementById('headphoneId').value='';}

    function addReturnHeadphoneId(){const id=document.getElementById('returnId').value.trim();if(!id)return alert('Please scan or enter a headphone ID!');if(!headphones[id]||headphones[id].status!=='checked_out')return alert(`Headphone ${id} is not checked out!`);const l=document.getElementById('returnHeadphoneIdsList');const e=getReturnHeadphoneIds();if(e.includes(id))return alert(`Headphone ${id} already in return list!`);const li=document.createElement('li');li.innerHTML=`${id} <button class="remove-btn" onclick="removeHeadphoneId(this,'${id}')">Remove</button>`;li.dataset.id=id;l.appendChild(li);document.getElementById('returnId').value='';}

    function addDialogReturnHeadphoneId(){const id=document.getElementById('dialogReturnId').value.trim();if(!id)return alert('Please scan or enter a headphone ID!');if(!headphones[id]||headphones[id].status!=='checked_out')return alert(`Headphone ${id} is not checked out!`);const l=document.getElementById('dialogReturnHeadphoneIdsList');const e=getDialogReturnHeadphoneIds();if(e.includes(id))return alert(`Headphone ${id} already in return list!`);const li=document.createElement('li');li.innerHTML=`${id} <button class="remove-btn" onclick="removeHeadphoneId(this,'${id}')">Remove</button>`;li.dataset.id=id;l.appendChild(li);document.getElementById('dialogReturnId').value='';}

    function removeHeadphoneId(b,id){b.parentElement.remove();checkoutListIds.delete(id);}

    function getHeadphoneIds(l){return Array.from(document.getElementById(l).children).map(li=>li.textContent.split(' ')[0]);}

    function getReturnHeadphoneIds(){return Array.from(document.getElementById('returnHeadphoneIdsList').children).map(li=>li.dataset.id);}

    function getDialogReturnHeadphoneIds(){return Array.from(document.getElementById('dialogReturnHeadphoneIdsList').children).map(li=>li.dataset.id);}

    function generateGroupId(){const r=/^GROUP_\d{7}$/;const e=Object.values(headphones).filter(h=>h.groupId&&r.test(h.groupId)).map(h=>parseInt(h.groupId.replace('GROUP_',''),10));let n=1;if(e.length)n=Math.max(...e)+1;return `GROUP_${String(n).padStart(7,'0')}`;}

    function generateUniqueHeadphoneId(){const r=/^HP\d{7}$/;const a=new Set([...usedHeadphoneIds,...checkoutListIds]);const e=Array.from(a).filter(id=>r.test(id));let n=1;if(e.length)n=Math.max(...e.map(id=>parseInt(id.replace('HP',''),10)))+1;return `HP${String(n).padStart(7,'0')}`;}

    async function showCheckout(){toggleForms('checkout');initSignaturePad('signaturePad');await initializeSquare();document.getElementById('headphoneIdsList').innerHTML='';checkoutListIds.clear();}

    function showReturn(){toggleForms('return');document.getElementById('returnHeadphoneIdsList').innerHTML='';}

    async function showDashboard(){toggleForms('dashboard');await loadHeadphones();updateDashboard();}

    async function showReports(){toggleForms('reports');await loadHeadphones();document.getElementById('reportType').value='';document.getElementById('reportStartDate').value='';document.getElementById('reportEndDate').value='';document.getElementById('reportSearch').value='';document.getElementById('reportOutput').innerHTML='<p>Select a report type to view details.</p>';}

    async function scanNFCStatus(){toggleForms('nfcStatus');const r=document.getElementById('nfcStatusResult');r.textContent='Scanning...';if(!('NDEFReader' in window)){r.textContent='NFC not supported.';return;}const n=new NDEFReader();try{await n.scan();const c=new AbortController();n.onreading=e=>{const id=e.serialNumber||prompt('Enter headphone ID manually:');if(id&&headphones[id]){const h=headphones[id];r.innerHTML=`<strong>ID:</strong> ${id}<br><strong>NFC ID:</strong> ${h.nfcId||'N/A'}<br><strong>Status:</strong> ${h.status==='checked_out'?'Checked Out':h.status==='returned'?'Returned':'Charged'}<br><strong>Customer:</strong> ${h.customer.name}<br><strong>Email:</strong> ${h.customer.email}<br><strong>Phone:</strong> ${h.customer.phone}<br><strong>Preauth Status:</strong> ${h.pre_auth?'Hold':'Released'}<br><strong>Entry Method:</strong> ${h.entryMethod||'N/A'}<br><strong>Date:</strong> ${h.agreement.date||'N/A'}<br><strong>Group ID:</strong> ${h.groupId||'Single'}`;}else{r.textContent=`Headphone ${id} not found.`;}c.abort();};n.onreadingerror=()=>{r.textContent='NFC scan failed. Try again.';c.abort();};setTimeout(()=>{c.abort();if(r.textContent==='Scanning...')r.textContent='Scan timed out.';},5000);await new Promise(r=>c.signal.addEventListener('abort',r));}catch(e){r.textContent=`Error: ${e.message}`;}}

    function toggleForms(a){['checkout','return','dashboard','nfcStatus','reports'].forEach(id=>document.getElementById(id).style.display=id===a?'flex':'none');document.getElementById('returnDialog').style.display='none';document.getElementById('manualReturnDialog').style.display='none';document.getElementById('dialogOverlay').style.display='none';}

    async function scanNFC(c){const b=document.getElementById(c==='checkout'?'scanCheckout':c==='return'?'scanReturn':'dialogScanReturn'),i=document.getElementById(c==='checkout'?'headphoneId':c==='return'?'returnId':'dialogReturnId'),r=/^HP\d{7}$/;b.disabled=true;if(!('NDEFReader'in window)){alert('NFC not supported. Enter ID manually.');c==='checkout'?manualEntry(c):showManualReturnDialog(c);b.disabled=false;return;}const n=new NDEFReader();try{await n.scan();const co=new AbortController();n.onreading=e=>{const ni=e.serialNumber;let id;if(c==='checkout'){id=generateUniqueHeadphoneId();i.dataset.nfcId=ni;}else{id=prompt('Enter headphone ID for this NFC tag (e.g., HP0000001):');if(!id||!r.test(id)){alert('Invalid ID format. Use HP followed by 7 digits.');co.abort();b.disabled=false;return;}}i.value=id;i.dataset.entryMethod='NFC';alert(`Scanned headphone: ${id} with NFC ID: ${ni}`);co.abort();b.disabled=false;if(c==='return')addReturnHeadphoneId();else if(c==='dialogReturn')addDialogReturnHeadphoneId();else addHeadphoneId();};n.onreadingerror=()=>{alert('No NFC tag detected. Try again or enter manually.');c==='checkout'?manualEntry(c):showManualReturnDialog(c);co.abort();b.disabled=false;};setTimeout(()=>{co.abort();if(!b.disabled)return;alert('Scan timed out. Try again or enter manually.');c==='checkout'?manualEntry(c):showManualReturnDialog(c);b.disabled=false;},5000);await new Promise(r=>co.signal.addEventListener('abort',r));}catch(e){alert(`NFC error: ${e.message}. Enter ID manually.`);c==='checkout'?manualEntry(c):showManualReturnDialog(c);b.disabled=false;}}

    function manualEntry(c){const i=document.getElementById(c==='checkout'?'headphoneId':c==='return'?'returnId':'dialogReturnId'),b=document.getElementById(c==='checkout'?'scanCheckout':c==='return'?'scanReturn':'dialogScanReturn'),r=/^HP\d{7}$/;let id;if(c==='checkout'){const s=generateUniqueHeadphoneId();const u=prompt(`Enter headphone ID (suggested: ${s}):`,s);if(!u||!r.test(u)){alert('Invalid ID format. Use HP followed by 7 digits.');b.disabled=false;return;}if(headphones[u]&&headphones[u].status==='checked_out'){alert(`ID ${u} is already checked out!`);b.disabled=false;return;}if(checkoutListIds.has(u)){alert(`ID ${u} is already in your checkout list!`);b.disabled=false;return;}id=u;}else{id=prompt('Enter headphone ID (e.g., HP0000001):');if(!id||!r.test(id)){alert('Invalid ID format. Use HP followed by 7 digits.');b.disabled=false;return;}}i.value=id;i.dataset.entryMethod='Manual';b.disabled=false;if(c==='return')addReturnHeadphoneId();else if(c==='dialogReturn')addDialogReturnHeadphoneId();else addHeadphoneId();}

    function showManualReturnDialog(c){const d=document.getElementById('manualReturnDialog'),o=document.getElementById('dialogOverlay'),l=document.getElementById('manualReturnList'),co=Object.entries(headphones).filter(([_,h])=>h.status==='checked_out');d.style.display='flex';o.style.display='block';l.innerHTML='';co.forEach(([id,h])=>{const r=document.createElement('tr');r.innerHTML=`<td><input type="checkbox" name="returnHeadphone" value="${id}"></td><td>${id}</td><td>${h.customer.name}</td><td>${h.groupId||'Single'}</td>`;l.appendChild(r);});document.getElementById('manualReturnSearch').value='';document.getElementById('manualReturnSearch').dataset.context=c;}

    function filterManualReturnList(){const s=document.getElementById('manualReturnSearch').value.toLowerCase(),r=document.getElementById('manualReturnList').getElementsByTagName('tr');Array.from(r).forEach(row=>row.style.display=row.textContent.toLowerCase().includes(s)?'':'none');}

    async function submitManualReturn(){const s=Array.from(document.getElementById('manualReturnList').querySelectorAll('input[name="returnHeadphone"]:checked')).map(i=>i.value),c=document.getElementById('manualReturnSearch').dataset.context;if(!s.length)return alert('Please select at least one headphone!');const g=s.map(id=>headphones[id].groupId||'Single');if(new Set(g).size>1)return alert('All selected headphones must belong to the same group.');try{for(const id of s)await updateHeadphone(id,{status:'returned',pre_auth:null});const m=await sendReturnEmail(s);alert(m);closeDialog('manualReturn');if(c==='dialogReturn')closeDialog('return');else showDashboard();}catch(e){alert('Failed to return headphones: '+e.message);}}

    function initSignaturePad(c){const ca=document.getElementById(c),ctx=ca.getContext('2d');let d=false;ctx.lineWidth=2;ctx.lineCap='round';ctx.strokeStyle='#000';function s(e){d=true;ctx.beginPath();const{x,y}=g(e);ctx.moveTo(x,y);e.preventDefault();}function dr(e){if(!d)return;const{x,y}=g(e);ctx.lineTo(x,y);ctx.stroke();e.preventDefault();}function st(){if(d){d=false;if(c==='signaturePad')signatureData=ca.toDataURL();}}function g(e){const r=ca.getBoundingClientRect(),t=e.touches?e.touches[0]:e;return{x:t.clientX-r.left,y:t.clientY-r.top};}ca.addEventListener('mousedown',s);ca.addEventListener('mousemove',dr);ca.addEventListener('mouseup',st);ca.addEventListener('touchstart',s);ca.addEventListener('touchmove',dr);ca.addEventListener('touchend',st);}

    function clearSignature(){const c=document.getElementById('signaturePad'),ctx=c.getContext('2d');ctx.clearRect(0,0,c.width,c.height);signatureData=null;}

    async function tapToPayCheckout(){if(!('NDEFReader'in window))return alert('NFC not supported. Use manual entry.');const n=new NDEFReader();try{showLoading();await n.scan();const c=new AbortController();n.onreading=async e=>{const ni=e.serialNumber,pt='cnon:card-nonce-ok';await processPayment(pt);c.abort();};n.onreadingerror=()=>{alert('Failed to read payment card. Try again or use manual entry.');c.abort();hideLoading();};setTimeout(()=>{c.abort();if(!c.signal.aborted){alert('Payment scan timed out.');hideLoading();}},5000);await new Promise(r=>c.signal.addEventListener('abort',r));}catch(e){alert(`NFC error: ${e.message}. Use manual entry.`);hideLoading();}}

    async function processPayment(pt){const h=getHeadphoneIds('headphoneIdsList'),n=document.getElementById('name').value,e=document.getElementById('email').value,p=document.getElementById('phone').value,d=new Date().toISOString().split('T')[0];if(!h.length||!n||!e||!p||!signatureData){hideLoading();return alert('Please complete all fields and sign the agreement!');}const g=h.length>1?generateGroupId():null;let s=[];try{const r=await fetch('/.netlify/functions/preauthorize',{method:'POST',headers:{'Content-Type':'application/json'},body:JSON.stringify({sourceId:pt,amount:h.length*10000,currency:'USD',locationId:squareLocationId})}),res=await r.json();if(!r.ok)throw new Error(res.error||'Preauthorization failed');const pi=res.paymentId;for(const id of h){if(headphones[id]&&headphones[id].status==='checked_out'){alert(`Headphone ID ${id} is already checked out! Skipping.`);continue;}const em=document.getElementById('headphoneId').dataset.entryMethod||'Manual',ni=document.getElementById('headphoneId').dataset.nfcId,data={status:'checked_out',customer:{name:n,email:e,phone:p},agreement:{text:document.getElementById('agreement').value.replace('[Customer Name]',n).replace('[Date]',d).replace('[Headphone IDs]',h.join(', ')),signature:signatureData,amount:100,date:d,timestamp:Date.now()},pre_auth:{pre_auth_id:pi,amount:h.length*100},entryMethod:em,nfcId:ni||null};if(g)data.groupId=g;await saveHeadphone(id,data);s.push(id);}if(s.length>0){const ht=s.join(', '),at=document.getElementById('agreement').value.replace('[Customer Name]',n).replace('[Date]',d).replace('[Headphone IDs]',ht),er=await fetch('/.netlify/functions/send-email',{method:'POST',headers:{'Content-Type':'application/json'},body:JSON.stringify({name:n,email:e,agreement:at,signature:signatureData,preauthId:pi})});if(!er.ok)throw new Error('Email failed');alert(`Headphones ${ht} checked out! Agreement emailed to ${e}.`);}else{alert('No headphones were checked out due to existing usage.');}clearForm('checkout');showDashboard();}catch(e){console.error('Payment error:',e.message);alert('Payment failed: '+e.message);}finally{hideLoading();}}

    async function checkout(){const h=getHeadphoneIds('headphoneIdsList'),n=document.getElementById('name').value,e=document.getElementById('email').value,p=document.getElementById('phone').value,d=new Date().toISOString().split('T')[0];if(!h.length||!n||!e||!p||!signatureData||!cardElement)return alert('Please complete all fields, enter card details, and sign!');showLoading();try{const r=await cardElement.tokenize();if(r.status!=='OK')throw new Error('Card tokenization failed.');await processPayment(r.token);}catch(e){console.error('Checkout error:',e.message);alert('Checkout failed: '+e.message);}finally{hideLoading();}}

    async function sendReturnEmail(r){const c=headphones[r[0]].customer||{name:'Customer',email:''},hl=r.join(', '),eb=`Dear ${c.name||'Customer'},\n\nThank you for attending our Silent Disco event with SE2 Silent Disco! We hope you had an amazing experience. We're pleased to confirm that we've received the following headphone(s): ${hl}. \n\nYou are no longer responsible for these items, and any associated payment holds have been released. We appreciate your prompt return and hope to see you at future events!\n\nFor any questions, contact us at:\n- Website: www.se2.events\n- Email: se2login@gmail.com\n\nBest regards,\nThe SE2 Silent Disco Team`,ep={name:c.name||'Customer',email:c.email||'',agreement:eb,signature:'',preauthId:''};const er=await fetch('/.netlify/functions/send-email',{method:'POST',headers:{'Content-Type':'application/json'},body:JSON.stringify(ep)});if(!er.ok){const et=await er.text();console.error('Failed to send return email:',et);return `Headphone(s) ${r.join(', ')} returned, but email failed: ${et}`;}return `Headphone(s) ${r.join(', ')} returned! Confirmation emailed to ${c.email||'customer'}.`;}

    async function returnHeadphones(){const h=getReturnHeadphoneIds();if(!h.length)return alert('Scan or add at least one headphone!');const g=h.map(id=>headphones[id]?.groupId||null),ug=[...new Set(g.filter(id=>id!==null))],hg=g.some(id=>id!==null),hs=g.some(id=>id===null);if((hg&&hs)||(ug.length>1)){const m=h.filter(id=>{const gi=headphones[id]?.groupId||null;return(hg&&gi===null)||(ug.length>1&&gi!==ug[0]&&gi!==null);});alert(`All headphones must belong to the same group or all be singles. Mismatched: ${m.map(id=>`${id} (Group: ${headphones[id]?.groupId||'Single'})`).join(', ')}.`);const l=document.getElementById('returnHeadphoneIdsList');Array.from(l.children).forEach(li=>li.style.backgroundColor=m.includes(li.dataset.id)?'#ffcccc':'');return;}try{let r=[];for(const id of h){if(!headphones[id]||headphones[id].status!=='checked_out'){alert(`Headphone ${id} not checked out! Skipping.`);continue;}await updateHeadphone(id,{status:'returned',pre_auth:null});r.push(id);}if(r.length){const m=await sendReturnEmail(r);alert(m);}else alert('No headphones returned.');clearForm('return');showDashboard();}catch(e){console.error('Return error:',e.message);alert('Failed to return headphones: '+e.message);}}

    function showReturnDialog(id){document.getElementById('dialogReturnId').value=id;document.getElementById('returnDialog').style.display='flex';document.getElementById('dialogOverlay').style.display='block';document.getElementById('dialogReturnHeadphoneIdsList').innerHTML='';if(id)addDialogReturnHeadphoneId();}

    function closeDialog(t){if(t==='return')document.getElementById('returnDialog').style.display='none';else if(t==='manualReturn')document.getElementById('manualReturnDialog').style.display='none';document.getElementById('dialogOverlay').style.display='none';if(t!=='manualReturn')showDashboard();}

    async function submitReturnDialog(){const h=getDialogReturnHeadphoneIds();if(!h.length)return alert('Scan or add at least one headphone!');const g=h.map(id=>headphones[id]?.groupId||null),ug=[...new Set(g.filter(id=>id!==null))],hg=g.some(id=>id!==null),hs=g.some(id=>id===null);if((hg&&hs)||(ug.length>1)){const m=h.filter(id=>{const gi=headphones[id]?.groupId||null;return(hg&&gi===null)||(ug.length>1&&gi!==ug[0]&&gi!==null);});alert(`All headphones must belong to the same group or all be singles. Mismatched: ${m.map(id=>`${id} (Group: ${headphones[id]?.groupId||'Single'})`).join(', ')}.`);const l=document.getElementById('dialogReturnHeadphoneIdsList');Array.from(l.children).forEach(li=>li.style.backgroundColor=m.includes(li.dataset.id)?'#ffcccc':'');return;}try{let r=[];for(const id of h){if(!headphones[id]||headphones[id].status!=='checked_out'){alert(`Headphone ${id} not checked out! Skipping.`);continue;}await updateHeadphone(id,{status:'returned',pre_auth:null});r.push(id);}if(r.length){const m=await sendReturnEmail(r);alert(m);}else alert('No headphones returned.');closeDialog('return');}catch(e){console.error('Return error:',e.message);alert('Failed to return headphones: '+e.message);}}

    async function dashboardCharge(id){if(!headphones[id]||headphones[id].status!=='checked_out'||!headphones[id].pre_auth)return alert(`Cannot charge ${id}: Not checked out or no preauthorization.`);const g=headphones[id].groupId,c=g?Object.values(headphones).filter(h=>h.groupId===g&&h.status==='checked_out').length:1,a=Math.round(headphones[id].pre_auth.amount*100/c),ad=(a/100).toFixed(2);if(!confirm(`Charge ${headphones[id].customer.name} $${ad} for ${id}?`))return;showLoading();try{const r=await fetch('/.netlify/functions/capture-payment',{method:'POST',headers:{'Content-Type':'application/json'},body:JSON.stringify({paymentId:headphones[id].pre_auth.pre_auth_id,amount:a})}),res=await r.json();if(!r.ok)throw new Error(res.error||'Charge failed');await updateHeadphone(id,{status:'charged',pre_auth:null});alert(`Headphone ${id} charged for $${ad}!`);updateDashboard();}catch(e){alert(`Charge failed for ${id}: ${e.message}`);}finally{hideLoading();}}

    function updateDashboard(){const t=document.getElementById('headphoneList'),s=document.getElementById('searchInput').value.toLowerCase(),d=document.getElementById('dateFilter').value,n=Date.now(),tw=12*60*60*1000;const ha=Object.entries(headphones).map(([id,h])=>({id,...h})),co=ha.filter(h=>h.status==='checked_out'),ci=ha.filter(h=>h.status!=='checked_out');co.sort((a,b)=>(a.customer?.name||'N/A').localeCompare(b.customer?.name||'N/A'));ci.sort((a,b)=>(a.customer?.name||'N/A').localeCompare(b.customer?.name||'N/A'));const sa=[...co,...ci];t.innerHTML='';sa.forEach(hp=>{const st=hp.status==='checked_out'?'Checked Out':hp.status==='returned'?'Returned':'Charged',o=hp.status==='checked_out'&&(n-(hp.agreement?.timestamp||n)>tw),rd=[hp.customer?.name||'N/A',st,hp.pre_auth?'Hold':'Released',hp.customer?.email||'N/A',hp.customer?.phone||'N/A',hp.id,hp.nfcId||'N/A',hp.entryMethod||'N/A',hp.agreement?.date||'N/A',hp.groupId||'Single'];if(rd.some(d=>d.toLowerCase().includes(s))&&(!d||hp.agreement?.date===d)){const r=document.createElement('tr');let a='';if(hp.status==='checked_out')a+=`<button class="checkin-btn" onclick="showReturnDialog('${hp.id}')">Check In</button>`;if(hp.status==='checked_out'&&hp.pre_auth&&o)a+=`<button class="charge-btn" onclick="dashboardCharge('${hp.id}')">Charge</button>`;r.innerHTML=`<td>${a}</td><td>${hp.customer?.name||'N/A'}</td><td>${st}</td><td>${hp.pre_auth?'Hold':'Released'}</td><td>${hp.customer?.email||'N/A'}</td><td>${hp.customer?.phone||'N/A'}</td><td>${hp.id}</td><td>${hp.nfcId||'N/A'}</td><td>${hp.entryMethod||'N/A'}</td><td>${hp.groupId||'Single'}</td><td><button class="delete-btn" onclick="deleteHeadphone('${hp.id}')">Delete</button></td>`;t.appendChild(r);}});}

    function searchHeadphones(){updateDashboard();}
    function filterByDate(){updateDashboard();}

    function clearForm(f){document.getElementById(f).querySelectorAll('input').forEach(i=>{i.value='';delete i.dataset.nfcId;delete i.dataset.entryMethod;});if(f==='checkout'){document.getElementById('card-container').innerHTML='';document.getElementById('headphoneIdsList').innerHTML='';checkoutListIds.clear();initializeSquare();}else if(f==='return')document.getElementById('returnHeadphoneIdsList').innerHTML='';}

    function generateReport(){const rt=document.getElementById('reportType').value,sd=document.getElementById('reportStartDate').value,ed=document.getElementById('reportEndDate').value||sd,st=document.getElementById('reportSearch').value.toLowerCase(),o=document.getElementById('reportOutput');o.innerHTML='';if(!rt){o.innerHTML='<p>Select a report type to view details.</p>';return;}const ha=Object.entries(headphones).map(([id,h])=>({id,...h})),n=Date.now(),tw=12*60*60*1000;let fa=ha;if(sd){const s=new Date(sd).setHours(0,0,0,0),e=new Date(ed).setHours(23,59,59,999);fa=ha.filter(h=>new Date(h.agreement?.date).setHours(0,0,0,0)>=s&&new Date(h.agreement?.date).setHours(0,0,0,0<=e);}let f=fa;if(st)f=fa.filter(h=>[h.id,h.nfcId||'',h.status,h.customer?.name||'',h.customer?.email||'',h.customer?.phone||'',h.agreement?.date||'',h.pre_auth?'Hold':'Released',h.entryMethod||'N/A',h.groupId||'Single'].some(d=>d.toLowerCase().includes(st)));switch(rt){case'allData':o.innerHTML=`<h3>All Data (${f.length} Headphones)</h3><p>Date Range: ${sd||'All'} to ${ed||'All'}</p><table><thead><tr><th>ID</th><th>NFC ID</th><th>Status</th><th>Customer</th><th>Email</th><th>Phone</th><th>Checkout Date</th><th>Preauth Status</th><th>Entry Method</th><th>Group ID</th></tr></thead><tbody>${f.map(h=>`<tr><td>${h.id}</td><td>${h.nfcId||'N/A'}</td><td>${h.status==='checked_out'?'Checked Out':h.status==='returned'?'Returned':'Charged'}</td><td>${h.customer?.name||'N/A'}</td><td>${h.customer?.email||'N/A'}</td><td>${h.customer?.phone||'N/A'}</td><td>${h.agreement?.date||'N/A'}</td><td>${h.pre_auth?'Hold':'Released'}</td><td>${h.entryMethod||'N/A'}</td><td>${h.groupId||'Single'}</td></tr>`).join('')}</tbody></table>`;break;case'checkedOut':const co=f.filter(h=>h.status==='checked_out');o.innerHTML=`<h3>Currently Checked Out (${co.length})</h3><p>Date Range: ${sd||'All'} to ${ed||'All'}</p><table><thead><tr><th>ID</th><th>NFC ID</th><th>Customer</th><th>Email</th><th>Phone</th><th>Checkout Date</th><th>Entry Method</th><th>Group ID</th></tr></thead><tbody>${co.map(h=>`<tr><td>${h.id}</td><td>${h.nfcId||'N/A'}</td><td>${h.customer.name}</td><td>${h.customer.email}</td><td>${h.customer.phone}</td><td>${h.agreement.date}</td><td>${h.entryMethod||'N/A'}</td><td>${h.groupId||'Single'}</td></tr>`).join('')}</tbody></table>`;break;case'overdue':const ov=f.filter(h=>h.status==='checked_out'&&(n-h.agreement.timestamp>tw));o.innerHTML=`<h3>Overdue Headphones (${ov.length})</h3><p>Date Range: ${sd||'All'} to ${ed||'All'}</p><table><thead><tr><th>ID</th><th>NFC ID</th><th>Customer</th><th>Email</th><th>Phone</th><th>Checkout Date</th><th>Days Overdue</th><th>Entry Method</th><th>Group ID</th></tr></thead><tbody>${ov.map(h=>`<tr><td>${h.id}</td><td>${h.nfcId||'N/A'}</td><td>${h.customer.name}</td><td>${h.customer.email}</td><td>${h.customer.phone}</td><td>${h.agreement.date}</td><td>${Math.floor((n-h.agreement.timestamp)/(1000*60*60*24))}</td><td>${h.entryMethod||'N/A'}</td><td>${h.groupId||'Single'}</td></tr>`).join('')}</tbody></table>`;break;case'revenue':const ch=f.filter(h=>h.status==='charged');o.innerHTML=`<h3>Revenue Summary</h3><p>Date Range: ${sd||'All'} to ${ed||'All'}</p><p>Total Revenue: $${(ch.length*100).toFixed(2)}</p><table><thead><tr><th>ID</th><th>NFC ID</th><th>Customer</th><th>Email</th><th>Phone</th><th>Charge Date</th><th>Amount</th><th>Entry Method</th><th>Group ID</th></tr></thead><tbody>${ch.map(h=>`<tr><td>${h.id}</td><td>${h.nfcId||'N/A'}</td><td>${h.customer.name}</td><td>${h.customer.email}</td><td>${h.customer.phone}</td><td>${h.agreement.date}</td><td>$100.00</td><td>${h.entryMethod||'N/A'}</td><td>${h.groupId||'Single'}</td></tr>`).join('')}</tbody></table>`;break;case'customerActivity':const cu={};f.forEach(h=>{const k=`${h.customer.name}|${h.customer.email}|${h.customer.phone}`;if(!cu[k])cu[k]={name:h.customer.name,email:h.customer.email,phone:h.customer.phone,checkouts:0,headphones:[]};cu[k].checkouts++;cu[k].headphones.push(h.id);});o.innerHTML=`<h3>Customer Activity</h3><p>Date Range: ${sd||'All'} to ${ed||'All'}</p><table><thead><tr><th>Name</th><th>Email</th><th>Phone</th><th>Total Checkouts</th><th>Headphone IDs</th></tr></thead><tbody>${Object.values(cu).map(c=>`<tr><td>${c.name}</td><td>${c.email}</td><td>${c.phone}</td><td>${c.checkouts}</td><td>${c.headphones.join(', ')}</td></tr>`).join('')}</tbody></table>`;break;case'groupSummary':const gr={};f.forEach(h=>{if(h.groupId){if(!gr[h.groupId])gr[h.groupId]={ids:[],customer:h.customer,total:0,checkedOut:0,returned:0,charged:0};gr[h.groupId].ids.push(h.id);gr[h.groupId].total++;if(h.status==='checked_out')gr[h.groupId].checkedOut++;if(h.status==='returned')gr[h.groupId].returned++;if(h.status==='charged')gr[h.groupId].charged++;}});o.innerHTML=`<h3>Group Checkout Summary</h3><p>Date Range: ${sd||'All'} to ${ed||'All'}</p><table><thead><tr><th>Group ID</th><th>Customer</th><th>Email</th><th>Total Headphones</th><th>Checked Out</th><th>Returned</th><th>Charged</th><th>Headphone IDs</th></tr></thead><tbody>${Object.entries(gr).map(([id,g])=>`<tr><td>${id}</td><td>${g.customer.name}</td><td>${g.customer.email}</td><td>${g.total}</td><td>${g.checkedOut}</td><td>${g.returned}</td><td>${g.charged}</td><td>${g.ids.join(', ')}</td></tr>`).join('')}</tbody></table>`;break;case'nfcUsage':const ns={};f.forEach(h=>{if(h.nfcId){if(!ns[h.nfcId])ns[h.nfcId]={uses:0,headphoneIds:[],dates:[]};ns[h.nfcId].uses++;ns[h.nfcId].headphoneIds.push(h.id);ns[h.nfcId].dates.push(h.agreement.date);}});o.innerHTML=`<h3>NFC Usage Statistics</h3><p>Date Range: ${sd||'All'} to ${ed||'All'}</p><table><thead><tr><th>NFC ID</th><th>Total Uses</th><th>Headphone IDs</th><th>Dates Used</th></tr></thead><tbody>${Object.entries(ns).map(([id,s])=>`<tr><td>${id}</td><td>${s.uses}</td><td>${s.headphoneIds.join(', ')}</td><td>${s.dates.join(', ')}</td></tr>`).join('')}</tbody></table>`;break;default:o.innerHTML='<p>Invalid report type.</p>';}}

    function exportReport(){const rt=document.getElementById('reportType').value;if(!rt)return alert('Select a report type first!');const sd=document.getElementById('reportStartDate').value,ed=document.getElementById('reportEndDate').value||sd;let fa=Object.entries(headphones).map(([id,h])=>({id,...h}));if(sd){const s=new Date(sd).setHours(0,0,0,0),e=new Date(ed).setHours(23,59,59,999);fa=fa.filter(h=>new Date(h.agreement?.date).setHours(0,0,0,0>=s&&new Date(h.agreement?.date).setHours(0,0,0,0<=e);}const n=Date.now(),tw=12*60*60*1000;let c='';switch(rt){case'allData':c='"ID","NFC ID","Status","Customer","Email","Phone","Checkout Date","Preauth Status","Entry Method","Group ID"\n'+fa.map(h=>`"${h.id}","${h.nfcId||'N/A'}","${h.status==='checked_out'?'Checked Out':h.status==='returned'?'Returned':'Charged'}","${h.customer?.name||'N/A'}","${h.customer?.email||'N/A'}","${h.customer?.phone||'N/A'}","${h.agreement?.date||'N/A'}","${h.pre_auth?'Hold':'Released'}","${h.entryMethod||'N/A'}","${h.groupId||'Single'}"`).join('\n');break;case'checkedOut':c='"ID","NFC ID","Customer","Email","Phone","Checkout Date","Entry Method","Group ID"\n'+fa.filter(h=>h.status==='checked_out').map(h=>`"${h.id}","${h.nfcId||'N/A'}","${h.customer.name}","${h.customer.email}","${h.customer.phone}","${h.agreement.date}","${h.entryMethod||'N/A'}","${h.groupId||'Single'}"`).join('\n');break;case'overdue':c='"ID","NFC ID","Customer","Email","Phone","Checkout Date","Days Overdue","Entry Method","Group ID"\n'+fa.filter(h=>h.status==='checked_out'&&(n-h.agreement.timestamp>tw)).map(h=>`"${h.id}","${h.nfcId||'N/A'}","${h.customer.name}","${h.customer.email}","${h.customer.phone}","${h.agreement.date}","${Math.floor((n-h.agreement.timestamp)/(1000*60*60*24))}","${h.entryMethod||'N/A'}","${h.groupId||'Single'}"`).join('\n');break;case'revenue':c='"ID","NFC ID","Customer","Email","Phone","Charge Date","Amount","Entry Method","Group ID"\n'+fa.filter(h=>h.status==='charged').map(h=>`"${h.id}","${h.nfcId||'N/A'}","${h.customer.name}","${h.customer.email}","${h.customer.phone}","${h.agreement.date}","$100.00","${h.entryMethod||'N/A'}","${h.groupId||'Single'}"`).join('\n');break;case'customerActivity':const cu={};fa.forEach(h=>{const k=`${h.customer.name}|${h.customer.email}|${h.customer.phone}`;if(!cu[k])cu[k]={name:h.customer.name,email:h.customer.email,phone:h.customer.phone,checkouts:0,headphones:[]};cu[k].checkouts++;cu[k].headphones.push(h.id);});c='"Name","Email","Phone","Total Checkouts","Headphone IDs"\n'+Object.values(cu).map(c=>`"${c.name}","${c.email}","${c.phone}","${c.checkouts}","${c.headphones.join(', ')}"`).join('\n');break;case'groupSummary':const gr={};fa.forEach(h=>{if(h.groupId){if(!gr[h.groupId])gr[h.groupId]={ids:[],customer:h.customer,total:0,checkedOut:0,returned:0,charged:0};gr[h.groupId].ids.push(h.id);gr[h.groupId].total++;if(h.status==='checked_out')gr[h.groupId].checkedOut++;if(h.status==='returned')gr[h.groupId].returned++;if(h.status==='charged')gr[h.groupId].charged++;}});c='"Group ID","Customer","Email","Total Headphones","Checked Out","Returned","Charged","Headphone IDs"\n'+Object.entries(gr).map(([id,g])=>`"${id}","${g.customer.name}","${g.customer.email}","${g.total}","${g.checkedOut}","${g.returned}","${g.charged}","${g.ids.join(', ')}"`).join('\n');break;case'nfcUsage':const ns={};fa.forEach(h=>{if(h.nfcId){if(!ns[h.nfcId])ns[h.nfcId]={uses:0,headphoneIds:[],dates:[]};ns[h.nfcId].uses++;ns[h.nfcId].headphoneIds.push(h.id);ns[h.nfcId].dates.push(h.agreement.date);}});c='"NFC ID","Total Uses","Headphone IDs","Dates Used"\n'+Object.entries(ns).map(([id,s])=>`"${id}","${s.uses}","${s.headphoneIds.join(', ')}","${s.dates.join(', ')}"`).join('\n');break;}const b=new Blob([c],{type:'text/csv;charset=utf-8;'});const l=document.createElement('a');l.href=URL.createObjectURL(b);l.download=`${rt}_report_${sd||'all'}_${ed||'all'}.csv`;document.body.appendChild(l);l.click();document.body.removeChild(l);}

    function makeDraggable(d,h){const di=document.getElementById(d),he=document.getElementById(h);let i=false,cx=di.offsetLeft,cy=di.offsetTop,ix,iy;function s(e){i=true;ix=(e.type==='mousedown'?e.clientX:e.touches[0].clientX)-cx;iy=(e.type==='mousedown'?e.clientY:e.touches[0].clientY)-cy;he.style.cursor='grabbing';}function dr(e){if(!i)return;e.preventDefault();cx=(e.type==='mousemove'?e.clientX:e.touches[0].clientX)-ix;cy=(e.type==='mousemove'?e.clientY:e.touches[0].clientY)-iy;di.style.left=`${cx}px`;di.style.top=`${cy}px`;di.style.transform='none';}function st(){i=false;he.style.cursor='move';}he.addEventListener('mousedown',s);document.addEventListener('mousemove',dr);document.addEventListener('mouseup',st);he.addEventListener('touchstart',s);document.addEventListener('touchmove',dr);document.addEventListener('touchend',st);}
  </script>
</body>
</html>
