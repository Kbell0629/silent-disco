<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Silent Disco Tracker</title>
  <style>
    body { font-family: Arial, sans-serif; text-align: center; padding: 20px; }
    button { padding: 15px; font-size: 18px; margin: 10px; background-color: #007bff; color: white; border: none; border-radius: 5px; }
    .form { display: none; flex-direction: column; gap: 10px; max-width: 400px; margin: 20px auto; }
    input, textarea { padding: 10px; font-size: 16px; }
    #statusList { text-align: left; }
    #signaturePad { border: 2px solid #000; background: #f0f0f0; width: 300px; height: 150px; margin: 10px auto; }
    #clearSignature { font-size: 14px; padding: 10px; background: #ff4444; }
  </style>
</head>
<body>
  <h1>Silent Disco Headphone Tracker</h1>
  <button onclick="showCheckout(); vibrate()">Checkout Headphone</button>
  <button onclick="showReturn(); vibrate()">Return Headphone</button>
  <button onclick="showStatus(); vibrate()">View Status</button>

  <div id="checkout" class="form">
    <h2>Checkout</h2>
    <button id="scanCheckout" onclick="scanNFC('checkout'); vibrate()">Scan NFC Tag</button>
    <input id="headphoneId" placeholder="Headphone ID (e.g., HP123)" readonly>
    <input id="name" placeholder="Full Name">
    <input id="email" placeholder="Email">
    <input id="phone" placeholder="Phone Number">
    <textarea id="agreement" readonly rows="12">RENTAL AGREEMENT AND COLLATERAL TERMS

By signing below, I, [Customer Name], agree to rent one (1) pair of wireless headphones from SE2 Silent Disco DBA and SE2 Events Inc. ("the Company") for use during the event on [Date]. I acknowledge that the headphones remain the property of the Company and must be returned in good working condition at the end of the event or upon request.

I understand and agree that failure to return the headphones by the end of the event will result in a replacement fee of $100.00 USD ("Replacement Fee"). I authorize the Company to charge my credit card, provided below, the Replacement Fee if the headphones are not returned or are returned damaged beyond normal wear and tear.

LIABILITY RELEASE: I hereby release, waive, discharge, and agree not to sue SE2 Silent Disco DBA and SE2 Events Inc., its officers, employees, agents, or affiliates ("Released Parties") from any and all liability, claims, demands, actions, or causes of action arising out of or related to any loss, damage, or injury, including death, that may be sustained by me or my property while using the headphones or attending the event, whether caused by the negligence of the Released Parties or otherwise. I assume full responsibility for any risk of bodily injury, death, or property damage arising from my use of the headphones and participation in the event.

MARKETING CONSENT: I grant SE2 Silent Disco DBA and SE2 Events Inc. permission to use my email address and phone number provided herein for marketing purposes, including but not limited to sending promotional offers, event updates, and newsletters. I understand I may opt out of these communications at any time by following the unsubscribe instructions provided in such messages.

PHOTO/VIDEO CONSENT: I consent to being photographed or recorded in video or audio by SE2 Silent Disco DBA and SE2 Events Inc. during the event. I grant the Company full permission to use, reproduce, publish, and distribute such photographs, videos, or recordings, including my likeness, voice, or image, for marketing, advertising, or promotional purposes in any medium, without compensation or further notice to me.

This agreement constitutes a legally binding contract. I acknowledge that I have read and understood these terms, and I sign this agreement voluntarily under no duress. Any disputes arising from this agreement shall be governed by the laws of New York, USA.</textarea>
    <canvas id="signaturePad" width="300" height="150"></canvas>
    <button id="clearSignature" onclick="clearSignature(); vibrate()">Clear Signature</button>
    <input id="card" placeholder="Card Last 4 Digits">
    <button onclick="checkout(); vibrate()">Complete Checkout</button>
  </div>

  <div id="return" class="form">
    <h2>Return</h2>
    <button id="scanReturn" onclick="scanNFC('return'); vibrate()">Scan NFC Tag</button>
    <input id="returnId" placeholder="Headphone ID" readonly>
    <button onclick="returnHeadphone(); vibrate()">Return</button>
  </div>

  <div id="status" class="form">
    <h2>Status</h2>
    <pre id="statusList"></pre>
  </div>

  <script>
    let headphones = JSON.parse(localStorage.getItem('headphones')) || {};
    let signatureData = null;

    function vibrate() {
      if ('vibrate' in navigator) {
        navigator.vibrate(100);
      }
    }

    function showCheckout() {
      toggleForms('checkout');
      initSignaturePad();
    }

    function showReturn() {
      toggleForms('return');
    }

    function showStatus() {
      toggleForms('status');
      document.getElementById('statusList').textContent = JSON.stringify(headphones, null, 2);
    }

    function toggleForms(active) {
      ['checkout', 'return', 'status'].forEach(id => {
        document.getElementById(id).style.display = id === active ? 'flex' : 'none';
      });
    }

    async function scanNFC(context) {
      const button = document.getElementById(context === 'checkout' ? 'scanCheckout' : 'scanReturn');
      button.disabled = true;
      if ('NDEFReader' in window) {
        const ndef = new NDEFReader();
        try {
          await ndef.scan();
          const controller = new AbortController();
          ndef.onreading = event => {
            const id = event.serialNumber || `HP${Object.keys(headphones).length + 1}`;
            setId(context, id);
            alert(`Scanned headphone: ${id}`);
            controller.abort();
            button.disabled = false;
          };
          ndef.onreadingerror = () => {
            alert('No NFC tag detected. Try again or enter manually.');
            manualEntry(context);
            controller.abort();
            button.disabled = false;
          };
          setTimeout(() => {
            controller.abort();
            if (!button.disabled) return;
            alert('Scan timed out. Try again or enter manually.');
            manualEntry(context);
            button.disabled = false;
          }, 5000);
          await new Promise((resolve) => {
            controller.signal.addEventListener('abort', resolve);
          });
        } catch (error) {
          alert(`NFC error: ${error.message}. Enter ID manually.`);
          manualEntry(context);
          button.disabled = false;
        }
      } else {
        alert('NFC not supported in this browser. Enter ID manually.');
        manualEntry(context);
        button.disabled = false;
      }
    }

    function manualEntry(context) {
      const id = prompt('Enter headphone ID (e.g., HP123):');
      const button = document.getElementById(context === 'checkout' ? 'scanCheckout' : 'scanReturn');
      if (id) setId(context, id);
      button.disabled = false;
    }

    function setId(context, id) {
      if (context === 'checkout') document.getElementById('headphoneId').value = id;
      else document.getElementById('returnId').value = id;
    }

    function initSignaturePad() {
      const canvas = document.getElementById('signaturePad');
      const ctx = canvas.getContext('2d');
      let drawing = false;

      ctx.lineWidth = 2;
      ctx.lineCap = 'round';
      ctx.strokeStyle = '#000';

      canvas.addEventListener('mousedown', startDrawing);
      canvas.addEventListener('mousemove', draw);
      canvas.addEventListener('mouseup', stopDrawing);
      canvas.addEventListener('touchstart', startDrawing);
      canvas.addEventListener('touchmove', draw);
      canvas.addEventListener('touchend', stopDrawing);

      function startDrawing(e) {
        drawing = true;
        ctx.beginPath();
        const { x, y } = getPosition(e);
        ctx.moveTo(x, y);
        e.preventDefault();
      }

      function draw(e) {
        if (!drawing) return;
        const { x, y } = getPosition(e);
        ctx.lineTo(x, y);
        ctx.stroke();
        e.preventDefault();
      }

      function stopDrawing() {
        if (drawing) {
          drawing = false;
          signatureData = canvas.toDataURL();
        }
      }

      function getPosition(e) {
        const rect = canvas.getBoundingClientRect();
        const touch = e.touches ? e.touches[0] : e;
        return {
          x: touch.clientX - rect.left,
          y: touch.clientY - rect.top
        };
      }
    }

    function clearSignature() {
      const canvas = document.getElementById('signaturePad');
      const ctx = canvas.getContext('2d');
      ctx.clearRect(0, 0, canvas.width, canvas.height);
      signatureData = null;
    }

    async function checkout() {
      const id = document.getElementById('headphoneId').value;
      const name = document.getElementById('name').value;
      const email = document.getElementById('email').value;
      const phone = document.getElementById('phone').value;
      const card = document.getElementById('card').value;
      const date = new Date().toLocaleDateString();

      if (!id || !name || !email || !phone || !card || !signatureData) {
        alert('Please fill all fields and sign the agreement!');
        return;
      }

      const agreementText = document.getElementById('agreement').value
        .replace('[Customer Name]', name)
        .replace('[Date]', date);

      if (headphones[id] && headphones[id].status === 'checked_out') {
        alert('This headphone is already checked out!');
        return;
      }

      headphones[id] = {
        status: 'checked_out',
        customer: { name, email, phone },
        agreement: { text: agreementText, signature: signatureData, amount: 100 },
        pre_auth: { card_last4: card, pre_auth_id: `PREAUTH-${id}-${Date.now()}`, amount: 100 }
      };
      localStorage.setItem('headphones', JSON.stringify(headphones));

      try {
        const response = await fetch('/.netlify/functions/send-email', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({
            name: name,
            email: email,
            agreement: agreementText,
            signature: signatureData
          })
        });
        if (response.ok) {
          alert(`Headphone ${id} checked out! Agreement emailed to ${email}.`);
        } else {
          throw new Error('Function failed');
        }
      } catch (error) {
        alert('Checkout successful, but email failed: ' + error.message);
      }
      clearForm('checkout');
      clearSignature();
      showCheckout();
    }

    function dataURLtoBlob(dataURL) {
      const [header, data] = dataURL.split(',');
      const mime = header.match(/:(.*?);/)[1];
      const binary = atob(data);
      const array = [];
      for (let i = 0; i < binary.length; i++) {
        array.push(binary.charCodeAt(i));
      }
      return new Blob([new Uint8Array(array)], { type: mime });
    }

    function returnHeadphone() {
      const id = document.getElementById('returnId').value;
      if (!id) {
        alert('Please scan a headphone!');
        return;
      }
      if (headphones[id] && headphones[id].status === 'checked_out') {
        headphones[id].status = 'returned';
        headphones[id].pre_auth = null;
        localStorage.setItem('headphones', JSON.stringify(headphones));
        alert(`Headphone ${id} returned!`);
        clearForm('return');
        showReturn();
      } else {
        alert('Headphone not found or not checked out!');
      }
    }

    function clearForm(formId) {
      document.getElementById(formId).querySelectorAll('input').forEach(input => input.value = '');
    }
  </script>
</body>
</html>