<!DOCTYPE html><html lang="en"><head><meta charset="UTF-8"><meta name="viewport" content="width=device-width,initial-scale=1"><title>SE2 Silent Disco Tracker</title><script src="https://sandbox.web.squarecdn.com/v1/square.js"></script><script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-app-compat.js"></script><script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-firestore-compat.js"></script><script src="https://cdn.jsdelivr.net/npm/chart.js"></script><link href="https://fonts.googleapis.com/css2?family=Poppins:wght@400;600;700&display=swap" rel="stylesheet"><style>*{margin:0;padding:0;box-sizing:border-box}body{font-family:'Poppins',sans-serif;background:#1A1A1A;color:#FFF;padding:15px;line-height:1.5}.container{max-width:1200px;margin:0 auto}header{display:flex;align-items:center;justify-content:center;padding:15px 0;background:rgba(138,99,255,.1);border-radius:10px;margin-bottom:20px}header img{height:50px;margin-right:10px}header h1{font-size:26px;font-weight:700}.button-group{display:flex;flex-direction:column;align-items:center;gap:15px;margin-bottom:20px;width:100%}button{padding:10px 18px;font-size:16px;font-weight:600;background:#8A63FF;color:#FFF;border:none;border-radius:8px;cursor:pointer;transition:background .3s ease,transform .2s ease;box-shadow:0 2px 4px rgba(0,0,0,.2)}button:hover{background:#6B48FF;transform:translateY(-1px)}button:disabled{background:#666;cursor:not-allowed;transform:none}.form{display:none;flex-direction:column;gap:15px;background:#2A2A2A;padding:20px;border-radius:12px;box-shadow:0 4px 12px rgba(0,0,0,.3)}.form h2{font-size:26px;font-weight:700;color:#8A63FF}input,textarea,select{padding:8px;font-size:14px;background:#EDEDED;border:none;border-radius:6px;color:#1A1A1A;width:100%;max-width:350px}textarea{resize:vertical;height:120px}label{font-size:14px;color:#8A63FF;margin-right:5px}#signaturePad{border:2px solid #8A63FF;background:#FFF;width:280px;height:140px;margin:10px auto;border-radius:6px}#clearSignature{background:#FF4444}#clearSignature:hover{background:#CC3333}#card-container{margin:10px auto;min-height:50px}#paymentOptions{display:flex;flex-direction:column;align-items:center;gap:8px}#paymentOptions p{color:#EDEDED;font-size:14px}table{width:100%;border-collapse:collapse;background:#2A2A2A;border-radius:8px;overflow:hidden}th,td{padding:6px 8px;text-align:left;font-size:13px;border-bottom:1px solid #3A3A3A}th{background:#8A63FF;font-weight:600;position:sticky;top:0;z-index:10}td{color:#EDEDED}.checkin-btn{background:#28A745}.charge-btn{background:#FFC107;color:#1A1A1A}.delete-btn{background:#808080}.button-group button{width:90%;max-width:500px;text-align:center}.form button{width:auto;min-width:140px}#headphoneIdsList{list-style:none;padding:0;margin:10px 0;background:#3A3A3A;border-radius:6px}#headphoneIdsList li{display:flex;justify-content:space-between;align-items:center;padding:8px;border-bottom:1px solid #4A4A4A}.remove-btn{background:#DC3545;padding:5px 10px;font-size:12px}.dialog{position:fixed;top:10%;left:50%;transform:translateX(-50%);background:#2A2A2A;padding:15px;border-radius:12px;z-index:1000;display:none;flex-direction:column;gap:12px;max-width:90%;max-height:80vh;overflow-y:auto;box-shadow:0 6px 16px rgba(0,0,0,.5)}.dialog-header{background:#8A63FF;color:#FFF;padding:8px;font-size:18px;font-weight:600;border-radius:8px 8px 0 0;cursor:move}.dialog-overlay{position:fixed;top:0;left:0;width:100%;height:100%;background:rgba(0,0,0,.7);z-index:999;display:none}.loading-overlay{position:fixed;top:0;left:0;width:100%;height:100%;background:rgba(0,0,0,.5);display:none;justify-content:center;align-items:center;z-index:2000}.spinner{border:6px solid #EDEDED;border-top:6px solid #8A63FF;border-radius:50%;width:50px;height:50px;animation:spin 1s linear infinite}.dashboard-table-wrapper,.return-table-wrapper{max-height:450px;overflow-y:auto;overflow-x:auto;width:100%}.dashboard-actions,.return-actions{margin:15px 0;display:flex;gap:8px;justify-content:center;flex-wrap:wrap}#dashboardControls,#reportControls{display:flex;flex-wrap:wrap;gap:12px;margin-bottom:15px;align-items:center;justify-content:space-between}#dashboardControls div,#reportControls div{display:flex;gap:8px;align-items:center}#dashboardFilters button,#reportFilters button{padding:6px 12px;font-size:13px}#reportOutput{max-width:100%;overflow-x:auto}#reportOutput canvas{max-width:100%;height:280px}#nfcDialog button{background:#DC3545;margin-top:8px}#nfcDialog button:hover{background:#B02A37}#nfcDialog p{font-size:15px;text-align:center}.stats-box{background:#3A3A3A;padding:10px;border-radius:8px;margin-bottom:15px;text-align:center}.stats-box p{font-size:14px;margin:5px 0;color:#EDEDED}footer{text-align:center;padding:10px 0;font-size:12px;color:#EDEDED;margin-top:20px;background:rgba(138,99,255,.1);border-radius:10px}footer img{height:30px;vertical-align:middle;margin-right:5px}@keyframes spin{0%{transform:rotate(0deg)}100%{transform:rotate(360deg)}}@media (max-width:768px){header img{height:40px}header h1{font-size:22px}.button-group{gap:12px}button{width:95%;font-size:14px;padding:8px 16px}.form{padding:15px}input,textarea,select{width:100%;max-width:100%}table{font-size:11px}th,td{padding:5px}.dashboard-table-wrapper,.return-table-wrapper{max-height:300px}#dashboardControls,#reportControls{flex-direction:column;align-items:stretch}#dashboardControls div,#reportControls div{flex-direction:column;align-items:stretch}}</style></head><body><div class="container"><header><img src="https://www.se2.events/wp-content/uploads/2023/03/cropped-SE2SilentDisco_Logo.png" alt="SE2 Silent Disco Logo"><h1>SE2 Silent Disco Tracker</h1></header><div class="button-group"><button onclick="showCheckout();vibrate()">Checkout - Handout Headphones</button><button onclick="showReturn();vibrate()">Check In - Return Headphones</button><button onclick="showDashboard();vibrate()">View Dashboard</button><button onclick="showReports();vibrate()">View Reports</button><button onclick="scanNFCStatus();vibrate()">Scan NFC Status</button></div><div id="checkout" class="form"><h2>Checkout Headphones</h2><div><label>Event Name:</label><input id="eventName" placeholder="e.g., Friday Night Disco"></div><div><label>Scan NFC or Enter ID:</label><button id="scanCheckout" onclick="scanNFC('checkout');vibrate()">Scan NFC Tag</button><input id="headphoneId" placeholder="e.g., HP0000001" readonly onclick="manualEntry('checkout');vibrate()"></div><button onclick="addHeadphoneId();vibrate()">Add Headphone ID</button><ul id="headphoneIdsList"></ul><div><label>Full Name:</label><input id="name" placeholder="Enter full name"></div><div><label>Email:</label><input id="email" placeholder="Enter email"></div><div><label>Phone Number:</label><input id="phone" placeholder="Enter phone number"></div><div><label>Agreement:</label><textarea id="agreement" readonly>RENTAL AGREEMENT AND COLLATERAL TERMS By signing below, I, [Customer Name], agree to rent the following wireless headphones ([Headphone IDs]) from SE2 Silent Disco DBA and SE2 Events Inc. ("the Company") for use during the event [Event Name] on [Date]. I acknowledge that the headphones remain the property of the Company and must be returned in good working condition at the end of the event or upon request. I understand and agree that failure to return any headphone by the end of the event will result in a replacement fee of $100.00 USD per headphone ("Replacement Fee"). I authorize the Company to charge my credit card, provided below, the Replacement Fee for each headphone not returned or returned damaged beyond normal wear and tear. LIABILITY RELEASE: I hereby release, waive, discharge, and agree not to sue SE2 Silent Disco DBA and SE2 Events Inc., its officers, employees, agents, or affiliates ("Released Parties") from any and all liability, claims, demands, actions, or causes of action arising out of or related to any loss, damage, or injury, including death, that may be sustained by me or my property while using the headphones or attending the event, whether caused by the negligence of the Released Parties or otherwise. I assume full responsibility for any risk of bodily injury, death, or property damage arising from my use of the headphones and participation in the event. MARKETING CONSENT: I grant SE2 Silent Disco DBA and SE2 Events Inc. permission to use my email address and phone number provided herein for marketing purposes, including but not limited to sending promotional offers, event updates, and newsletters. I may opt out of these communications at any time by following the unsubscribe instructions provided in such messages. PHOTO/VIDEO CONSENT: I consent to being photographed or recorded in video or audio by SE2 Silent Disco DBA and SE2 Events Inc. during the event. I grant the Company full permission to use, reproduce, publish, and distribute such photographs, videos, or recordings, including my likeness, voice, or image, for marketing, advertising, or promotional purposes in any medium, without compensation or further notice to me. This agreement constitutes a legally binding contract. I acknowledge that I have read and understood these terms, and I sign this agreement voluntarily under no duress. Any disputes arising from this agreement shall be governed by the laws of New York, USA.</textarea></div><div id="paymentOptions"><button id="tapToPay" onclick="tapToPayCheckout();vibrate()">Tap Card to Checkout</button><p>OR</p><div id="card-container"></div></div><div><label>Signature:</label><canvas id="signaturePad" width="280" height="140"></canvas></div><button id="clearSignature" onclick="clearSignature();vibrate()">Clear Signature</button><button id="checkoutButton" onclick="checkout();vibrate()">Complete Checkout</button><footer><img src="https://www.se2.events/wp-content/uploads/2023/03/cropped-SE2SilentDisco_Logo.png" alt="SE2 Silent Disco Logo"> SE2 Silent Disco - <a href="https://www.se2.events" style="color:#8A63FF;text-decoration:none">www.se2.events</a></footer></div><div id="return" class="form"><h2>Return Headphones</h2><div><label>Search Headphones:</label><input id="returnSearch" type="text" placeholder="Search headphones..." onkeyup="updateReturnTable()"></div><div class="return-actions"><button id="scanReturn" onclick="scanNFCForReturn();vibrate()">Scan NFC</button><button onclick="returnSelectedHeadphones();vibrate()">Return Selected</button></div><div class="return-table-wrapper"><table id="returnTable"><thead><tr><th>Select</th><th>Customer</th><th>Email</th><th>Phone</th><th>ID</th><th>NFC ID</th><th>Group ID</th></tr></thead><tbody id="returnList"></tbody></table></div></div><div id="dashboard" class="form"><h2>Dashboard</h2><div id="dashboardControls"><div><label>Search:</label><input id="searchInput" type="text" placeholder="Search headphones..." onkeyup="searchHeadphones()"></div><div id="dashboardFilters"><label>Date Range:</label><button onclick="filterDashboard(0)">Today</button><button onclick="filterDashboard(7)">Last 7 Days</button><button onclick="filterDashboard(30)">Last 30 Days</button><button onclick="resetDashboardFilters()">Reset</button></div></div><div><label class="date-label">Start Date:</label><input id="dashboardStartDate" type="date" onchange="updateDashboard()"></div><div><label class="date-label">End Date:</label><input id="dashboardEndDate" type="date" onchange="updateDashboard()"></div><div class="dashboard-actions"><button onclick="showReturnDialogForSelected();vibrate()">Return Selected</button><button id="scanDashboardNFC" onclick="scanNFCForDashboard();vibrate()">Scan NFC</button></div><div class="dashboard-table-wrapper"><table id="headphoneTable"><thead><tr><th>Select</th><th>Customer</th><th>Status</th><th>Preauth Status</th><th>Email</th><th>Phone</th><th>ID</th><th>NFC ID</th><th>Entry Method</th><th>Event</th><th>Group ID</th><th>Delete</th></tr></thead><tbody id="headphoneList"></tbody></table></div></div><div id="reports" class="form"><h2>Reports</h2><div class="stats-box"><p>Total Checked Out: <span id="totalCheckedOut">0</span></p><p>Overdue: <span id="totalOverdue">0</span></p></div><div id="reportControls"><div><label>Report Type:</label><select id="reportType" onchange="generateReport()"><option value="">Select a Report</option><option value="allData">All Data</option><option value="checkedOut">Currently Checked Out</option><option value="overdue">Overdue Headphones</option><option value="revenue">Revenue Summary</option><option value="customerActivity">Customer Activity</option><option value="groupSummary">Group Checkout Summary</option><option value="nfcUsage">NFC Usage Statistics</option><option value="dailyCheckouts">Daily Checkouts</option><option value="statusDistribution">Status Distribution</option></select></div><div id="reportFilters"><label>Date Range:</label><button onclick="filterReport(0)">Today</button><button onclick="filterReport(7)">Last 7 Days</button><button onclick="filterReport(30)">Last 30 Days</button><button onclick="resetFilters()">Reset</button></div><div><label>Search:</label><input id="reportSearch" type="text" placeholder="Search reports..." onkeyup="generateReport()"></div><div><label>Data Style:</label><select id="dataStyle" onchange="handleDataStyleChange()"><option value="table">Table</option><option value="bar">Bar Chart</option><option value="line">Line Chart</option><option value="pie">Pie Chart</option><option value="csv">Export CSV</option></select></div></div><div><label class="date-label">Start Date:</label><input id="reportStartDate" type="date" onchange="generateReport()"></div><div><label class="date-label">End Date:</label><input id="reportEndDate" type="date" onchange="generateReport()"></div><div id="reportOutput"></div></div><div id="nfcStatus" class="form"><h2>NFC Status</h2><p id="nfcStatusResult">Scan an NFC tag to see headphone status.</p></div><div id="manualReturnDialog" class="dialog"><div id="manualReturnDialogHeader" class="dialog-header">Select Headphones to Return</div><div><label>Search Headphones:</label><input id="manualReturnSearch" type="text" placeholder="Search headphones..." onkeyup="filterManualReturnList()"></div><table id="manualReturnTable"><thead><tr><th>Select</th><th>ID</th><th>Customer</th><th>Group ID</th></tr></thead><tbody id="manualReturnList"></tbody></table><button onclick="submitManualReturn();vibrate()">Return Selected</button><button onclick="closeDialog('manualReturn');vibrate()">Cancel</button></div><div id="nfcDialog" class="dialog"><p>Scanning... Click 'Cancel Scan' to stop</p><button onclick="cancelNFCScan();vibrate()">Cancel Scan</button></div><div id="dialogOverlay" class="dialog-overlay" onclick="closeDialog(null);vibrate()"></div><div id="loadingOverlay" class="loading-overlay"><div class="spinner"></div></div><footer><img src="https://www.se2.events/wp-content/uploads/2023/03/cropped-SE2SilentDisco_Logo.png" alt="SE2 Silent Disco Logo"> SE2 Silent Disco - <a href="https://www.se2.events" style="color:#8A63FF;text-decoration:none">www.se2.events</a></footer></div><script>const squareAppId='sandbox-sq0idb-qaDoxfFQK3OfUWlaCrgkDw';let headphones={},usedHeadphoneIds=new Set(),checkoutListIds=new Set(),signatureData=null,payments,cardElement,db,headphonesCollection,squareLocationId,firebaseConfig,activeNFCController=null,nfcTriggered=false,timeoutId=null,chartInstance=null;async function fetchConfig(){try{const r=await fetch('/.netlify/functions/get-config'),c=await r.json();squareLocationId=c.squareLocationId;firebaseConfig=c.firebaseConfig}catch(e){console.error('Failed to fetch config:',e);alert('Failed to load configuration')}}async function waitForFirebase(){return new Promise(r=>{let a=0;const i=setInterval(()=>{if(typeof firebase!=='undefined'&&firebase.app&&firebase.firestore||a>=100){clearInterval(i);if(!firebase.app)alert('Offline mode: Data sync unavailable. Use manual entry if needed.');else{firebase.initializeApp(firebaseConfig);db=firebase.firestore();headphonesCollection=db.collection('headphones')}r()}a++},100)})}async function loadHeadphones(){if(!db||!headphonesCollection)return headphones;try{const s=await headphonesCollection.get();headphones={};usedHeadphoneIds=new Set();s.forEach(d=>{headphones[d.id]=d.data();if(headphones[d.id].status==='checked_out')usedHeadphoneIds.add(d.id)});return headphones}catch(e){console.error('Error loading headphones:',e);alert('Failed to load data');return headphones}}async function saveHeadphone(id,data){try{if(db&&headphonesCollection)await headphonesCollection.doc(id).set(data);headphones[id]=data;if(data.status==='checked_out')usedHeadphoneIds.add(id)}catch(e){console.error('Error saving headphone:',e);throw e}}async function updateHeadphone(id,data){try{if(db&&headphonesCollection)await headphonesCollection.doc(id).update(data);headphones[id]={...headphones[id],...data};if(data.status==='returned'||data.status==='charged')usedHeadphoneIds.delete(id)}catch(e){console.error('Error updating headphone:',e);alert('Failed to update data');throw e}}async function deleteHeadphone(id){try{if(confirm(`Are you sure you want to delete headphone ${id}?`)){if(db&&headphonesCollection)await headphonesCollection.doc(id).delete();delete headphones[id];usedHeadphoneIds.delete(id);checkoutListIds.delete(id);alert(`Headphone ${id} deleted!`);updateDashboard()}}catch(e){console.error('Error deleting headphone:',e);alert('Failed to delete headphone')}}async function initializeSquare(){if(!window.Square)return;if(!payments)payments=window.Square.payments(squareAppId);const c=document.getElementById('card-container');c.innerHTML='';cardElement=await payments.card();await cardElement.attach('#card-container');return cardElement}window.onload=async()=>{try{await fetchConfig();await waitForFirebase();await initializeSquare();await loadHeadphones();makeDraggable('manualReturnDialog','manualReturnDialogHeader');nfcTriggered=false;runTests()}catch(e){console.error('Initialization error:',e);alert('Failed to start app')}};function vibrate(){if('vibrate' in navigator)navigator.vibrate(100)}function showLoading(){document.getElementById('loadingOverlay').style.display='flex';document.getElementById('checkoutButton').disabled=true;document.querySelectorAll('.charge-btn').forEach(b=>b.disabled=true)}function hideLoading(){document.getElementById('loadingOverlay').style.display='none';document.getElementById('checkoutButton').disabled=false;document.querySelectorAll('.charge-btn').forEach(b=>b.disabled=false)}function addHeadphoneId(){const id=document.getElementById('headphoneId').value.trim();if(!id)return alert('Please enter a headphone ID!');const c=getHeadphoneIds('headphoneIdsList');if(c.includes(id))return alert(`Headphone ID ${id} is already in your checkout list!`);if(headphones[id]&&headphones[id].status==='checked_out')return alert(`Headphone ${id} is already checked out!`);const l=document.getElementById('headphoneIdsList'),li=document.createElement('li');li.innerHTML=`${id} <button class="remove-btn" onclick="removeHeadphoneId(this,'${id}')">Remove</button>`;l.appendChild(li);checkoutListIds.add(id);document.getElementById('headphoneId').value=''}function removeHeadphoneId(b,id){b.parentElement.remove();checkoutListIds.delete(id)}function getHeadphoneIds(lId){return Array.from(document.getElementById(lId).children).map(li=>li.textContent.split(' ')[0])}function generateGroupId(){const r=/^GROUP_\d{7}$/,e=Object.values(headphones).filter(h=>h.groupId&&r.test(h.groupId)).map(h=>parseInt(h.groupId.replace('GROUP_',''),10));let n=1;if(e.length)n=Math.max(...e)+1;return`GROUP_${String(n).padStart(7,'0')}`}function generateUniqueHeadphoneId(){const r=/^HP\d{7}$/,a=new Set([...usedHeadphoneIds,...checkoutListIds]),e=Array.from(a).filter(id=>r.test(id));let n=1;if(e.length)n=Math.max(...e.map(id=>parseInt(id.replace('HP',''),10)))+1;return`HP${String(n).padStart(7,'0')}`}async function showCheckout(){toggleForms('checkout');initSignaturePad('signaturePad');await initializeSquare();document.getElementById('headphoneIdsList').innerHTML='';checkoutListIds.clear();document.getElementById('eventName').value=''}async function showReturn(){toggleForms('return');await loadHeadphones();updateReturnTable()}async function showDashboard(){toggleForms('dashboard');await loadHeadphones();document.getElementById('searchInput').value='';document.getElementById('dashboardStartDate').value='';document.getElementById('dashboardEndDate').value='';updateDashboard()}async function showReports(){toggleForms('reports');await loadHeadphones();document.getElementById('reportType').value='';document.getElementById('reportStartDate').value='';document.getElementById('reportEndDate').value='';document.getElementById('reportSearch').value='';document.getElementById('dataStyle').value='table';generateReport()}async function scanNFCStatus(){nfcTriggered=true;toggleForms('nfcStatus');const d=document.getElementById('nfcDialog'),o=document.getElementById('dialogOverlay'),r=document.getElementById('nfcStatusResult');d.style.display='flex';o.style.display='block';r.textContent='';if(!('NDEFReader' in window)){r.textContent='NFC not supported.';d.style.display='none';o.style.display='none';return}const n=new NDEFReader();activeNFCController=new AbortController();try{await n.scan({signal:activeNFCController.signal});n.onreading=e=>{const i=e.serialNumber.toLowerCase(),m=Object.entries(headphones).find(([_,h])=>h.nfcId&&h.nfcId.toLowerCase()===i);if(m){const[id,h]=m;r.innerHTML+=`<strong>ID:</strong> ${id}<br><strong>NFC ID:</strong> ${h.nfcId||'N/A'}<br><strong>Status:</strong> ${h.status==='checked_out'?'Checked Out':h.status==='returned'?'Returned':'Charged'}<br><strong>Customer:</strong> ${h.customer.name}<br><strong>Email:</strong> ${h.customer.email}<br><strong>Phone:</strong> ${h.customer.phone}<br><strong>Preauth Status:</strong> ${h.pre_auth?'Hold':'Released'}<br><strong>Entry Method:</strong> ${h.entryMethod||'N/A'}<br><strong>Date:</strong> ${h.agreement.date||'N/A'}<br><strong>Event:</strong> ${h.eventName||'N/A'}<br><strong>Group ID:</strong> ${h.groupId||'Single'}<br><hr>`}};n.onreadingerror=()=>{r.innerHTML+='<br>Error reading NFC tag. Try again.'}}catch(e){if(e.name!=='AbortError')r.textContent=`Error: ${e.message}`;d.style.display='none';o.style.display='none'}}function toggleForms(a){['checkout','return','dashboard','nfcStatus','reports'].forEach(id=>document.getElementById(id).style.display=id===a?'flex':'none');document.getElementById('manualReturnDialog').style.display='none';document.getElementById('nfcDialog').style.display='none';document.getElementById('dialogOverlay').style.display='none'}async function scanNFC(c){if(!nfcTriggered)return;nfcTriggered=true;const b=document.getElementById('scanCheckout'),i=document.getElementById('headphoneId'),d=document.getElementById('nfcDialog'),o=document.getElementById('dialogOverlay');b.disabled=true;d.style.display='flex';o.style.display='block';if(!('NDEFReader' in window)){alert('NFC not supported. Enter ID manually.');manualEntry('checkout');b.disabled=false;d.style.display='none';o.style.display='none';return}const n=new NDEFReader();activeNFCController=new AbortController();try{await n.scan({signal:activeNFCController.signal});n.onreading=e=>{const id=e.serialNumber.toLowerCase(),h=generateUniqueHeadphoneId(),ci=getHeadphoneIds('headphoneIdsList');if(ci.includes(h))alert(`Headphone ID ${h} is already in your checkout list!`);else if(headphones[h]&&headphones[h].status==='checked_out')alert(`Headphone ${h} is already checked out!`);else{const l=document.getElementById('headphoneIdsList'),li=document.createElement('li');li.innerHTML=`${h} <button class="remove-btn" onclick="removeHeadphoneId(this,'${h}')">Remove</button>`;l.appendChild(li);checkoutListIds.add(h);alert(`Headphone ${h} with NFC ID ${id} added to checkout list.`)}i.value='';i.dataset.nfcId=id;i.dataset.entryMethod='NFC'};n.onreadingerror=()=>console.log('NFC reading error')}catch(e){if(e.name!=='AbortError'){alert(`NFC scan failed: ${e.message}. Enter ID manually.`);manualEntry('checkout')}b.disabled=false;d.style.display='none';o.style.display='none'}}function manualEntry(c){const i=document.getElementById('headphoneId'),b=document.getElementById('scanCheckout'),r=/^HP\d{7}$/,s=generateUniqueHeadphoneId(),u=prompt(`Enter headphone ID (suggested: ${s}):`,s);if(!u||!r.test(u)){alert('Invalid ID format. Use HP followed by 7 digits.');b.disabled=false;return}if(headphones[u]&&headphones[u].status==='checked_out'){alert(`ID ${u} is already checked out!`);b.disabled=false;return}if(checkoutListIds.has(u)){alert(`ID ${u} is already in your checkout list!`);b.disabled=false;return}i.value=u;i.dataset.entryMethod='Manual';b.disabled=false}async function scanNFCForDashboard(){nfcTriggered=true;const b=document.getElementById('scanDashboardNFC'),d=document.getElementById('nfcDialog'),o=document.getElementById('dialogOverlay');b.disabled=true;d.style.display='flex';o.style.display='block';if(!('NDEFReader' in window)){alert('NFC not supported. Please manually select headphones to return.');b.disabled=false;d.style.display='none';o.style.display='none';return}const n=new NDEFReader();activeNFCController=new AbortController();try{await n.scan({signal:activeNFCController.signal});let s=0;n.onreading=e=>{const i=e.serialNumber.toLowerCase(),m=Object.entries(headphones).find(([_,h])=>h.nfcId&&h.nfcId.toLowerCase()===i&&h.status==='checked_out');if(m){const[id]=m,c=document.querySelector(`input[name="checkinHeadphone"][value="${id}"]`);if(c){c.checked=true;alert(`Headphone ${id} with NFC ID ${i} selected for return.`);s++}else alert(`Headphone ${id} with NFC ID ${i} is checked out but not in the current view.`)}};n.onreadingerror=()=>alert('Error reading NFC tag. Try again or manually select headphones.')}catch(e){if(e.name!=='AbortError')alert(`NFC scan failed: ${e.message}. Please manually select headphones.`);b.disabled=false;d.style.display='none';o.style.display='none'}}async function scanNFCForReturn(){nfcTriggered=true;const b=document.getElementById('scanReturn'),d=document.getElementById('nfcDialog'),o=document.getElementById('dialogOverlay');b.disabled=true;d.style.display='flex';o.style.display='block';if(!('NDEFReader' in window)){alert('NFC not supported. Please manually select headphones to return.');b.disabled=false;d.style.display='none';o.style.display='none';return}const n=new NDEFReader();activeNFCController=new AbortController();try{await n.scan({signal:activeNFCController.signal});let s=0;n.onreading=e=>{const i=e.serialNumber.toLowerCase(),m=Object.entries(headphones).find(([_,h])=>h.nfcId&&h.nfcId.toLowerCase()===i&&h.status==='checked_out');if(m){const[id]=m,c=document.querySelector(`input[name="returnHeadphone"][value="${id}"]`);if(c){c.checked=true;alert(`Headphone ${id} with NFC ID ${i} selected for return.`);s++}else alert(`Headphone ${id} with NFC ID ${i} is checked out but not in the current view.`)}};n.onreadingerror=()=>alert('Error reading NFC tag. Try again or manually select headphones.')}catch(e){if(e.name!=='AbortError')alert(`NFC scan failed: ${e.message}. Please manually select headphones.`);b.disabled=false;d.style.display='none';o.style.display='none'}}function cancelNFCScan(){if(activeNFCController){activeNFCController.abort();activeNFCController=null;document.getElementById('nfcDialog').style.display='none';document.getElementById('dialogOverlay').style.display='none';document.getElementById('scanCheckout').disabled=false;document.getElementById('scanDashboardNFC').disabled=false;document.getElementById('scanReturn').disabled=false;document.getElementById('nfcStatusResult').textContent='Scan cancelled. Scan an NFC tag to see headphone status.'}}function showManualReturnDialog(){const d=document.getElementById('manualReturnDialog'),o=document.getElementById('dialogOverlay'),l=document.getElementById('manualReturnList'),c=Object.entries(headphones).filter(([_,h])=>h.status==='checked_out');d.style.display='flex';o.style.display='block';l.innerHTML='';c.forEach(([id,h])=>{const r=document.createElement('tr');r.innerHTML=`<td><input type="checkbox" name="manualReturnHeadphone" value="${id}"></td><td>${id}</td><td>${h.customer.name}</td><td>${h.groupId||'Single'}</td>`;l.appendChild(r)});document.getElementById('manualReturnSearch').value=''}function filterManualReturnList(){const s=document.getElementById('manualReturnSearch').value.toLowerCase(),r=document.getElementById('manualReturnList').getElementsByTagName('tr');Array.from(r).forEach(row=>row.style.display=row.textContent.toLowerCase().includes(s)?'':'none')}async function submitManualReturn(){const s=Array.from(document.getElementById('manualReturnList').querySelectorAll('input[name="manualReturnHeadphone"]:checked')).map(i=>i.value);if(!s.length)return alert('Please select at least one headphone!');const g=s.map(id=>headphones[id].groupId||'Single');if(new Set(g).size>1)return alert('All selected headphones must belong to the same group or all be singles.');try{for(const id of s)await updateHeadphone(id,{status:'returned',pre_auth:null});const m=await sendReturnEmail(s);alert(m);closeDialog('manualReturn');showReturn()}catch(e){alert('Failed to return headphones: '+e.message)}}function initSignaturePad(cId){const c=document.getElementById(cId),ctx=c.getContext('2d');let d=false;ctx.lineWidth=2;ctx.lineCap='round';ctx.strokeStyle='#000';c.addEventListener('mousedown',e=>{d=true;ctx.beginPath();const{x,y}=getPosition(e);ctx.moveTo(x,y);e.preventDefault()});c.addEventListener('mousemove',e=>{if(!d)return;const{x,y}=getPosition(e);ctx.lineTo(x,y);ctx.stroke();e.preventDefault()});c.addEventListener('mouseup',()=>{if(d){d=false;if(cId==='signaturePad')signatureData=c.toDataURL()}});c.addEventListener('touchstart',e=>{d=true;ctx.beginPath();const{x,y}=getPosition(e);ctx.moveTo(x,y);e.preventDefault()});c.addEventListener('touchmove',e=>{if(!d)return;const{x,y}=getPosition(e);ctx.lineTo(x,y);ctx.stroke();e.preventDefault()});c.addEventListener('touchend',()=>{if(d){d=false;if(cId==='signaturePad')signatureData=c.toDataURL()}});function getPosition(e){const r=c.getBoundingClientRect(),t=e.touches?e.touches[0]:e;return{x:t.clientX-r.left,y:t.clientY-r.top}}}function clearSignature(){const c=document.getElementById('signaturePad'),ctx=c.getContext('2d');ctx.clearRect(0,0,c.width,c.height);signatureData=null}async function tapToPayCheckout(){if(!('NDEFReader' in window))return alert('NFC not supported. Use manual entry.');const n=new NDEFReader();try{showLoading();await n.scan();const c=new AbortController();n.onreading=async e=>{const i=e.serialNumber,t='cnon:card-nonce-ok';await processPayment(t);c.abort()};n.onreadingerror=()=>{alert('Failed to read payment card. Try again or use manual entry.');c.abort();hideLoading()};setTimeout(()=>{c.abort();if(!c.signal.aborted){alert('Payment scan timed out.');hideLoading()}},5000);await new Promise(r=>c.signal.addEventListener('abort',r))}catch(e){alert(`NFC error: ${e.message}. Use manual entry.`);hideLoading()}}async function processPayment(t){const h=getHeadphoneIds('headphoneIdsList'),n=document.getElementById('name').value,e=document.getElementById('email').value,p=document.getElementById('phone').value,d=new Date().toISOString().split('T')[0],en=document.getElementById('eventName').value.trim();if(!h.length||!n||!e||!p||!signatureData||!en){hideLoading();return alert('Please complete all fields, including Event Name, and sign!')}const g=h.length>1?generateGroupId():null;let s=[];try{const r=await fetch('/.netlify/functions/preauthorize',{method:'POST',headers:{'Content-Type':'application/json'},body:JSON.stringify({sourceId:t,amount:h.length*10000,currency:'USD',locationId:squareLocationId})}),pr=await r.json();if(!r.ok)throw new Error(pr.error||'Preauthorization failed');const pi=pr.paymentId;for(const id of h){if(headphones[id]&&headphones[id].status==='checked_out'){alert(`Headphone ID ${id} is already checked out! Skipping.`);continue}const em=document.getElementById('headphoneId').dataset.entryMethod||'Manual',ni=document.getElementById('headphoneId').dataset.nfcId,hd={status:'checked_out',customer:{name:n,email:e,phone:p},agreement:{text:document.getElementById('agreement').value.replace('[Customer Name]',n).replace('[Date]',d).replace('[Headphone IDs]',h.join(', ')).replace('[Event Name]',en),signature:signatureData,amount:100,date:d,timestamp:Date.now()},pre_auth:{pre_auth_id:pi,amount:h.length*100},entryMethod:em,nfcId:ni||null,eventName:en};if(g)hd.groupId=g;await saveHeadphone(id,hd);s.push(id)}if(s.length>0){const ht=s.join(', '),at=document.getElementById('agreement').value.replace('[Customer Name]',n).replace('[Date]',d).replace('[Headphone IDs]',ht).replace('[Event Name]',en),er=await fetch('/.netlify/functions/send-email',{method:'POST',headers:{'Content-Type':'application/json'},body:JSON.stringify({name:n,email:e,agreement:at,signature:signatureData,preauthId:pi})});if(!er.ok)throw new Error('Email failed');alert(`Headphones ${ht} checked out for ${en}! Agreement emailed to ${e}.`)}else alert('No headphones were checked out due to existing usage.');clearForm('checkout');showDashboard()}catch(error){console.error('Payment error:',error.message);alert('Payment failed: '+error.message)}finally{hideLoading()}}async function checkout(){const h=getHeadphoneIds('headphoneIdsList'),n=document.getElementById('name').value,e=document.getElementById('email').value,p=document.getElementById('phone').value,d=new Date().toISOString().split('T')[0],en=document.getElementById('eventName').value.trim();if(!h.length||!n||!e||!p||!signatureData||!cardElement||!en)return alert('Please complete all fields, including Event Name, enter card details, and sign!');showLoading();try{const r=await cardElement.tokenize();if(r.status!=='OK')throw new Error('Card tokenization failed.');await processPayment(r.token)}catch(error){console.error('Checkout error:',error.message);alert('Checkout failed: '+error.message)}finally{hideLoading()}}async function sendReturnEmail(rIds){const c=headphones[rIds[0]].customer||{name:'Customer',email:''},hl=rIds.join(', '),eb=`Dear ${c.name||'Customer'},

Thank you for attending our Silent Disco event with SE2 Silent Disco! We hope you had an amazing experience. We're pleased to confirm that we've received the following headphone(s): ${hl}. 

You are no longer responsible for these items, and any associated payment holds have been released. We appreciate your prompt return and hope to see you at future events!

For any questions, contact us at:
- Website: www.se2.events
- Email: se2login@gmail.com

Best regards,
The SE2 Silent Disco Team`,ep={name:c.name||'Customer',email:c.email||'',agreement:eb,signature:'',preauthId:''},er=await fetch('/.netlify/functions/send-email',{method:'POST',headers:{'Content-Type':'application/json'},body:JSON.stringify(ep)});if(!er.ok){const et=await er.text();console.error('Failed to send return email:',et);return`Headphone(s) ${rIds.join(', ')} returned, but email failed: ${et}`}return`Headphone(s) ${rIds.join(', ')} returned! Confirmation emailed to ${c.email||'customer'}.`}async function returnSelectedHeadphones(){const s=Array.from(document.querySelectorAll('input[name="returnHeadphone"]:checked')).map(i=>i.value);if(!s.length)return alert('Please select at least one headphone to return!');const g=s.map(id=>headphones[id].groupId||'Single');if(new Set(g).size>1)return alert('All selected headphones must belong to the same group or all be singles.');try{let r=[];for(const id of s){if(!headphones[id]||headphones[id].status!=='checked_out'){alert(`Headphone ${id} not checked out! Skipping.`);continue}await updateHeadphone(id,{status:'returned',pre_auth:null});r.push(id)}if(r.length){const m=await sendReturnEmail(r);alert(m)}else alert('No headphones returned.');updateReturnTable()}catch(e){console.error('Return error:',e.message);alert('Failed to return headphones: '+e.message)}}function showReturnDialogForSelected(){const s=Array.from(document.querySelectorAll('input[name="checkinHeadphone"]:checked')).map(i=>i.value);if(!s.length)return alert('Please select at least one headphone to return!');const g=s.map(id=>headphones[id].groupId||'Single');if(new Set(g).size>1)return alert('All selected headphones must belong to the same group or all be singles.');showManualReturnDialog();const l=document.getElementById('manualReturnList');l.innerHTML='';s.forEach(id=>{const h=headphones[id],r=document.createElement('tr');r.innerHTML=`<td><input type="checkbox" name="manualReturnHeadphone" value="${id}" checked></td><td>${id}</td><td>${h.customer.name}</td><td>${h.groupId||'Single'}</td>`;l.appendChild(r)})}function closeDialog(t){if(t==='manualReturn')document.getElementById('manualReturnDialog').style.display='none';document.getElementById('dialogOverlay').style.display='none';document.getElementById('nfcDialog').style.display='none';showDashboard()}async function dashboardCharge(id){if(!headphones[id]||headphones[id].status!=='checked_out'||!headphones[id].pre_auth)return alert(`Cannot charge ${id}: Not checked out or no preauthorization.`);const g=headphones[id].groupId,hc=g?Object.values(headphones).filter(h=>h.groupId===g&&h.status==='checked_out').length:1,ca=Math.round(headphones[id].pre_auth.amount*100/hc),cad=(ca/100).toFixed(2);if(!confirm(`Charge ${headphones[id].customer.name} $${cad} for ${id}?`))return;showLoading();try{const r=await fetch('/.netlify/functions/capture-payment',{method:'POST',headers:{'Content-Type':'application/json'},body:JSON.stringify({paymentId:headphones[id].pre_auth.pre_auth_id,amount:ca})}),cr=await r.json();if(!r.ok)throw new Error(cr.error||'Charge failed');await updateHeadphone(id,{status:'charged',pre_auth:null});alert(`Headphone ${id} charged for $${cad}!`);updateDashboard()}catch(e){alert(`Charge failed for ${id}: ${e.message}`)}finally{hideLoading()}}function updateDashboard(){const t=document.getElementById('headphoneList'),s=document.getElementById('searchInput').value.toLowerCase(),sd=document.getElementById('dashboardStartDate').value,ed=document.getElementById('dashboardEndDate').value||sd,n=Date.now(),th=12*60*60*1000,ha=Object.entries(headphones).map(([id,h])=>({id,...h})),co=ha.filter(h=>h.status==='checked_out'),ci=ha.filter(h=>h.status!=='checked_out');co.sort((a,b)=>(a.customer?.name||'N/A').localeCompare(b.customer?.name||'N/A'));ci.sort((a,b)=>(a.customer?.name||'N/A').localeCompare(b.customer?.name||'N/A'));let f=[...co,...ci];if(sd){const st=new Date(sd).setHours(0,0,0,0),en=ed?new Date(ed).setHours(23,59,59,999):st;f=f.filter(h=>new Date(h.agreement?.date).setHours(0,0,0,0)>=st&&new Date(h.agreement?.date).setHours(0,0,0,0)<=en)}t.innerHTML='';f.forEach(h=>{const st=h.status==='checked_out'?'Checked Out':h.status==='returned'?'Returned':'Charged',o=h.status==='checked_out'&&(n-(h.agreement?.timestamp||n)>th),rd=[h.customer?.name||'N/A',st,h.pre_auth?'Hold':'Released',h.customer?.email||'N/A',h.customer?.phone||'N/A',h.id,h.nfcId||'N/A',h.entryMethod||'N/A',h.agreement?.date||'N/A',h.eventName||'N/A',h.groupId||'Single'];if(rd.some(d=>d.toLowerCase().includes(s))){const r=document.createElement('tr');let a='';if(h.status==='checked_out')a+=`<input type="checkbox" name="checkinHeadphone" value="${h.id}">`;if(h.status==='checked_out'&&h.pre_auth&&o)a+=`<button class="charge-btn" onclick="dashboardCharge('${h.id}')">Charge</button>`;r.innerHTML=`<td>${a}</td><td>${h.customer?.name||'N/A'}</td><td>${st}</td><td>${h.pre_auth?'Hold':'Released'}</td><td>${h.customer?.email||'N/A'}</td><td>${h.customer?.phone||'N/A'}</td><td>${h.id}</td><td>${h.nfcId||'N/A'}</td><td>${h.entryMethod||'N/A'}</td><td>${h.eventName||'N/A'}</td><td>${h.groupId||'Single'}</td><td><button class="delete-btn" onclick="deleteHeadphone('${h.id}')">Delete</button></td>`;t.appendChild(r)}})}function updateReturnTable(){const t=document.getElementById('returnList'),s=document.getElementById('returnSearch').value.toLowerCase(),ha=Object.entries(headphones).filter(([_,h])=>h.status==='checked_out').map(([id,h])=>({id,...h}));ha.sort((a,b)=>(a.customer?.name||'N/A').localeCompare(b.customer?.name||'N/A'));t.innerHTML='';ha.forEach(h=>{const rd=[h.customer?.name||'N/A',h.customer?.email||'N/A',h.customer?.phone||'N/A',h.id,h.nfcId||'N/A',h.groupId||'Single'];if(rd.some(d=>d.toLowerCase().includes(s))){const r=document.createElement('tr');r.innerHTML=`<td><input type="checkbox" name="returnHeadphone" value="${h.id}"></td><td>${h.customer?.name||'N/A'}</td><td>${h.customer?.email||'N/A'}</td><td>${h.customer?.phone||'N/A'}</td><td>${h.id}</td><td>${h.nfcId||'N/A'}</td><td>${h.groupId||'Single'}</td>`;t.appendChild(r)}})}function searchHeadphones(){updateDashboard()}function filterDashboard(d){const e=new Date(),s=new Date();s.setDate(e.getDate()-d);document.getElementById('dashboardStartDate').value=s.toISOString().split('T')[0];document.getElementById('dashboardEndDate').value=e.toISOString().split('T')[0];updateDashboard()}function resetDashboardFilters(){document.getElementById('searchInput').value='';document.getElementById('dashboardStartDate').value='';document.getElementById('dashboardEndDate').value='';updateDashboard()}function clearForm(fId){document.getElementById(fId).querySelectorAll('input').forEach(i=>i.value='');if(fId==='checkout'){document.getElementById('card-container').innerHTML='';document.getElementById('headphoneIdsList').innerHTML='';checkoutListIds.clear();initializeSquare()}}function filterReport(d){const e=new Date(),s=new Date();s.setDate(e.getDate()-d);document.getElementById('reportStartDate').value=s.toISOString().split('T')[0];document.getElementById('reportEndDate').value=e.toISOString().split('T')[0];generateReport()}function resetFilters(){document.getElementById('reportStartDate').value='';document.getElementById('reportEndDate').value='';document.getElementById('reportSearch').value='';generateReport()}function handleDataStyleChange(){const s=document.getElementById('dataStyle').value;if(s==='csv')exportReport();else generateReport()}function generateReport(){const rt=document.getElementById('reportType').value,sd=document.getElementById('reportStartDate').value,ed=document.getElementById('reportEndDate').value||sd,st=document.getElementById('reportSearch').value.toLowerCase(),ds=document.getElementById('dataStyle').value,o=document.getElementById('reportOutput'),tc=document.getElementById('totalCheckedOut'),to=document.getElementById('totalOverdue');o.innerHTML='';if(!rt){o.innerHTML='<p>Select a report type to view details.</p>';return}const ha=Object.entries(headphones).map(([id,h])=>({id,...h})),n=Date.now(),th=12*60*60*1000;let f=ha;if(sd){const s=new Date(sd).setHours(0,0,0,0),e=new Date(ed).setHours(23,59,59,999);f=ha.filter(h=>new Date(h.agreement?.date).setHours(0,0,0,0)>=s&&new Date(h.agreement?.date).setHours(0,0,0,0)<=e)}let fa=f;if(st)fa=f.filter(h=>[h.id,h.nfcId||'',h.status,h.customer?.name||'',h.customer?.email||'',h.customer?.phone||'',h.agreement?.date||'',h.pre_auth?'Hold':'Released',h.entryMethod||'N/A',h.eventName||'',h.groupId||'Single'].some(d=>d.toLowerCase().includes(st)));tc.textContent=fa.filter(h=>h.status==='checked_out').length;to.textContent=fa.filter(h=>h.status==='checked_out'&&(n-h.agreement.timestamp>th)).length;let t='';if(ds==='table'){switch(rt){case'allData':t=`<h3>All Data (${fa.length} Headphones)</h3><p>Date Range: ${sd||'All'} to ${ed||'All'}</p><table><thead><tr><th>ID</th><th>NFC ID</th><th>Status</th><th>Customer</th><th>Email</th><th>Phone</th><th>Checkout Date</th><th>Event</th><th>Group ID</th></tr></thead><tbody>${fa.map(h=>`<tr><td>${h.id}</td><td>${h.nfcId||'N/A'}</td><td>${h.status==='checked_out'?'Checked Out':h.status==='returned'?'Returned':'Charged'}</td><td>${h.customer?.name||'N/A'}</td><td>${h.customer?.email||'N/A'}</td><td>${h.customer?.phone||'N/A'}</td><td>${h.agreement?.date||'N/A'}</td><td>${h.eventName||'N/A'}</td><td>${h.groupId||'Single'}</td></tr>`).join('')}</tbody></table>`;break;case'checkedOut':const co=fa.filter(h=>h.status==='checked_out');t=`<h3>Currently Checked Out (${co.length})</h3><p>Date Range: ${sd||'All'} to ${ed||'All'}</p><table><thead><tr><th>ID</th><th>NFC ID</th><th>Customer</th><th>Email</th><th>Phone</th><th>Checkout Date</th><th>Event</th><th>Group ID</th></tr></thead><tbody>${co.map(h=>`<tr><td>${h.id}</td><td>${h.nfcId||'N/A'}</td><td>${h.customer.name}</td><td>${h.customer.email}</td><td>${h.customer.phone}</td><td>${h.agreement.date}</td><td>${h.eventName||'N/A'}</td><td>${h.groupId||'Single'}</td></tr>`).join('')}</tbody></table>`;break;case'overdue':const ov=fa.filter(h=>h.status==='checked_out'&&(n-h.agreement.timestamp>th));t=`<h3>Overdue Headphones (${ov.length})</h3><p>Date Range: ${sd||'All'} to ${ed||'All'}</p><table><thead><tr><th>ID</th><th>NFC ID</th><th>Customer</th><th>Email</th><th>Phone</th><th>Checkout Date</th><th>Days Overdue</th><th>Event</th><th>Group ID</th></tr></thead><tbody>${ov.map(h=>`<tr><td>${h.id}</td><td>${h.nfcId||'N/A'}</td><td>${h.customer.name}</td><td>${h.customer.email}</td><td>${h.customer.phone}</td><td>${h.agreement.date}</td><td>${Math.floor((n-h.agreement.timestamp)/(1000*60*60*24))}</td><td>${h.eventName||'N/A'}</td><td>${h.groupId||'Single'}</td></tr>`).join('')}</tbody></table>`;break;case'revenue':const ch=fa.filter(h=>h.status==='charged');t=`<h3>Revenue Summary</h3><p>Date Range: ${sd||'All'} to ${ed||'All'}</p><p>Total Revenue: $${(ch.length*100).toFixed(2)}</p><table><thead><tr><th>ID</th><th>NFC ID</th><th>Customer</th><th>Email</th><th>Phone</th><th>Charge Date</th><th>Amount</th><th>Event</th><th>Group ID</th></tr></thead><tbody>${ch.map(h=>`<tr><td>${h.id}</td><td>${h.nfcId||'N/A'}</td><td>${h.customer.name}</td><td>${h.customer.email}</td><td>${h.customer.phone}</td><td>${h.agreement.date}</td><td>$100.00</td><td>${h.eventName||'N/A'}</td><td>${h.groupId||'Single'}</td></tr>`).join('')}</tbody></table>`;break;case'customerActivity':const cu={};fa.forEach(h=>{const k=`${h.customer.name}|${h.customer.email}|${h.customer.phone}`;if(!cu[k])cu[k]={name:h.customer.name,email:h.customer.email,phone:h.customer.phone,checkouts:0,headphones:[]};cu[k].checkouts++;cu[k].headphones.push(h.id)});t=`<h3>Customer Activity</h3><p>Date Range: ${sd||'All'} to ${ed||'All'}</p><table><thead><tr><th>Name</th><th>Email</th><th>Phone</th><th>Total Checkouts</th><th>Headphone IDs</th></tr></thead><tbody>${Object.values(cu).map(c=>`<tr><td>${c.name}</td><td>${c.email}</td><td>${c.phone}</td><td>${c.checkouts}</td><td>${c.headphones.join(', ')}</td></tr>`).join('')}</tbody></table>`;break;case'groupSummary':const gr={};fa.forEach(h=>{if(h.groupId){if(!gr[h.groupId])gr[h.groupId]={ids:[],customer:h.customer,total:0,checkedOut:0,returned:0,charged:0};gr[h.groupId].ids.push(h.id);gr[h.groupId].total++;if(h.status==='checked_out')gr[h.groupId].checkedOut++;if(h.status==='returned')gr[h.groupId].returned++;if(h.status==='charged')gr[h.groupId].charged++}});t=`<h3>Group Checkout Summary</h3><p>Date Range: ${sd||'All'} to ${ed||'All'}</p><table><thead><tr><th>Group ID</th><th>Customer</th><th>Email</th><th>Total Headphones</th><th>Checked Out</th><th>Returned</th><th>Charged</th><th>Event</th><th>Headphone IDs</th></tr></thead><tbody>${Object.entries(gr).map(([id,g])=>`<tr><td>${id}</td><td>${g.customer.name}</td><td>${g.customer.email}</td><td>${g.total}</td><td>${g.checkedOut}</td><td>${g.returned}</td><td>${g.charged}</td><td>${fa.find(h=>h.groupId===id)?.eventName||'N/A'}</td><td>${g.ids.join(', ')}</td></tr>`).join('')}</tbody></table>`;break;case'nfcUsage':const ns={};fa.forEach(h=>{if(h.nfcId){if(!ns[h.nfcId])ns[h.nfcId]={uses:0,headphonesIds:[],dates:[]};ns[h.nfcId].uses++;ns[h.nfcId].headphonesIds.push(h.id);ns[h.nfcId].dates.push(h.agreement.date)}});t=`<h3>NFC Usage Statistics</h3><p>Date Range: ${sd||'All'} to ${ed||'All'}</p><table><thead><tr><th>NFC ID</th><th>Total Uses</th><th>Headphone IDs</th><th>Dates Used</th></tr></thead><tbody>${Object.entries(ns).map(([id,s])=>`<tr><td>${id}</td><td>${s.uses}</td><td>${s.headphonesIds.join(', ')}</td><td>${s.dates.join(', ')}</td></tr>`).join('')}</tbody></table>`;break;case'dailyCheckouts':const dd={};fa.filter(h=>h.status==='checked_out').forEach(h=>{const d=h.agreement.date;dd[d]=dd[d]?dd[d]+1:1});const da=Object.keys(dd).sort(),co=da.map(d=>dd[d]);t=`<h3>Daily Checkouts</h3><p>Date Range: ${sd||'All'} to ${ed||'All'}</p><canvas id="reportChart"></canvas>`;o.innerHTML=t;renderChart('reportChart','bar',da,co,'Daily Checkouts');return;case'statusDistribution':const sd={checked_out:0,returned:0,charged:0};fa.forEach(h=>sd[h.status]++);const la=['Checked Out','Returned','Charged'],va=[sd.checked_out,sd.returned,sd.charged];t=`<h3>Status Distribution</h3><p>Date Range: ${sd||'All'} to ${ed||'All'}</p><canvas id="reportChart"></canvas>`;o.innerHTML=t;renderChart('reportChart','pie',la,va,'Headphone Status');return;default:t='<p>Invalid report type.</p>'}}else if(ds!=='csv'){switch(rt){case'dailyCheckouts':const dd={};fa.filter(h=>h.status==='checked_out').forEach(h=>{const d=h.agreement.date;dd[d]=dd[d]?dd[d]+1:1});const da=Object.keys(dd).sort(),co=da.map(d=>dd[d]);t=`<h3>Daily Checkouts</h3><p>Date Range: ${sd||'All'} to ${ed||'All'}</p><canvas id="reportChart"></canvas>`;o.innerHTML=t;renderChart('reportChart',ds,da,co,'Daily Checkouts');break;case'statusDistribution':const sd={checked_out:0,returned:0,charged:0};fa.forEach(h=>sd[h.status]++);const la=['Checked Out','Returned','Charged'],va=[sd.checked_out,sd.returned,sd.charged];t=`<h3>Status Distribution</h3><p>Date Range: ${sd||'All'} to ${ed||'All'}</p><canvas id="reportChart"></canvas>`;o.innerHTML=t;renderChart('reportChart',ds,la,va,'Headphone Status');break;default:t='<p>Chart not available for this report type.</p>'}}o.innerHTML=t;}function renderChart(cId,t,l,d,ti){if(chartInstance)chartInstance.destroy();const ctx=document.getElementById(cId).getContext('2d');const c={type:t,data:{labels:l,datasets:[{label:ti,data:d,backgroundColor:t==='pie'?['#8A63FF','#28A745','#FFC107']:'#8A63FF',borderColor:t==='line'?'#8A63FF':'#EDEDED',borderWidth:1,fill:t==='line'?false:undefined}]},options:{responsive:true,maintainAspectRatio:false,scales:t!=='pie'?{y:{beginAtZero:true,title:{display:true,text:'Count',color:'#EDEDED'}},x:{title:{display:true,text:'Date',color:'#EDEDED'}}}:undefined,plugins:{legend:{display:t==='pie',position:'top',labels:{color:'#EDEDED'}}}}};chartInstance=new Chart(ctx,c);}function exportReport(){const rt=document.getElementById('reportType').value,sd=document.getElementById('reportStartDate').value,ed=document.getElementById('reportEndDate').value||sd;if(!rt)return alert('Select a report type first!');let f=Object.entries(headphones).map(([id,h])=>({id,...h}));if(sd){const s=new Date(sd).setHours(0,0,0,0),e=new Date(ed).setHours(23,59,59,999);f=f.filter(h=>new Date(h.agreement?.date).setHours(0,0,0,0)>=s&&new Date(h.agreement?.date).setHours(0,0,0,0)<=e)}const n=Date.now(),th=12*60*60*1000;let c='';switch(rt){case'allData':c='"ID","NFC ID","Status","Customer","Email","Phone","Checkout Date","Event","Group ID"\n'+f.map(h=>`"${h.id}","${h.nfcId||'N/A'}","${h.status==='checked_out'?'Checked Out':h.status==='returned'?'Returned':'Charged'}","${h.customer?.name||'N/A'}","${h.customer?.email||'N/A'}","${h.customer?.phone||'N/A'}","${h.agreement?.date||'N/A'}","${h.eventName||'N/A'}","${h.groupId||'Single'}"`).join('\n');break;case'checkedOut':c='"ID","NFC ID","Customer","Email","Phone","Checkout Date","Event","Group ID"\n'+f.filter(h=>h.status==='checked_out').map(h=>`"${h.id}","${h.nfcId||'N/A'}","${h.customer.name}","${h.customer.email}","${h.customer.phone}","${h.agreement.date}","${h.eventName||'N/A'}","${h.groupId||'Single'}"`).join('\n');break;case'overdue':c='"ID","NFC ID","Customer","Email","Phone","Checkout Date","Days Overdue","Event","Group ID"\n'+f.filter(h=>h.status==='checked_out'&&(n-h.agreement.timestamp>th)).map(h=>`"${h.id}","${h.nfcId||'N/A'}","${h.customer.name}","${h.customer.email}","${h.customer.phone}","${h.agreement.date}","${Math.floor((n-h.agreement.timestamp)/(1000*60*60*24))}","${h.eventName||'N/A'}","${h.groupId||'Single'}"`).join('\n');break;case'revenue':c='"ID","NFC ID","Customer","Email","Phone","Charge Date","Amount","Event","Group ID"\n'+f.filter(h=>h.status==='charged').map(h=>`"${h.id}","${h.nfcId||'N/A'}","${h.customer.name}","${h.customer.email}","${h.customer.phone}","${h.agreement.date}","$100.00","${h.eventName||'N/A'}","${h.groupId||'Single'}"`).join('\n');break;case'customerActivity':const cu={};f.forEach(h=>{const k=`${h.customer.name}|${h.customer.email}|${h.customer.phone}`;if(!cu[k])cu[k]={name:h.customer.name,email:h.customer.email,phone:h.customer.phone,checkouts:0,headphones:[]};cu[k].checkouts++;cu[k].headphones.push(h.id)});c='"Name","Email","Phone","Total Checkouts","Headphone IDs"\n'+Object.values(cu).map(cu=>`"${cu.name}","${cu.email}","${cu.phone}","${cu.checkouts}","${cu.headphones.join(', ')}"`).join('\n');break;case'groupSummary':const gr={};f.forEach(h=>{if(h.groupId){if(!gr[h.groupId])gr[h.groupId]={ids:[],customer:h.customer,total:0,checkedOut:0,returned:0,charged:0};gr[h.groupId].ids.push(h.id);gr[h.groupId].total++;if(h.status==='checked_out')gr[h.groupId].checkedOut++;if(h.status==='returned')gr[h.groupId].returned++;if(h.status==='charged')gr[h.groupId].charged++}});c='"Group ID","Customer","Email","Total Headphones","Checked Out","Returned","Charged","Event","Headphone IDs"\n'+Object.entries(gr).map(([id,g])=>`"${id}","${g.customer.name}","${g.customer.email}","${g.total}","${g.checkedOut}","${g.returned}","${g.charged}","${f.find(h=>h.groupId===id)?.eventName||'N/A'}","${g.ids.join(', ')}"`).join('\n');break;case'nfcUsage':const ns={};f.forEach(h=>{if(h.nfcId){if(!ns[h.nfcId])ns[h.nfcId]={uses:0,headphonesIds:[],dates:[]};ns[h.nfcId].uses++;ns[h.nfcId].headphonesIds.push(h.id);ns[h.nfcId].dates.push(h.agreement.date)}});c='"NFC ID","Total Uses","Headphone IDs","Dates Used"\n'+Object.entries(ns).map(([id,s])=>`"${id}","${s.uses}","${s.headphonesIds.join(', ')}","${s.dates.join(', ')}"`).join('\n');break;case'dailyCheckouts':const dd={};f.filter(h=>h.status==='checked_out').forEach(h=>{const d=h.agreement.date;dd[d]=dd[d]?dd[d]+1:1});c='"Date","Checkouts"\n'+Object.entries(dd).map(([d,c])=>`"${d}","${c}"`).join('\n');break;case'statusDistribution':const sd={checked_out:0,returned:0,charged:0};f.forEach(h=>sd[h.status]++);c='"Status","Count"\n'+Object.entries(sd).map(([s,c])=>`"${s==='checked_out'?'Checked Out':s==='returned'?'Returned':'Charged'}","${c}"`).join('\n');break}const b=new Blob([c],{type:'text/csv;charset=utf-8;'}),l=document.createElement('a');l.href=URL.createObjectURL(b);l.download=`${rt}_report_${sd||'all'}_${ed||'all'}.csv`;document.body.appendChild(l);l.click();document.body.removeChild(l)}function makeDraggable(dId,hId){const d=document.getElementById(dId),h=document.getElementById(hId);let i=false,cx=d.offsetLeft,cy=d.offsetTop,ix,iy;function s(e){i=true;ix=(e.type==='mousedown'?e.clientX:e.touches[0].clientX)-cx;iy=(e.type==='mousedown'?e.clientY:e.touches[0].clientY)-cy;h.style.cursor='grabbing'}function dr(e){if(!i)return;e.preventDefault();cx=(e.type==='mousemove'?e.clientX:e.touches[0].clientX)-ix;cy=(e.type==='mousemove'?e.clientY:e.touches[0].clientY)-iy;d.style.left=`${cx}px`;d.style.top=`${cy}px`;d.style.transform='none'}function st(){i=false;h.style.cursor='move'}h.addEventListener('mousedown',s);document.addEventListener('mousemove',dr);document.addEventListener('mouseup',st);h.addEventListener('touchstart',s);document.addEventListener('touchmove',dr);document.addEventListener('touchend',st)}function runTests(){console.log('Running unit tests...');try{const i1=generateUniqueHeadphoneId(),i2=generateUniqueHeadphoneId();if(/^HP\d{7}$/.test(i1)&&i1!==i2)console.log('Test Passed: generateUniqueHeadphoneId');else console.error('Test Failed: generateUniqueHeadphoneId')}catch(e){console.error('Test Error: generateUniqueHeadphoneId:',e)}try{document.getElementById('headphoneIdsList').innerHTML='<li>HP0000001</li>';document.getElementById('name').value='Test User';document.getElementById('email').value='test@example.com';document.getElementById('phone').value='1234567890';document.getElementById('eventName').value='Test Event';signatureData='data:image/png;base64,test';console.log('Test Passed: processPayment setup')}catch(e){console.error('Test Error: processPayment:',e)}}</script></body></html>
